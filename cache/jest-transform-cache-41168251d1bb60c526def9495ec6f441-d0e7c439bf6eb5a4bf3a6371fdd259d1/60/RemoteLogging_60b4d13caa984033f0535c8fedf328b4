4a5cc5802f78a4de5d6f5e9d6a747221
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.__waitForEmptyLogQueueAsync = __waitForEmptyLogQueueAsync;
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _expoConstants = _interopRequireDefault(require("expo-constants"));

var _fbemitter = require("fbemitter");

var _invariant = _interopRequireDefault(require("invariant"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _LogSerialization = _interopRequireDefault(require("./LogSerialization"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var _sessionId = _uuidJs.default.create().toString();

var _logQueue = [];

var _transportEventEmitter = new _fbemitter.EventEmitter();

var _logCounter = 0;
var _isSendingLogs = false;
var _completionPromise = null;
var _resolveCompletion2 = null;

function enqueueRemoteLogAsync(level, additionalFields, data) {
  var warning, lines, _ref, body, includesStack;

  return _regenerator.default.async(function enqueueRemoteLogAsync$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          if (!_isReactNativeWarning(data)) {
            _context.next = 8;
            break;
          }

          if (!(data.length === 0)) {
            _context.next = 3;
            break;
          }

          throw new Error("Warnings must include log arguments");

        case 3:
          warning = data[0];

          if (!(typeof warning !== 'string')) {
            _context.next = 6;
            break;
          }

          throw new TypeError("The log argument for a warning must be a string");

        case 6:
          lines = warning.split('\n');

          if (lines.length > 1 && /^\s+in /.test(lines[1])) {
            data[0] = lines[0];
          }

        case 8:
          _context.next = 10;
          return _regenerator.default.awrap(_LogSerialization.default.serializeLogDataAsync(data, level));

        case 10:
          _ref = _context.sent;
          body = _ref.body;
          includesStack = _ref.includesStack;

          _logQueue.push(_objectSpread({
            count: _logCounter++,
            level: level,
            body: body,
            includesStack: includesStack
          }, additionalFields));

          _sendRemoteLogsAsync().catch(function (error) {
            setImmediate(function () {
              throw error;
            });
          });

        case 15:
        case "end":
          return _context.stop();
      }
    }
  });
}

function _sendRemoteLogsAsync() {
  var batch, logUrl;
  return _regenerator.default.async(function _sendRemoteLogsAsync$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          if (!(_isSendingLogs || !_logQueue.length)) {
            _context2.next = 2;
            break;
          }

          return _context2.abrupt("return");

        case 2:
          batch = _logQueue.splice(0);
          logUrl = _expoConstants.default.manifest.logUrl;

          if (!(typeof logUrl !== 'string')) {
            _context2.next = 6;
            break;
          }

          throw new Error('The Expo project manifest must specify `logUrl`');

        case 6:
          _isSendingLogs = true;
          _context2.prev = 7;
          _context2.next = 10;
          return _regenerator.default.awrap(_sendNextLogBatchAsync(batch, logUrl));

        case 10:
          _context2.prev = 10;
          _isSendingLogs = false;
          return _context2.finish(10);

        case 13:
          if (!_logQueue.length) {
            _context2.next = 17;
            break;
          }

          return _context2.abrupt("return", _sendRemoteLogsAsync());

        case 17:
          if (_resolveCompletion2) {
            _resolveCompletion2();
          }

        case 18:
        case "end":
          return _context2.stop();
      }
    }
  }, null, null, [[7,, 10, 13]]);
}

function _sendNextLogBatchAsync(batch, logUrl) {
  var response, headers, success;
  return _regenerator.default.async(function _sendNextLogBatchAsync$(_context3) {
    while (1) {
      switch (_context3.prev = _context3.next) {
        case 0:
          headers = {
            'Content-Type': 'application/json',
            Connection: 'keep-alive',
            'Proxy-Connection': 'keep-alive',
            Accept: 'application/json',
            'Device-Id': _expoConstants.default.installationId,
            'Session-Id': _sessionId
          };

          if (_expoConstants.default.deviceName) {
            headers['Device-Name'] = _expoConstants.default.deviceName;
          }

          _context3.prev = 2;
          _context3.next = 5;
          return _regenerator.default.awrap(fetch(logUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(batch)
          }));

        case 5:
          response = _context3.sent;
          _context3.next = 12;
          break;

        case 8:
          _context3.prev = 8;
          _context3.t0 = _context3["catch"](2);

          _transportEventEmitter.emit('error', {
            error: _context3.t0
          });

          return _context3.abrupt("return");

        case 12:
          success = response.status >= 200 && response.status < 300;

          if (!success) {
            _transportEventEmitter.emit('error', {
              error: new Error("An HTTP error occurred when sending remote logs"),
              response: response
            });
          }

        case 14:
        case "end":
          return _context3.stop();
      }
    }
  }, null, null, [[2, 8]]);
}

function addTransportErrorListener(listener) {
  return _transportEventEmitter.addListener('error', listener);
}

function _isReactNativeWarning(data) {
  var message = data[0];
  return data.length === 1 && typeof message === 'string' && message.startsWith('Warning: ');
}

var _default = {
  enqueueRemoteLogAsync: enqueueRemoteLogAsync,
  addTransportErrorListener: addTransportErrorListener
};
exports.default = _default;

function __waitForEmptyLogQueueAsync() {
  if (_completionPromise) {
    return _completionPromise;
  }

  if (!_isSendingLogs && !_logQueue.length) {
    return Promise.resolve();
  }

  _completionPromise = new Promise(function (resolve) {
    _resolveCompletion2 = function _resolveCompletion() {
      (0, _invariant.default)(!_isSendingLogs, "Must not be sending logs at completion");
      (0, _invariant.default)(!_logQueue.length, "Log queue must be empty at completion");
      _completionPromise = null;
      _resolveCompletion2 = null;
      resolve();
    };
  });
  return _completionPromise;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sb2dzL1JlbW90ZUxvZ2dpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7OztBQXVCQSxJQUFNLFVBQVUsR0FBRyxnQkFBSyxNQUFMLEdBQWMsUUFBZCxFQUFuQjs7QUFDQSxJQUFNLFNBQVMsR0FBZSxFQUE5Qjs7QUFDQSxJQUFNLHNCQUFzQixHQUFHLElBQUksdUJBQUosRUFBL0I7O0FBRUEsSUFBSSxXQUFXLEdBQUcsQ0FBbEI7QUFDQSxJQUFJLGNBQWMsR0FBRyxLQUFyQjtBQUNBLElBQUksa0JBQWtCLEdBQXlCLElBQS9DO0FBQ0EsSUFBSSxtQkFBa0IsR0FBd0IsSUFBOUM7O0FBRUEsU0FBZSxxQkFBZixDQUNFLEtBREYsRUFFRSxnQkFGRixFQUdFLElBSEY7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLGVBS00scUJBQXFCLENBQUMsSUFBRCxDQUwzQjtBQUFBO0FBQUE7QUFBQTs7QUFBQSxnQkFPUSxJQUFJLENBQUMsTUFBTCxLQUFnQixDQVB4QjtBQUFBO0FBQUE7QUFBQTs7QUFBQSxnQkFRWSxJQUFJLEtBQUosdUNBUlo7O0FBQUE7QUFVVSxVQUFBLE9BVlYsR0FVb0IsSUFBSSxDQUFDLENBQUQsQ0FWeEI7O0FBQUEsZ0JBV1EsT0FBTyxPQUFQLEtBQW1CLFFBWDNCO0FBQUE7QUFBQTtBQUFBOztBQUFBLGdCQVlZLElBQUksU0FBSixtREFaWjs7QUFBQTtBQWNVLFVBQUEsS0FkVixHQWNrQixPQUFPLENBQUMsS0FBUixDQUFjLElBQWQsQ0FkbEI7O0FBZUksY0FBSSxLQUFLLENBQUMsTUFBTixHQUFlLENBQWYsSUFBb0IsVUFBVSxJQUFWLENBQWUsS0FBSyxDQUFDLENBQUQsQ0FBcEIsQ0FBeEIsRUFBa0Q7QUFDaEQsWUFBQSxJQUFJLENBQUMsQ0FBRCxDQUFKLEdBQVUsS0FBSyxDQUFDLENBQUQsQ0FBZjtBQUNEOztBQWpCTDtB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b25zdGFudHMnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBFdmVudFN1YnNjcmlwdGlvbiB9IGZyb20gJ2ZiZW1pdHRlcic7XG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2ludmFyaWFudCc7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcblxuaW1wb3J0IExvZ1NlcmlhbGl6YXRpb24gZnJvbSAnLi9Mb2dTZXJpYWxpemF0aW9uJztcblxuZXhwb3J0IHR5cGUgTG9nTGV2ZWwgPSAnZGVidWcnIHwgJ2luZm8nIHwgJ3dhcm4nIHwgJ2Vycm9yJztcblxudHlwZSBMb2dFbnRyeSA9IHtcbiAgY291bnQ6IG51bWJlcjtcbiAgbGV2ZWw6IExvZ0xldmVsO1xuICBib2R5OiBMb2dEYXRhW107XG4gIGluY2x1ZGVzU3RhY2s6IGJvb2xlYW47XG4gIGdyb3VwRGVwdGg/OiBudW1iZXI7XG59ICYgTG9nRW50cnlGaWVsZHM7XG5cbmV4cG9ydCB0eXBlIExvZ0VudHJ5RmllbGRzID0ge1xuICBzaG91bGRIaWRlPzogYm9vbGVhbjtcbiAgZ3JvdXBEZXB0aD86IG51bWJlcjtcbiAgZ3JvdXBDb2xsYXBzZWQ/OiBib29sZWFuO1xufTtcblxuZXhwb3J0IHR5cGUgTG9nRGF0YSA9IHN0cmluZyB8IExvZ0Vycm9yRGF0YTtcbmV4cG9ydCB0eXBlIExvZ0Vycm9yRGF0YSA9IHsgbWVzc2FnZTogc3RyaW5nOyBzdGFjazogc3RyaW5nIH07XG5cbnR5cGUgVHJhbnNwb3J0RXJyb3JMaXN0ZW5lciA9IChldmVudDogeyBlcnJvcjogRXJyb3I7IHJlc3BvbnNlPzogUmVzcG9uc2UgfSkgPT4gdm9pZDtcblxuY29uc3QgX3Nlc3Npb25JZCA9IFVVSUQuY3JlYXRlKCkudG9TdHJpbmcoKTtcbmNvbnN0IF9sb2dRdWV1ZTogTG9nRW50cnlbXSA9IFtdO1xuY29uc3QgX3RyYW5zcG9ydEV2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxubGV0IF9sb2dDb3VudGVyID0gMDtcbmxldCBfaXNTZW5kaW5nTG9ncyA9IGZhbHNlO1xubGV0IF9jb21wbGV0aW9uUHJvbWlzZTogUHJvbWlzZTx2b2lkPiB8IG51bGwgPSBudWxsO1xubGV0IF9yZXNvbHZlQ29tcGxldGlvbjogKCgpID0+IHZvaWQpIHwgbnVsbCA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGVucXVldWVSZW1vdGVMb2dBc3luYyhcbiAgbGV2ZWw6IExvZ0xldmVsLFxuICBhZGRpdGlvbmFsRmllbGRzOiBMb2dFbnRyeUZpZWxkcyxcbiAgZGF0YTogdW5rbm93bltdXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKF9pc1JlYWN0TmF0aXZlV2FybmluZyhkYXRhKSkge1xuICAgIC8vIFJlbW92ZSB0aGUgc3RhY2sgdHJhY2UgZnJvbSB0aGUgd2FybmluZyBtZXNzYWdlIHNpbmNlIHdlJ2xsIGNhcHR1cmUgb3VyIG93blxuICAgIGlmIChkYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBXYXJuaW5ncyBtdXN0IGluY2x1ZGUgbG9nIGFyZ3VtZW50c2ApO1xuICAgIH1cbiAgICBjb25zdCB3YXJuaW5nID0gZGF0YVswXTtcbiAgICBpZiAodHlwZW9mIHdhcm5pbmcgIT09ICdzdHJpbmcnKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGBUaGUgbG9nIGFyZ3VtZW50IGZvciBhIHdhcm5pbmcgbXVzdCBiZSBhIHN0cmluZ2ApO1xuICAgIH1cbiAgICBjb25zdCBsaW5lcyA9IHdhcm5pbmcuc3BsaXQoJ1xcbicpO1xuICAgIGlmIChsaW5lcy5sZW5ndGggPiAxICYmIC9eXFxzK2luIC8udGVzdChsaW5lc1sxXSkpIHtcbiAgICAgIGRhdGFbMF0gPSBsaW5lc1swXTtcbiAgICB9XG4gIH1cblxuICBsZXQgeyBib2R5LCBpbmNsdWRlc1N0YWNrIH0gPSBhd2FpdCBMb2dTZXJpYWxpemF0aW9uLnNlcmlhbGl6ZUxvZ0RhdGFBc3luYyhkYXRhLCBsZXZlbCk7XG5cbiAgX2xvZ1F1ZXVlLnB1c2goe1xuICAgIGNvdW50OiBfbG9nQ291bnRlcisrLFxuICAgIGxldmVsLFxuICAgIGJvZHksXG4gICAgaW5jbHVkZXNTdGFjayxcbiAgICAuLi5hZGRpdGlvbmFsRmllbGRzLFxuICB9KTtcblxuICAvLyBTZW5kIHRoZSBsb2dzIGFzeW5jaHJvbm91c2x5IChzeXN0ZW0gZXJyb3JzIGFyZSBlbWl0dGVkIHdpdGggdHJhbnNwb3J0IGVycm9yIGV2ZW50cykgYW5kIHRocm93IGFuIHVuY2F1Z2h0IGVycm9yXG4gIF9zZW5kUmVtb3RlTG9nc0FzeW5jKCkuY2F0Y2goZXJyb3IgPT4ge1xuICAgIHNldEltbWVkaWF0ZSgoKSA9PiB7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIF9zZW5kUmVtb3RlTG9nc0FzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoX2lzU2VuZGluZ0xvZ3MgfHwgIV9sb2dRdWV1ZS5sZW5ndGgpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBPdXIgY3VycmVudCB0cmFuc3BvcnQgcG9saWN5IGlzIHRvIHNlbmQgYWxsIG9mIHRoZSBwZW5kaW5nIGxvZyBtZXNzYWdlcyBpbiBvbmUgYmF0Y2guIElmIHdlIG9wdFxuICAvLyBmb3IgYW5vdGhlciBwb2xpY3kgKGV4OiB0aHJvdHRsaW5nKSB0aGlzIGlzIHdoZXJlIHRvIHRvIGltcGxlbWVudCBpdC5cbiAgbGV0IGJhdGNoID0gX2xvZ1F1ZXVlLnNwbGljZSgwKTtcblxuICBsZXQgeyBsb2dVcmwgfSA9IENvbnN0YW50cy5tYW5pZmVzdDtcbiAgaWYgKHR5cGVvZiBsb2dVcmwgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgRXhwbyBwcm9qZWN0IG1hbmlmZXN0IG11c3Qgc3BlY2lmeSBgbG9nVXJsYCcpO1xuICB9XG5cbiAgX2lzU2VuZGluZ0xvZ3MgPSB0cnVlO1xuICB0cnkge1xuICAgIGF3YWl0IF9zZW5kTmV4dExvZ0JhdGNoQXN5bmMoYmF0Y2gsIGxvZ1VybCk7XG4gIH0gZmluYWxseSB7XG4gICAgX2lzU2VuZGluZ0xvZ3MgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChfbG9nUXVldWUubGVuZ3RoKSB7XG4gICAgcmV0dXJuIF9zZW5kUmVtb3RlTG9nc0FzeW5jKCk7XG4gIH0gZWxzZSBpZiAoX3Jlc29sdmVDb21wbGV0aW9uKSB7XG4gICAgX3Jlc29sdmVDb21wbGV0aW9uKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX3NlbmROZXh0TG9nQmF0Y2hBc3luYyhiYXRjaDogTG9nRW50cnlbXSwgbG9nVXJsOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgbGV0IHJlc3BvbnNlO1xuXG4gIGxldCBoZWFkZXJzID0ge1xuICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgQ29ubmVjdGlvbjogJ2tlZXAtYWxpdmUnLFxuICAgICdQcm94eS1Db25uZWN0aW9uJzogJ2tlZXAtYWxpdmUnLFxuICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICdEZXZpY2UtSWQnOiBDb25zdGFudHMuaW5zdGFsbGF0aW9uSWQsXG4gICAgJ1Nlc3Npb24tSWQnOiBfc2Vzc2lvbklkLFxuICB9O1xuICBpZiAoQ29uc3RhbnRzLmRldmljZU5hbWUpIHtcbiAgICBoZWFkZXJzWydEZXZpY2UtTmFtZSddID0gQ29uc3RhbnRzLmRldmljZU5hbWU7XG4gIH1cbiAgdHJ5IHtcbiAgICByZXNwb25zZSA9IGF3YWl0IGZldGNoKGxvZ1VybCwge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoYmF0Y2gpLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIF90cmFuc3BvcnRFdmVudEVtaXR0ZXIuZW1pdCgnZXJyb3InLCB7IGVycm9yIH0pO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCBzdWNjZXNzID0gcmVzcG9uc2Uuc3RhdHVzID49IDIwMCAmJiByZXNwb25zZS5zdGF0dXMgPCAzMDA7XG4gIGlmICghc3VjY2Vzcykge1xuICAgIF90cmFuc3BvcnRFdmVudEVtaXR0ZXIuZW1pdCgnZXJyb3InLCB7XG4gICAgICBlcnJvcjogbmV3IEVycm9yKGBBbiBIVFRQIGVycm9yIG9jY3VycmVkIHdoZW4gc2VuZGluZyByZW1vdGUgbG9nc2ApLFxuICAgICAgcmVzcG9uc2UsXG4gICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYWRkVHJhbnNwb3J0RXJyb3JMaXN0ZW5lcihsaXN0ZW5lcjogVHJhbnNwb3J0RXJyb3JMaXN0ZW5lcik6IEV2ZW50U3Vic2NyaXB0aW9uIHtcbiAgcmV0dXJuIF90cmFuc3BvcnRFdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoJ2Vycm9yJywgbGlzdGVuZXIpO1xufVxuXG5mdW5jdGlvbiBfaXNSZWFjdE5hdGl2ZVdhcm5pbmcoZGF0YTogdW5rbm93bltdKTogYm9vbGVhbiB7XG4gIC8vIE5PVEU6IFJOIGRvZXMgdGhlIHNhbWUgdGhpbmcgaW50ZXJuYWxseSBmb3IgWWVsbG93Qm94XG4gIGxldCBtZXNzYWdlID0gZGF0YVswXTtcbiAgcmV0dXJuIGRhdGEubGVuZ3RoID09PSAxICYmIHR5cGVvZiBtZXNzYWdlID09PSAnc3RyaW5nJyAmJiBtZXNzYWdlLnN0YXJ0c1dpdGgoJ1dhcm5pbmc6ICcpO1xufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGVucXVldWVSZW1vdGVMb2dBc3luYyxcbiAgYWRkVHJhbnNwb3J0RXJyb3JMaXN0ZW5lcixcbn07XG5cbi8qKlxuICogUmV0dXJucyBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB3aGVuIGFsbCBlbnRyaWVzIGluIHRoZSBsb2cgcXVldWUgaGF2ZSBiZWVuIHNlbnQuIFRoaXMgbWV0aG9kIGlzXG4gKiBpbnRlbmRlZCBmb3IgdGVzdGluZyBvbmx5LlxuICovXG5leHBvcnQgZnVuY3Rpb24gX193YWl0Rm9yRW1wdHlMb2dRdWV1ZUFzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuICBpZiAoX2NvbXBsZXRpb25Qcm9taXNlKSB7XG4gICAgcmV0dXJuIF9jb21wbGV0aW9uUHJvbWlzZTtcbiAgfVxuXG4gIGlmICghX2lzU2VuZGluZ0xvZ3MgJiYgIV9sb2dRdWV1ZS5sZW5ndGgpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gIH1cblxuICBfY29tcGxldGlvblByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICBfcmVzb2x2ZUNvbXBsZXRpb24gPSAoKSA9PiB7XG4gICAgICBpbnZhcmlhbnQoIV9pc1NlbmRpbmdMb2dzLCBgTXVzdCBub3QgYmUgc2VuZGluZyBsb2dzIGF0IGNvbXBsZXRpb25gKTtcbiAgICAgIGludmFyaWFudCghX2xvZ1F1ZXVlLmxlbmd0aCwgYExvZyBxdWV1ZSBtdXN0IGJlIGVtcHR5IGF0IGNvbXBsZXRpb25gKTtcblxuICAgICAgX2NvbXBsZXRpb25Qcm9taXNlID0gbnVsbDtcbiAgICAgIF9yZXNvbHZlQ29tcGxldGlvbiA9IG51bGw7XG5cbiAgICAgIHJlc29sdmUoKTtcbiAgICB9O1xuICB9KTtcbiAgcmV0dXJuIF9jb21wbGV0aW9uUHJvbWlzZTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=
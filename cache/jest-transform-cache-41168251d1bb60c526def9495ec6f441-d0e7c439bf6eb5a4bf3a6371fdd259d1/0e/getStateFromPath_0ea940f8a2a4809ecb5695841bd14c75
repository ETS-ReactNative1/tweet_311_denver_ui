52dd26429aa7bef11c2f9e7a01afc16a
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/toConsumableArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = getStateFromPath;

var _escapeStringRegexp = _interopRequireDefault(require("escape-string-regexp"));

var _queryString = _interopRequireDefault(require("query-string"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

function getStateFromPath(path) {
  var _ref;

  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  if (path === '') {
    return undefined;
  }

  var initialRoutes = [];

  var configs = (_ref = []).concat.apply(_ref, (0, _toConsumableArray2.default)(Object.keys(options).map(function (key) {
    return createNormalizedConfigs(key, options, [], initialRoutes);
  })));

  var result;
  var current;
  var remaining = path.replace(/[/]+/, '/').replace(/^\//, '').replace(/\?.*/, '');

  while (remaining) {
    var routeNames = void 0;
    var params = void 0;

    var _loop = function _loop(config) {
      var match = remaining.match(config.match);

      if (match) {
        routeNames = (0, _toConsumableArray2.default)(config.routeNames);
        var paramPatterns = config.pattern.split('/').filter(function (p) {
          return p.startsWith(':');
        });

        if (paramPatterns.length) {
          params = paramPatterns.reduce(function (acc, p, i) {
            var key = p.replace(/^:/, '');
            var value = match[i + 1];
            acc[key] = config.parse && config.parse[key] ? config.parse[key](value) : value;
            return acc;
          }, {});
        }

        remaining = remaining.replace(match[0], '');
        return "break";
      }
    };

    for (var _iterator = configs, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[typeof Symbol === "function" ? Symbol.iterator : "@@iterator"]();;) {
      var _ref2;

      if (_isArray) {
        if (_i >= _iterator.length) break;
        _ref2 = _iterator[_i++];
      } else {
        _i = _iterator.next();
        if (_i.done) break;
        _ref2 = _i.value;
      }

      var config = _ref2;

      var _ret = _loop(config);

      if (_ret === "break") break;
    }

    if (routeNames === undefined) {
      var segments = remaining.split('/');
      routeNames = [decodeURIComponent(segments[0])];
      segments.shift();
      remaining = segments.join('/');
    }

    var state = void 0;
    var routeName = routeNames.shift();
    var initialRoute = findInitialRoute(routeName, initialRoutes);
    state = createNestedState(initialRoute, routeName, routeNames.length === 0, params);

    if (routeNames.length > 0) {
      var nestedState = state;

      while (routeName = routeNames.shift()) {
        initialRoute = findInitialRoute(routeName, initialRoutes);
        nestedState.routes[nestedState.index || 0].state = createNestedState(initialRoute, routeName, routeNames.length === 0, params);

        if (routeNames.length > 0) {
          nestedState = nestedState.routes[nestedState.index || 0].state;
        }
      }
    }

    if (current) {
      var _current2;

      while ((_current = current) === null || _current === void 0 ? void 0 : _current.routes[current.index || 0].state) {
        var _current;

        current = current.routes[current.index || 0].state;
      }

      current.routes[((_current2 = current) === null || _current2 === void 0 ? void 0 : _current2.index) || 0].state = state;
    } else {
      result = state;
    }

    current = state;
  }

  if (current == null || result == null) {
    return undefined;
  }

  var query = path.split('?')[1];

  if (query) {
    var _current4;

    while ((_current3 = current) === null || _current3 === void 0 ? void 0 : _current3.routes[current.index || 0].state) {
      var _current3;

      current = current.routes[current.index || 0].state;
    }

    var route = current.routes[((_current4 = current) === null || _current4 === void 0 ? void 0 : _current4.index) || 0];

    var _params = _queryString.default.parse(query);

    var parseFunction = findParseConfigForRoute(route.name, configs);

    if (parseFunction) {
      Object.keys(_params).forEach(function (name) {
        if (parseFunction[name] && typeof _params[name] === 'string') {
          _params[name] = parseFunction[name](_params[name]);
        }
      });
    }

    route.params = _objectSpread({}, route.params, {}, _params);
  }

  return result;
}

function createNormalizedConfigs(key, routeConfig) {
  var routeNames = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
  var initials = arguments.length > 3 ? arguments[3] : undefined;
  var configs = [];
  routeNames.push(key);
  var value = routeConfig[key];

  if (typeof value === 'string') {
    if (value !== '') {
      configs.push(createConfigItem(routeNames, value));
    }
  } else if (typeof value === 'object') {
    if (value.path && value.path !== '') {
      configs.push(createConfigItem(routeNames, value.path, value.parse));
    }

    if (value.screens) {
      if (value.initialRouteName) {
        initials.push({
          initialRouteName: value.initialRouteName,
          connectedRoutes: Object.keys(value.screens)
        });
      }

      Object.keys(value.screens).forEach(function (nestedConfig) {
        var result = createNormalizedConfigs(nestedConfig, value.screens, routeNames, initials);
        configs.push.apply(configs, (0, _toConsumableArray2.default)(result));
      });
    }
  }

  routeNames.pop();
  return configs;
}

function createConfigItem(routeNames, pattern, parse) {
  var match = new RegExp('^' + (0, _escapeStringRegexp.default)(pattern).replace(/:[a-z0-9]+/gi, '([^/]+)') + '/?');
  return {
    match: match,
    pattern: pattern,
    routeNames: (0, _toConsumableArray2.default)(routeNames),
    parse: parse
  };
}

function findParseConfigForRoute(routeName, flatConfig) {
  for (var _iterator2 = flatConfig, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[typeof Symbol === "function" ? Symbol.iterator : "@@iterator"]();;) {
    var _ref3;

    if (_isArray2) {
      if (_i2 >= _iterator2.length) break;
      _ref3 = _iterator2[_i2++];
    } else {
      _i2 = _iterator2.next();
      if (_i2.done) break;
      _ref3 = _i2.value;
    }

    var _config = _ref3;

    if (routeName === _config.routeNames[_config.routeNames.length - 1]) {
      return _config.parse;
    }
  }

  return undefined;
}

function findInitialRoute(routeName, initialRoutes) {
  for (var _iterator3 = initialRoutes, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[typeof Symbol === "function" ? Symbol.iterator : "@@iterator"]();;) {
    var _ref4;

    if (_isArray3) {
      if (_i3 >= _iterator3.length) break;
      _ref4 = _iterator3[_i3++];
    } else {
      _i3 = _iterator3.next();
      if (_i3.done) break;
      _ref4 = _i3.value;
    }

    var _config2 = _ref4;

    if (_config2.connectedRoutes.includes(routeName)) {
      return _config2.initialRouteName === routeName ? undefined : _config2.initialRouteName;
    }
  }

  return undefined;
}

function createNestedState(initialRoute, routeName, isEmpty, params) {
  if (isEmpty) {
    if (initialRoute) {
      return {
        index: 1,
        routes: [{
          name: initialRoute
        }, _objectSpread({
          name: routeName
        }, params && {
          params: params
        })]
      };
    } else {
      return {
        routes: [_objectSpread({
          name: routeName
        }, params && {
          params: params
        })]
      };
    }
  } else {
    if (initialRoute) {
      return {
        index: 1,
        routes: [{
          name: initialRoute
        }, {
          name: routeName,
          state: {
            routes: []
          }
        }]
      };
    } else {
      return {
        routes: [{
          name: routeName,
          state: {
            routes: []
          }
        }]
      };
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldFN0YXRlRnJvbVBhdGgudHN4Il0sIm5hbWVzIjpbIm9wdGlvbnMiLCJwYXRoIiwiaW5pdGlhbFJvdXRlcyIsImNvbmZpZ3MiLCJPYmplY3QiLCJrZXkiLCJjcmVhdGVOb3JtYWxpemVkQ29uZmlncyIsInJlbWFpbmluZyIsInJvdXRlTmFtZXMiLCJwYXJhbXMiLCJtYXRjaCIsImNvbmZpZyIsInBhcmFtUGF0dGVybnMiLCJwIiwidmFsdWUiLCJpIiwiYWNjIiwic2VnbWVudHMiLCJkZWNvZGVVUklDb21wb25lbnQiLCJzdGF0ZSIsInJvdXRlTmFtZSIsImluaXRpYWxSb3V0ZSIsImZpbmRJbml0aWFsUm91dGUiLCJjcmVhdGVOZXN0ZWRTdGF0ZSIsIm5lc3RlZFN0YXRlIiwiY3VycmVudCIsInJlc3VsdCIsInF1ZXJ5Iiwicm91dGUiLCJxdWVyeVN0cmluZyIsInBhcnNlRnVuY3Rpb24iLCJmaW5kUGFyc2VDb25maWdGb3JSb3V0ZSIsIm5hbWUiLCJpbml0aWFscyIsInJvdXRlQ29uZmlnIiwiY3JlYXRlQ29uZmlnSXRlbSIsImluaXRpYWxSb3V0ZU5hbWUiLCJjb25uZWN0ZWRSb3V0ZXMiLCJuZXN0ZWRDb25maWciLCJwYXR0ZXJuIiwicGFyc2UiLCJpbmRleCIsInJvdXRlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSxJQUFBLG1CQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsc0JBQUEsQ0FBQSxDQUFBOztBQUNBLElBQUEsWUFBQSxHQUFBLHNCQUFBLENBQUEsT0FBQSxDQUFBLGNBQUEsQ0FBQSxDQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1RGUsU0FBQSxnQkFBQSxDQUFBLElBQUEsRUFHWTtBQUFBOztBQUFBLE1BRHpCQSxPQUN5QixHQUFBLFNBQUEsQ0FBQSxNQUFBLEdBQUEsQ0FBQSxJQUFBLFNBQUEsQ0FBQSxDQUFBLENBQUEsS0FBQSxTQUFBLEdBQUEs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QUFPO0FBQUVBLFFBQUFBLE1BQU0sRUFBRSxDQUFDO0FBQUVWLFVBQUFBLElBQUksRUFBTixTQUFBO0FBQTZCYixVQUFBQSxLQUFLLEVBQUU7QUFBRXVCLFlBQUFBLE1BQU0sRUFBRTtBQUFWO0FBQXBDLFNBQUQ7QUFBVixPQUFQO0FBQ0Q7QUFDRjtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGVzY2FwZSBmcm9tICdlc2NhcGUtc3RyaW5nLXJlZ2V4cCc7XG5pbXBvcnQgcXVlcnlTdHJpbmcgZnJvbSAncXVlcnktc3RyaW5nJztcbmltcG9ydCB7XG4gIE5hdmlnYXRpb25TdGF0ZSxcbiAgUGFydGlhbFN0YXRlLFxuICBJbml0aWFsU3RhdGUsXG59IGZyb20gJ0ByZWFjdC1uYXZpZ2F0aW9uL3JvdXRlcnMnO1xuXG50eXBlIFBhcnNlQ29uZmlnID0gUmVjb3JkPHN0cmluZywgKHZhbHVlOiBzdHJpbmcpID0+IGFueT47XG5cbnR5cGUgT3B0aW9ucyA9IHtcbiAgW3JvdXRlTmFtZTogc3RyaW5nXTpcbiAgICB8IHN0cmluZ1xuICAgIHwge1xuICAgICAgICBwYXRoPzogc3RyaW5nO1xuICAgICAgICBwYXJzZT86IFBhcnNlQ29uZmlnO1xuICAgICAgICBzY3JlZW5zPzogT3B0aW9ucztcbiAgICAgICAgaW5pdGlhbFJvdXRlTmFtZT86IHN0cmluZztcbiAgICAgIH07XG59O1xuXG50eXBlIFJvdXRlQ29uZmlnID0ge1xuICBtYXRjaDogUmVnRXhwO1xuICBwYXR0ZXJuOiBzdHJpbmc7XG4gIHJvdXRlTmFtZXM6IHN0cmluZ1tdO1xuICBwYXJzZTogUGFyc2VDb25maWcgfCB1bmRlZmluZWQ7XG59O1xuXG50eXBlIEluaXRpYWxSb3V0ZUNvbmZpZyA9IHtcbiAgaW5pdGlhbFJvdXRlTmFtZTogc3RyaW5nO1xuICBjb25uZWN0ZWRSb3V0ZXM6IHN0cmluZ1tdO1xufTtcblxudHlwZSBSZXN1bHRTdGF0ZSA9IFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+ICYge1xuICBzdGF0ZT86IFJlc3VsdFN0YXRlO1xufTtcblxuLyoqXG4gKiBVdGlsaXR5IHRvIHBhcnNlIGEgcGF0aCBzdHJpbmcgdG8gaW5pdGlhbCBzdGF0ZSBvYmplY3QgYWNjZXB0ZWQgYnkgdGhlIGNvbnRhaW5lci5cbiAqIFRoaXMgaXMgdXNlZnVsIGZvciBkZWVwIGxpbmtpbmcgd2hlbiB3ZSBuZWVkIHRvIGhhbmRsZSB0aGUgaW5jb21pbmcgVVJMLlxuICpcbiAqIEV4YW1wbGU6XG4gKiBgYGBqc1xuICogZ2V0U3RhdGVGcm9tUGF0aChcbiAqICAgJy9jaGF0L2phbmUvNDInLFxuICogICB7XG4gKiAgICAgQ2hhdDoge1xuICogICAgICAgcGF0aDogJ2NoYXQvOmF1dGhvci86aWQnLFxuICogICAgICAgcGFyc2U6IHsgaWQ6IE51bWJlciB9XG4gKiAgICAgfVxuICogICB9XG4gKiApXG4gKiBgYGBcbiAqIEBwYXJhbSBwYXRoIFBhdGggc3RyaW5nIHRvIHBhcnNlIGFuZCBjb252ZXJ0LCBlLmcuIC9mb28vYmFyP2NvdW50PTQyLlxuICogQHBhcmFtIG9wdGlvbnMgRXh0cmEgb3B0aW9ucyB0byBmaW5lLXR1bmUgaG93IHRvIHBhcnNlIHRoZSBwYXRoLlxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBnZXRTdGF0ZUZyb21QYXRoKFxuICBwYXRoOiBzdHJpbmcsXG4gIG9wdGlvbnM6IE9wdGlvbnMgPSB7fVxuKTogUmVzdWx0U3RhdGUgfCB1bmRlZmluZWQge1xuICBpZiAocGF0aCA9PT0gJycpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGxldCBpbml0aWFsUm91dGVzOiBJbml0aWFsUm91dGVDb25maWdbXSA9IFtdO1xuICAvLyBDcmVhdGUgYSBub3JtYWxpemVkIGNvbmZpZ3MgYXJyYXkgd2hpY2ggd2lsbCBiZSBlYXNpZXIgdG8gdXNlXG4gIGNvbnN0IGNvbmZpZ3MgPSAoW10gYXMgUm91dGVDb25maWdbXSkuY29uY2F0KFxuICAgIC4uLk9iamVjdC5rZXlzKG9wdGlvbnMpLm1hcChrZXkgPT5cbiAgICAgIGNyZWF0ZU5vcm1hbGl6ZWRDb25maWdzKGtleSwgb3B0aW9ucywgW10sIGluaXRpYWxSb3V0ZXMpXG4gICAgKVxuICApO1xuXG4gIGxldCByZXN1bHQ6IFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+IHwgdW5kZWZpbmVkO1xuICBsZXQgY3VycmVudDogUGFydGlhbFN0YXRlPE5hdmlnYXRpb25TdGF0ZT4gfCB1bmRlZmluZWQ7XG5cbiAgbGV0IHJlbWFpbmluZyA9IHBhdGhcbiAgICAucmVwbGFjZSgvWy9dKy8sICcvJykgLy8gUmVwbGFjZSBtdWx0aXBsZSBzbGFzaCAoLy8pIHdpdGggc2luZ2xlIG9uZXNcbiAgICAucmVwbGFjZSgvXlxcLy8sICcnKSAvLyBSZW1vdmUgZXh0cmEgbGVhZGluZyBzbGFzaFxuICAgIC5yZXBsYWNlKC9cXD8uKi8sICcnKTsgLy8gUmVtb3ZlIHF1ZXJ5IHBhcmFtcyB3aGljaCB3ZSB3aWxsIGhhbmRsZSBsYXRlclxuXG4gIHdoaWxlIChyZW1haW5pbmcpIHtcbiAgICBsZXQgcm91dGVOYW1lczogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gICAgbGV0IHBhcmFtczogUmVjb3JkPHN0cmluZywgYW55PiB8IHVuZGVmaW5lZDtcblxuICAgIC8vIEdvIHRocm91Z2ggYWxsIGNvbmZpZ3MsIGFuZCBzZWUgaWYgdGhlIG5leHQgcGF0aCBzZWdtZW50IG1hdGNoZXMgb3VyIHJlZ2V4XG4gICAgZm9yIChjb25zdCBjb25maWcgb2YgY29uZmlncykge1xuICAgICAgY29uc3QgbWF0Y2ggPSByZW1haW5pbmcubWF0Y2goY29uZmlnLm1hdGNoKTtcblxuICAgICAgLy8gSWYgb3VyIHJlZ2V4IG1hdGNoZXMsIHdlIG5lZWQgdG8gZXh0cmFjdCBwYXJhbXMgZnJvbSB0aGUgcGF0aFxuICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgIHJvdXRlTmFtZXMgPSBbLi4uY29uZmlnLnJvdXRlTmFtZXNdO1xuXG4gICAgICAgIGNvbnN0IHBhcmFtUGF0dGVybnMgPSBjb25maWcucGF0dGVyblxuICAgICAgICAgIC5zcGxpdCgnLycpXG4gICAgICAgICAgLmZpbHRlcihwID0+IHAuc3RhcnRzV2l0aCgnOicpKTtcblxuICAgICAgICBpZiAocGFyYW1QYXR0ZXJucy5sZW5ndGgpIHtcbiAgICAgICAgICBwYXJhbXMgPSBwYXJhbVBhdHRlcm5zLnJlZHVjZTxSZWNvcmQ8c3RyaW5nLCBhbnk+PigoYWNjLCBwLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSBwLnJlcGxhY2UoL146LywgJycpO1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBtYXRjaFtpICsgMV07IC8vIFRoZSBwYXJhbSBzZWdtZW50cyBzdGFydCBmcm9tIGluZGV4IDEgaW4gdGhlIHJlZ2V4IG1hdGNoIHJlc3VsdFxuXG4gICAgICAgICAgICBhY2Nba2V5XSA9XG4gICAgICAgICAgICAgIGNvbmZpZy5wYXJzZSAmJiBjb25maWcucGFyc2Vba2V5XVxuICAgICAgICAgICAgICAgID8gY29uZmlnLnBhcnNlW2tleV0odmFsdWUpXG4gICAgICAgICAgICAgICAgOiB2YWx1ZTtcblxuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICB9LCB7fSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZW1vdmUgdGhlIG1hdGNoZWQgc2VnbWVudCBmcm9tIHRoZSByZW1haW5pbmcgcGF0aFxuICAgICAgICByZW1haW5pbmcgPSByZW1haW5pbmcucmVwbGFjZShtYXRjaFswXSwgJycpO1xuXG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIElmIHdlIGhhZG4ndCBtYXRjaGVkIGFueSBzZWdtZW50cyBlYXJsaWVyLCB1c2UgdGhlIHBhdGggYXMgcm91dGUgbmFtZVxuICAgIGlmIChyb3V0ZU5hbWVzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHNlZ21lbnRzID0gcmVtYWluaW5nLnNwbGl0KCcvJyk7XG5cbiAgICAgIHJvdXRlTmFtZXMgPSBbZGVjb2RlVVJJQ29tcG9uZW50KHNlZ21lbnRzWzBdKV07XG4gICAgICBzZWdtZW50cy5zaGlmdCgpO1xuICAgICAgcmVtYWluaW5nID0gc2VnbWVudHMuam9pbignLycpO1xuICAgIH1cblxuICAgIGxldCBzdGF0ZTogSW5pdGlhbFN0YXRlO1xuICAgIGxldCByb3V0ZU5hbWUgPSByb3V0ZU5hbWVzLnNoaWZ0KCkgYXMgc3RyaW5nO1xuICAgIGxldCBpbml0aWFsUm91dGUgPSBmaW5kSW5pdGlhbFJvdXRlKHJvdXRlTmFtZSwgaW5pdGlhbFJvdXRlcyk7XG5cbiAgICBzdGF0ZSA9IGNyZWF0ZU5lc3RlZFN0YXRlKFxuICAgICAgaW5pdGlhbFJvdXRlLFxuICAgICAgcm91dGVOYW1lLFxuICAgICAgcm91dGVOYW1lcy5sZW5ndGggPT09IDAsXG4gICAgICBwYXJhbXNcbiAgICApO1xuXG4gICAgaWYgKHJvdXRlTmFtZXMubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IG5lc3RlZFN0YXRlID0gc3RhdGU7XG5cbiAgICAgIHdoaWxlICgocm91dGVOYW1lID0gcm91dGVOYW1lcy5zaGlmdCgpIGFzIHN0cmluZykpIHtcbiAgICAgICAgaW5pdGlhbFJvdXRlID0gZmluZEluaXRpYWxSb3V0ZShyb3V0ZU5hbWUsIGluaXRpYWxSb3V0ZXMpO1xuICAgICAgICBuZXN0ZWRTdGF0ZS5yb3V0ZXNbbmVzdGVkU3RhdGUuaW5kZXggfHwgMF0uc3RhdGUgPSBjcmVhdGVOZXN0ZWRTdGF0ZShcbiAgICAgICAgICBpbml0aWFsUm91dGUsXG4gICAgICAgICAgcm91dGVOYW1lLFxuICAgICAgICAgIHJvdXRlTmFtZXMubGVuZ3RoID09PSAwLFxuICAgICAgICAgIHBhcmFtc1xuICAgICAgICApO1xuICAgICAgICBpZiAocm91dGVOYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgbmVzdGVkU3RhdGUgPSBuZXN0ZWRTdGF0ZS5yb3V0ZXNbbmVzdGVkU3RhdGUuaW5kZXggfHwgMF1cbiAgICAgICAgICAgIC5zdGF0ZSBhcyBJbml0aWFsU3RhdGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoY3VycmVudCkge1xuICAgICAgLy8gVGhlIHN0YXRlIHNob3VsZCBiZSBuZXN0ZWQgaW5zaWRlIHRoZSBkZWVwZXN0IHJvdXRlIHdlIHBhcnNlZCBiZWZvcmVcbiAgICAgIHdoaWxlIChjdXJyZW50Py5yb3V0ZXNbY3VycmVudC5pbmRleCB8fCAwXS5zdGF0ZSkge1xuICAgICAgICBjdXJyZW50ID0gY3VycmVudC5yb3V0ZXNbY3VycmVudC5pbmRleCB8fCAwXS5zdGF0ZTtcbiAgICAgIH1cblxuICAgICAgKGN1cnJlbnQgYXMgUGFydGlhbFN0YXRlPE5hdmlnYXRpb25TdGF0ZT4pLnJvdXRlc1tcbiAgICAgICAgY3VycmVudD8uaW5kZXggfHwgMFxuICAgICAgXS5zdGF0ZSA9IHN0YXRlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBzdGF0ZTtcbiAgICB9XG5cbiAgICBjdXJyZW50ID0gc3RhdGU7XG4gIH1cblxuICBpZiAoY3VycmVudCA9PSBudWxsIHx8IHJlc3VsdCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IHF1ZXJ5ID0gcGF0aC5zcGxpdCgnPycpWzFdO1xuXG4gIGlmIChxdWVyeSkge1xuICAgIHdoaWxlIChjdXJyZW50Py5yb3V0ZXNbY3VycmVudC5pbmRleCB8fCAwXS5zdGF0ZSkge1xuICAgICAgLy8gVGhlIHF1ZXJ5IHBhcmFtcyBhcHBseSB0byB0aGUgZGVlcGVzdCByb3V0ZVxuICAgICAgY3VycmVudCA9IGN1cnJlbnQucm91dGVzW2N1cnJlbnQuaW5kZXggfHwgMF0uc3RhdGU7XG4gICAgfVxuXG4gICAgY29uc3Qgcm91dGUgPSAoY3VycmVudCBhcyBQYXJ0aWFsU3RhdGU8TmF2aWdhdGlvblN0YXRlPikucm91dGVzW1xuICAgICAgY3VycmVudD8uaW5kZXggfHwgMFxuICAgIF07XG5cbiAgICBjb25zdCBwYXJhbXMgPSBxdWVyeVN0cmluZy5wYXJzZShxdWVyeSk7XG4gICAgY29uc3QgcGFyc2VGdW5jdGlvbiA9IGZpbmRQYXJzZUNvbmZpZ0ZvclJvdXRlKHJvdXRlLm5hbWUsIGNvbmZpZ3MpO1xuXG4gICAgaWYgKHBhcnNlRnVuY3Rpb24pIHtcbiAgICAgIE9iamVjdC5rZXlzKHBhcmFtcykuZm9yRWFjaChuYW1lID0+IHtcbiAgICAgICAgaWYgKHBhcnNlRnVuY3Rpb25bbmFtZV0gJiYgdHlwZW9mIHBhcmFtc1tuYW1lXSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBwYXJhbXNbbmFtZV0gPSBwYXJzZUZ1bmN0aW9uW25hbWVdKHBhcmFtc1tuYW1lXSBhcyBzdHJpbmcpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByb3V0ZS5wYXJhbXMgPSB7IC4uLnJvdXRlLnBhcmFtcywgLi4ucGFyYW1zIH07XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVOb3JtYWxpemVkQ29uZmlncyhcbiAga2V5OiBzdHJpbmcsXG4gIHJvdXRlQ29uZmlnOiBPcHRpb25zLFxuICByb3V0ZU5hbWVzOiBzdHJpbmdbXSA9IFtdLFxuICBpbml0aWFsczogSW5pdGlhbFJvdXRlQ29uZmlnW11cbik6IFJvdXRlQ29uZmlnW10ge1xuICBjb25zdCBjb25maWdzOiBSb3V0ZUNvbmZpZ1tdID0gW107XG5cbiAgcm91dGVOYW1lcy5wdXNoKGtleSk7XG5cbiAgY29uc3QgdmFsdWUgPSByb3V0ZUNvbmZpZ1trZXldO1xuXG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgLy8gSWYgYSBzdHJpbmcgaXMgc3BlY2lmaWVkIGFzIHRoZSB2YWx1ZSBvZiB0aGUga2V5KGUuZy4gRm9vOiAnL3BhdGgnKSwgdXNlIGl0IGFzIHRoZSBwYXR0ZXJuXG4gICAgaWYgKHZhbHVlICE9PSAnJykge1xuICAgICAgY29uZmlncy5wdXNoKGNyZWF0ZUNvbmZpZ0l0ZW0ocm91dGVOYW1lcywgdmFsdWUpKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgIC8vIGlmIGFuIG9iamVjdCBpcyBzcGVjaWZpZWQgYXMgdGhlIHZhbHVlIChlLmcuIEZvbzogeyAuLi4gfSksXG4gICAgLy8gaXQgY2FuIGhhdmUgYHBhdGhgIHByb3BlcnR5IGFuZFxuICAgIC8vIGl0IGNvdWxkIGhhdmUgYHNjcmVlbnNgIHByb3Agd2hpY2ggaGFzIG5lc3RlZCBjb25maWdzXG4gICAgaWYgKHZhbHVlLnBhdGggJiYgdmFsdWUucGF0aCAhPT0gJycpIHtcbiAgICAgIGNvbmZpZ3MucHVzaChjcmVhdGVDb25maWdJdGVtKHJvdXRlTmFtZXMsIHZhbHVlLnBhdGgsIHZhbHVlLnBhcnNlKSk7XG4gICAgfVxuICAgIGlmICh2YWx1ZS5zY3JlZW5zKSB7XG4gICAgICAvLyBwcm9wZXJ0eSBgaW5pdGlhbFJvdXRlTmFtZWAgd2l0aG91dCBgc2NyZWVuc2AgaGFzIG5vIHB1cnBvc2VcbiAgICAgIGlmICh2YWx1ZS5pbml0aWFsUm91dGVOYW1lKSB7XG4gICAgICAgIGluaXRpYWxzLnB1c2goe1xuICAgICAgICAgIGluaXRpYWxSb3V0ZU5hbWU6IHZhbHVlLmluaXRpYWxSb3V0ZU5hbWUsXG4gICAgICAgICAgY29ubmVjdGVkUm91dGVzOiBPYmplY3Qua2V5cyh2YWx1ZS5zY3JlZW5zKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBPYmplY3Qua2V5cyh2YWx1ZS5zY3JlZW5zKS5mb3JFYWNoKG5lc3RlZENvbmZpZyA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGNyZWF0ZU5vcm1hbGl6ZWRDb25maWdzKFxuICAgICAgICAgIG5lc3RlZENvbmZpZyxcbiAgICAgICAgICB2YWx1ZS5zY3JlZW5zIGFzIE9wdGlvbnMsXG4gICAgICAgICAgcm91dGVOYW1lcyxcbiAgICAgICAgICBpbml0aWFsc1xuICAgICAgICApO1xuICAgICAgICBjb25maWdzLnB1c2goLi4ucmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHJvdXRlTmFtZXMucG9wKCk7XG5cbiAgcmV0dXJuIGNvbmZpZ3M7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbmZpZ0l0ZW0oXG4gIHJvdXRlTmFtZXM6IHN0cmluZ1tdLFxuICBwYXR0ZXJuOiBzdHJpbmcsXG4gIHBhcnNlPzogUGFyc2VDb25maWdcbik6IFJvdXRlQ29uZmlnIHtcbiAgY29uc3QgbWF0Y2ggPSBuZXcgUmVnRXhwKFxuICAgICdeJyArIGVzY2FwZShwYXR0ZXJuKS5yZXBsYWNlKC86W2EtejAtOV0rL2dpLCAnKFteL10rKScpICsgJy8/J1xuICApO1xuXG4gIHJldHVybiB7XG4gICAgbWF0Y2gsXG4gICAgcGF0dGVybixcbiAgICAvLyBUaGUgcm91dGVOYW1lcyBhcnJheSBpcyBtdXRhdGVkLCBzbyBjb3B5IGl0IHRvIGtlZXAgdGhlIGN1cnJlbnQgc3RhdGVcbiAgICByb3V0ZU5hbWVzOiBbLi4ucm91dGVOYW1lc10sXG4gICAgcGFyc2UsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGZpbmRQYXJzZUNvbmZpZ0ZvclJvdXRlKFxuICByb3V0ZU5hbWU6IHN0cmluZyxcbiAgZmxhdENvbmZpZzogUm91dGVDb25maWdbXVxuKTogUGFyc2VDb25maWcgfCB1bmRlZmluZWQge1xuICBmb3IgKGNvbnN0IGNvbmZpZyBvZiBmbGF0Q29uZmlnKSB7XG4gICAgaWYgKHJvdXRlTmFtZSA9PT0gY29uZmlnLnJvdXRlTmFtZXNbY29uZmlnLnJvdXRlTmFtZXMubGVuZ3RoIC0gMV0pIHtcbiAgICAgIHJldHVybiBjb25maWcucGFyc2U7XG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbi8vIHRyaWVzIHRvIGZpbmQgYW4gaW5pdGlhbCByb3V0ZSBjb25uZWN0ZWQgd2l0aCB0aGUgb25lIHBhc3NlZFxuZnVuY3Rpb24gZmluZEluaXRpYWxSb3V0ZShcbiAgcm91dGVOYW1lOiBzdHJpbmcsXG4gIGluaXRpYWxSb3V0ZXM6IEluaXRpYWxSb3V0ZUNvbmZpZ1tdXG4pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICBmb3IgKGNvbnN0IGNvbmZpZyBvZiBpbml0aWFsUm91dGVzKSB7XG4gICAgaWYgKGNvbmZpZy5jb25uZWN0ZWRSb3V0ZXMuaW5jbHVkZXMocm91dGVOYW1lKSkge1xuICAgICAgcmV0dXJuIGNvbmZpZy5pbml0aWFsUm91dGVOYW1lID09PSByb3V0ZU5hbWVcbiAgICAgICAgPyB1bmRlZmluZWRcbiAgICAgICAgOiBjb25maWcuaW5pdGlhbFJvdXRlTmFtZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuLy8gcmV0dXJucyBuZXN0ZWQgc3RhdGUgb2JqZWN0IHdpdGggdmFsdWVzIGRlcGVuZGluZyBvbiB3aGV0aGVyXG4vLyBpdCBpcyB0aGUgZW5kIG9mIHN0YXRlIGFuZCBpZiB0aGVyZSBpcyBpbml0aWFsUm91dGUgZm9yIHRoaXMgbGV2ZWxcbmZ1bmN0aW9uIGNyZWF0ZU5lc3RlZFN0YXRlKFxuICBpbml0aWFsUm91dGU6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcm91dGVOYW1lOiBzdHJpbmcsXG4gIGlzRW1wdHk6IGJvb2xlYW4sXG4gIHBhcmFtcz86IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWRcbik6IEluaXRpYWxTdGF0ZSB7XG4gIGlmIChpc0VtcHR5KSB7XG4gICAgaWYgKGluaXRpYWxSb3V0ZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaW5kZXg6IDEsXG4gICAgICAgIHJvdXRlczogW1xuICAgICAgICAgIHsgbmFtZTogaW5pdGlhbFJvdXRlIH0sXG4gICAgICAgICAgeyBuYW1lOiByb3V0ZU5hbWUgYXMgc3RyaW5nLCAuLi4ocGFyYW1zICYmIHsgcGFyYW1zIH0pIH0sXG4gICAgICAgIF0sXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICByb3V0ZXM6IFt7IG5hbWU6IHJvdXRlTmFtZSBhcyBzdHJpbmcsIC4uLihwYXJhbXMgJiYgeyBwYXJhbXMgfSkgfV0sXG4gICAgICB9O1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoaW5pdGlhbFJvdXRlKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpbmRleDogMSxcbiAgICAgICAgcm91dGVzOiBbXG4gICAgICAgICAgeyBuYW1lOiBpbml0aWFsUm91dGUgfSxcbiAgICAgICAgICB7IG5hbWU6IHJvdXRlTmFtZSBhcyBzdHJpbmcsIHN0YXRlOiB7IHJvdXRlczogW10gfSB9LFxuICAgICAgICBdLFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHsgcm91dGVzOiBbeyBuYW1lOiByb3V0ZU5hbWUgYXMgc3RyaW5nLCBzdGF0ZTogeyByb3V0ZXM6IFtdIH0gfV0gfTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==
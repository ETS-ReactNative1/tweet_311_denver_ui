271171f180e03a728ace138209679ee6
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/slicedToArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.NavigationStateContext = void 0;

var React = _interopRequireWildcard(require("react"));

var _routers = require("@react-navigation/routers");

var _EnsureSingleNavigator = _interopRequireDefault(require("./EnsureSingleNavigator"));

var _NavigationBuilderContext = _interopRequireDefault(require("./NavigationBuilderContext"));

var _useFocusedListeners = _interopRequireDefault(require("./useFocusedListeners"));

var _useDevTools = _interopRequireDefault(require("./useDevTools"));

var _useStateGetters = _interopRequireDefault(require("./useStateGetters"));

var _isSerializable = _interopRequireDefault(require("./isSerializable"));

var _useEventEmitter = _interopRequireDefault(require("./useEventEmitter"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

function _objectWithoutProperties(source, excluded) {
  if (source == null) return {};

  var target = _objectWithoutPropertiesLoose(source, excluded);

  var key, i;

  if (Object.getOwnPropertySymbols) {
    var sourceSymbolKeys = Object.getOwnPropertySymbols(source);

    for (i = 0; i < sourceSymbolKeys.length; i++) {
      key = sourceSymbolKeys[i];
      if (excluded.indexOf(key) >= 0) continue;
      if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue;
      target[key] = source[key];
    }
  }

  return target;
}

function _objectWithoutPropertiesLoose(source, excluded) {
  if (source == null) return {};
  var target = {};
  var sourceKeys = Object.keys(source);
  var key, i;

  for (i = 0; i < sourceKeys.length; i++) {
    key = sourceKeys[i];
    if (excluded.indexOf(key) >= 0) continue;
    target[key] = source[key];
  }

  return target;
}

var MISSING_CONTEXT_ERROR = "We couldn't find a navigation context. Have you wrapped your app with 'NavigationContainer'? See https://reactnavigation.org/docs/en/getting-started.html for setup instructions.";
var NOT_INITIALIZED_ERROR = "The 'navigation' object hasn't been initialized yet. This might happen if you don't have a navigator mounted, or if the navigator hasn't finished mounting. You can ensure that all navigators have mounted after the callback to 'useEffect' is called in your root component. See https://reactnavigation.org/docs/en/navigating-without-navigation-prop.html#handling-initialization for more details.";
var NavigationStateContext = React.createContext({
  isDefault: true,

  get getKey() {
    throw new Error(MISSING_CONTEXT_ERROR);
  },

  get setKey() {
    throw new Error(MISSING_CONTEXT_ERROR);
  },

  get getState() {
    throw new Error(MISSING_CONTEXT_ERROR);
  },

  get setState() {
    throw new Error(MISSING_CONTEXT_ERROR);
  },

  get performTransaction() {
    throw new Error(MISSING_CONTEXT_ERROR);
  }

});
exports.NavigationStateContext = NavigationStateContext;
var hasWarnedForSerialization = false;

var getPartialState = function getPartialState(state) {
  if (state === undefined) {
    return;
  }

  var key = state.key,
      routeNames = state.routeNames,
      partialState = _objectWithoutProperties(state, ["key", "routeNames"]);

  return _objectSpread({}, partialState, {
    stale: true,
    routes: state.routes.map(function (route) {
      if (route.state === undefined) {
        return route;
      }

      return _objectSpread({}, route, {
        state: getPartialState(route.state)
      });
    })
  });
};

var BaseNavigationContainer = React.forwardRef(function BaseNavigationContainer(_ref, ref) {
  var initialState = _ref.initialState,
      onStateChange = _ref.onStateChange,
      independent = _ref.independent,
      children = _ref.children;
  var parent = React.useContext(NavigationStateContext);

  if (!parent.isDefault && !independent) {
    throw new Error("Looks like you have nested a 'NavigationContainer' inside another. Normally you need only one container at the root of the app, so this was probably an error. If this was intentional, pass 'independent={true}' explicitely. Note that this will make the child navigators disconnected from the parent and you won't be able to navigate between them.");
  }

  var _React$useState = React.useState(function () {
    return getPartialState(initialState == null ? undefined : initialState);
  }),
      _React$useState2 = (0, _slicedToArray2.default)(_React$useState, 2),
      state = _React$useState2[0],
      setNavigationState = _React$useState2[1];

  var navigationStateRef = React.useRef();
  var transactionStateRef = React.useRef(null);
  var isTransactionActiveRef = React.useRef(false);
  var isFirstMountRef = React.useRef(true);
  var skipTrackingRef = React.useRef(false);
  var navigatorKeyRef = React.useRef();
  var getKey = React.useCallback(function () {
    return navigatorKeyRef.current;
  }, []);
  var setKey = React.useCallback(function (key) {
    navigatorKeyRef.current = key;
  }, []);
  var performTransaction = React.useCallback(function (callback) {
    if (isTransactionActiveRef.current) {
      throw new Error("Only one transaction can be active at a time. Did you accidentally nest 'performTransaction'?");
    }

    setNavigationState(function (navigationState) {
      isTransactionActiveRef.current = true;
      transactionStateRef.current = navigationState;

      try {
        callback();
      } finally {
        isTransactionActiveRef.current = false;
      }

      return transactionStateRef.current;
    });
  }, []);
  var getState = React.useCallback(function () {
    return transactionStateRef.current !== null ? transactionStateRef.current : navigationStateRef.current;
  }, []);
  var setState = React.useCallback(function (navigationState) {
    if (transactionStateRef.current === null) {
      throw new Error("Any 'setState' calls need to be done inside 'performTransaction'");
    }

    transactionStateRef.current = navigationState;
  }, []);
  var reset = React.useCallback(function (state) {
    performTransaction(function () {
      skipTrackingRef.current = true;
      setState(state);
    });
  }, [performTransaction, setState]);

  var _ref2 = (0, _useDevTools.default)({
    name: '@react-navigation',
    reset: reset,
    state: state
  }),
      trackState = _ref2.trackState,
      trackAction = _ref2.trackAction;

  var _ref3 = (0, _useFocusedListeners.default)(),
      listeners = _ref3.listeners,
      addFocusedListener = _ref3.addListener;

  var _ref4 = (0, _useStateGetters.default)(),
      getStateForRoute = _ref4.getStateForRoute,
      addStateGetter = _ref4.addStateGetter;

  var dispatch = function dispatch(action) {
    if (listeners[0] == null) {
      throw new Error(NOT_INITIALIZED_ERROR);
    }

    listeners[0](function (navigation) {
      return navigation.dispatch(action);
    });
  };

  var canGoBack = function canGoBack() {
    if (listeners[0] == null) {
      return false;
    }

    var _listeners$ = listeners[0](function (navigation) {
      return navigation.canGoBack();
    }),
        result = _listeners$.result,
        handled = _listeners$.handled;

    if (handled) {
      return result;
    } else {
      return false;
    }
  };

  var resetRoot = React.useCallback(function (state) {
    performTransaction(function () {
      trackAction('@@RESET_ROOT');
      setState(state);
    });
  }, [performTransaction, setState, trackAction]);
  var getRootState = React.useCallback(function () {
    return getStateForRoute('root');
  }, [getStateForRoute]);
  var emitter = (0, _useEventEmitter.default)();
  React.useImperativeHandle(ref, function () {
    return _objectSpread({}, Object.keys(_routers.CommonActions).reduce(function (acc, name) {
      acc[name] = function () {
        var _routers$CommonAction;

        return dispatch((_routers$CommonAction = _routers.CommonActions)[name].apply(_routers$CommonAction, arguments));
      };

      return acc;
    }, {}), {}, emitter.create('root'), {
      resetRoot: resetRoot,
      dispatch: dispatch,
      canGoBack: canGoBack,
      getRootState: getRootState
    });
  });
  var builderContext = React.useMemo(function () {
    return {
      addFocusedListener: addFocusedListener,
      addStateGetter: addStateGetter,
      trackAction: trackAction
    };
  }, [addFocusedListener, trackAction, addStateGetter]);
  var context = React.useMemo(function () {
    return {
      state: state,
      performTransaction: performTransaction,
      getState: getState,
      setState: setState,
      getKey: getKey,
      setKey: setKey
    };
  }, [getKey, getState, performTransaction, setKey, setState, state]);
  React.useEffect(function () {
    if (process.env.NODE_ENV !== 'production') {
      if (state !== undefined && !(0, _isSerializable.default)(state) && !hasWarnedForSerialization) {
        hasWarnedForSerialization = true;
        console.warn("We found non-serializable values in the navigation state, which can break usage such as persisting and restoring state. This might happen if you passed non-serializable values such as function, class instances etc. in params. If you need to use components with callbacks in your options, you can use 'navigation.setOptions' instead. See https://reactnavigation.org/docs/en/troubleshooting.html#i-get-the-warning-we-found-non-serializable-values-in-the-navigation-state for more details.");
      }
    }

    emitter.emit({
      type: 'state',
      data: {
        state: state
      }
    });

    if (skipTrackingRef.current) {
      skipTrackingRef.current = false;
    } else {
      trackState(getRootState);
    }

    navigationStateRef.current = state;
    transactionStateRef.current = null;

    if (!isFirstMountRef.current && onStateChange) {
      onStateChange(getRootState());
    }

    isFirstMountRef.current = false;
  }, [state, onStateChange, trackState, getRootState, emitter]);
  return React.createElement(_NavigationBuilderContext.default.Provider, {
    value: builderContext
  }, React.createElement(NavigationStateContext.Provider, {
    value: context
  }, React.createElement(_EnsureSingleNavigator.default, null, children)));
});
var _default = BaseNavigationContainer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkJhc2VOYXZpZ2F0aW9uQ29udGFpbmVyLnRzeCJdLCJuYW1lcyI6WyJNSVNTSU5HX0NPTlRFWFRfRVJST1IiLCJOT1RfSU5JVElBTElaRURfRVJST1IiLCJOYXZpZ2F0aW9uU3RhdGVDb250ZXh0IiwiaXNEZWZhdWx0IiwiaGFzV2FybmVkRm9yU2VyaWFsaXphdGlvbiIsImdldFBhcnRpYWxTdGF0ZSIsInN0YXRlIiwicm91dGVOYW1lcyIsInN0YWxlIiwicm91dGVzIiwicm91dGUiLCJCYXNlTmF2aWdhdGlvbkNvbnRhaW5lciIsImNoaWxkcmVuIiwicGFyZW50IiwiUmVhY3QiLCJpbml0aWFsU3RhdGUiLCJuYXZpZ2F0aW9uU3RhdGVSZWYiLCJ0cmFuc2FjdGlvblN0YXRlUmVmIiwiaXNUcmFuc2FjdGlvbkFjdGl2ZVJlZiIsImlzRmlyc3RNb3VudFJlZiIsInNraXBUcmFja2luZ1JlZiIsIm5hdmlnYXRvcktleVJlZiIsImdldEtleSIsInNldEtleSIsImtleSIsInBlcmZvcm1UcmFuc2FjdGlvbiIsImNhbGxiYWNrIiwic2V0TmF2aWdhdGlvblN0YXRlIiwibmF2aWdhdGlvblN0YXRlIiwiZ2V0U3RhdGUiLCJzZXRTdGF0ZSIsInJlc2V0IiwidHJhY2tBY3Rpb24iLCJuYW1lIiwiYWRkTGlzdGVuZXIiLCJhZGRGb2N1c2VkTGlzdGVuZXIiLCJhZGRTdGF0ZUdldHRlciIsImRpc3BhdGNoIiwiYWN0aW9uIiwibGlzdGVuZXJzIiwibmF2aWdhdGlvbiIsImNhbkdvQmFjayIsImhhbmRsZWQiLCJyZXNldFJvb3QiLCJnZXRSb290U3RhdGUiLCJnZXRTdGF0ZUZvclJvdXRlIiwiZW1pdHRlciIsIk9iamVjdCIsIkNvbW1vbkFjdGlvbnMiLCJhY2MiLCJidWlsZGVyQ29udGV4dCIsImNvbnRleHQiLCJwcm9jZXNzIiwiY29uc29sZSIsInR5cGUiLCJkYXRhIiwidHJhY2tTdGF0ZSIsIm9uU3RhdGVDaGFuZ2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FB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akNGTCxHQUFBQSxFQWtDRyxDQUFBLEtBQUEsRUFBQSxhQUFBLEVBQUEsVUFBQSxFQUFBLFlBQUEsRUFsQ0hBLE9Ba0NHLENBbENIQTtBQW9DQSxTQUNFLEtBQUEsQ0FBQSxhQUFBLENBQUMseUJBQUEsQ0FBRCxPQUFDLENBQUQsUUFBQSxFQUFBO0FBQW1DLElBQUEsS0FBSyxFQUFFb0M7QUFBMUMsR0FBQSxFQUNFLEtBQUEsQ0FBQSxhQUFBLENBQUMsc0JBQUQsQ0FBQSxRQUFBLEVBQUE7QUFBaUMsSUFBQSxLQUFLLEVBQUVDO0FBQXhDLEdBQUEsRUFDRSxLQUFBLENBQUEsYUFBQSxDQUFDLHNCQUFBLENBQUQsT0FBQSxFQUFBLElBQUEsRUFITixRQUdNLENBREYsQ0FERixDQURGO0FBek5KLENBQWdDLENBQWhDO2VBbU9leEMsdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQge1xuICBDb21tb25BY3Rpb25zLFxuICBSb3V0ZSxcbiAgTmF2aWdhdGlvblN0YXRlLFxuICBJbml0aWFsU3RhdGUsXG4gIFBhcnRpYWxTdGF0ZSxcbiAgTmF2aWdhdGlvbkFjdGlvbixcbn0gZnJvbSAnQHJlYWN0LW5hdmlnYXRpb24vcm91dGVycyc7XG5pbXBvcnQgRW5zdXJlU2luZ2xlTmF2aWdhdG9yIGZyb20gJy4vRW5zdXJlU2luZ2xlTmF2aWdhdG9yJztcbmltcG9ydCBOYXZpZ2F0aW9uQnVpbGRlckNvbnRleHQgZnJvbSAnLi9OYXZpZ2F0aW9uQnVpbGRlckNvbnRleHQnO1xuaW1wb3J0IHVzZUZvY3VzZWRMaXN0ZW5lcnMgZnJvbSAnLi91c2VGb2N1c2VkTGlzdGVuZXJzJztcbmltcG9ydCB1c2VEZXZUb29scyBmcm9tICcuL3VzZURldlRvb2xzJztcbmltcG9ydCB1c2VTdGF0ZUdldHRlcnMgZnJvbSAnLi91c2VTdGF0ZUdldHRlcnMnO1xuaW1wb3J0IGlzU2VyaWFsaXphYmxlIGZyb20gJy4vaXNTZXJpYWxpemFibGUnO1xuXG5pbXBvcnQgeyBOYXZpZ2F0aW9uQ29udGFpbmVyUmVmLCBOYXZpZ2F0aW9uQ29udGFpbmVyUHJvcHMgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB1c2VFdmVudEVtaXR0ZXIgZnJvbSAnLi91c2VFdmVudEVtaXR0ZXInO1xuXG50eXBlIFN0YXRlID0gTmF2aWdhdGlvblN0YXRlIHwgUGFydGlhbFN0YXRlPE5hdmlnYXRpb25TdGF0ZT4gfCB1bmRlZmluZWQ7XG5cbmNvbnN0IE1JU1NJTkdfQ09OVEVYVF9FUlJPUiA9XG4gIFwiV2UgY291bGRuJ3QgZmluZCBhIG5hdmlnYXRpb24gY29udGV4dC4gSGF2ZSB5b3Ugd3JhcHBlZCB5b3VyIGFwcCB3aXRoICdOYXZpZ2F0aW9uQ29udGFpbmVyJz8gU2VlIGh0dHBzOi8vcmVhY3RuYXZpZ2F0aW9uLm9yZy9kb2NzL2VuL2dldHRpbmctc3RhcnRlZC5odG1sIGZvciBzZXR1cCBpbnN0cnVjdGlvbnMuXCI7XG5cbmNvbnN0IE5PVF9JTklUSUFMSVpFRF9FUlJPUiA9XG4gIFwiVGhlICduYXZpZ2F0aW9uJyBvYmplY3QgaGFzbid0IGJlZW4gaW5pdGlhbGl6ZWQgeWV0LiBUaGlzIG1pZ2h0IGhhcHBlbiBpZiB5b3UgZG9uJ3QgaGF2ZSBhIG5hdmlnYXRvciBtb3VudGVkLCBvciBpZiB0aGUgbmF2aWdhdG9yIGhhc24ndCBmaW5pc2hlZCBtb3VudGluZy4gWW91IGNhbiBlbnN1cmUgdGhhdCBhbGwgbmF2aWdhdG9ycyBoYXZlIG1vdW50ZWQgYWZ0ZXIgdGhlIGNhbGxiYWNrIHRvICd1c2VFZmZlY3QnIGlzIGNhbGxlZCBpbiB5b3VyIHJvb3QgY29tcG9uZW50LiBTZWUgaHR0cHM6Ly9yZWFjdG5hdmlnYXRpb24ub3JnL2RvY3MvZW4vbmF2aWdhdGluZy13aXRob3V0LW5hdmlnYXRpb24tcHJvcC5odG1sI2hhbmRsaW5nLWluaXRpYWxpemF0aW9uIGZvciBtb3JlIGRldGFpbHMuXCI7XG5cbmV4cG9ydCBjb25zdCBOYXZpZ2F0aW9uU3RhdGVDb250ZXh0ID0gUmVhY3QuY3JlYXRlQ29udGV4dDx7XG4gIGlzRGVmYXVsdD86IHRydWU7XG4gIHN0YXRlPzogTmF2aWdhdGlvblN0YXRlIHwgUGFydGlhbFN0YXRlPE5hdmlnYXRpb25TdGF0ZT47XG4gIGdldEtleTogKCkgPT4gc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBzZXRLZXk6IChrZXk6IHN0cmluZykgPT4gdm9pZDtcbiAgZ2V0U3RhdGU6ICgpID0+IE5hdmlnYXRpb25TdGF0ZSB8IFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+IHwgdW5kZWZpbmVkO1xuICBzZXRTdGF0ZTogKFxuICAgIHN0YXRlOiBOYXZpZ2F0aW9uU3RhdGUgfCBQYXJ0aWFsU3RhdGU8TmF2aWdhdGlvblN0YXRlPiB8IHVuZGVmaW5lZFxuICApID0+IHZvaWQ7XG4gIHBlcmZvcm1UcmFuc2FjdGlvbjogKGFjdGlvbjogKCkgPT4gdm9pZCkgPT4gdm9pZDtcbn0+KHtcbiAgaXNEZWZhdWx0OiB0cnVlLFxuXG4gIGdldCBnZXRLZXkoKTogYW55IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoTUlTU0lOR19DT05URVhUX0VSUk9SKTtcbiAgfSxcbiAgZ2V0IHNldEtleSgpOiBhbnkge1xuICAgIHRocm93IG5ldyBFcnJvcihNSVNTSU5HX0NPTlRFWFRfRVJST1IpO1xuICB9LFxuICBnZXQgZ2V0U3RhdGUoKTogYW55IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoTUlTU0lOR19DT05URVhUX0VSUk9SKTtcbiAgfSxcbiAgZ2V0IHNldFN0YXRlKCk6IGFueSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKE1JU1NJTkdfQ09OVEVYVF9FUlJPUik7XG4gIH0sXG4gIGdldCBwZXJmb3JtVHJhbnNhY3Rpb24oKTogYW55IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoTUlTU0lOR19DT05URVhUX0VSUk9SKTtcbiAgfSxcbn0pO1xuXG5sZXQgaGFzV2FybmVkRm9yU2VyaWFsaXphdGlvbiA9IGZhbHNlO1xuXG4vKipcbiAqIFJlbW92ZSBga2V5YCBhbmQgYHJvdXRlTmFtZXNgIGZyb20gdGhlIHN0YXRlIG9iamVjdHMgcmVjdXJzaXZlbHkgdG8gZ2V0IHBhcnRpYWwgc3RhdGUuXG4gKlxuICogQHBhcmFtIHN0YXRlIEluaXRpYWwgc3RhdGUgb2JqZWN0LlxuICovXG5jb25zdCBnZXRQYXJ0aWFsU3RhdGUgPSAoXG4gIHN0YXRlOiBJbml0aWFsU3RhdGUgfCB1bmRlZmluZWRcbik6IFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+IHwgdW5kZWZpbmVkID0+IHtcbiAgaWYgKHN0YXRlID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVudXNlZC12YXJzXG4gIGNvbnN0IHsga2V5LCByb3V0ZU5hbWVzLCAuLi5wYXJ0aWFsU3RhdGUgfSA9IHN0YXRlO1xuXG4gIC8vIEB0cy1pZ25vcmVcbiAgcmV0dXJuIHtcbiAgICAuLi5wYXJ0aWFsU3RhdGUsXG4gICAgc3RhbGU6IHRydWUsXG4gICAgcm91dGVzOiBzdGF0ZS5yb3V0ZXMubWFwKHJvdXRlID0+IHtcbiAgICAgIGlmIChyb3V0ZS5zdGF0ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiByb3V0ZSBhcyBSb3V0ZTxzdHJpbmc+ICYge1xuICAgICAgICAgIHN0YXRlPzogUGFydGlhbFN0YXRlPE5hdmlnYXRpb25TdGF0ZT47XG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7IC4uLnJvdXRlLCBzdGF0ZTogZ2V0UGFydGlhbFN0YXRlKHJvdXRlLnN0YXRlKSB9O1xuICAgIH0pLFxuICB9O1xufTtcblxuLyoqXG4gKiBDb250YWluZXIgY29tcG9uZW50IHdoaWNoIGhvbGRzIHRoZSBuYXZpZ2F0aW9uIHN0YXRlLlxuICogVGhpcyBzaG91bGQgYmUgcmVuZGVyZWQgYXQgdGhlIHJvb3Qgd3JhcHBpbmcgdGhlIHdob2xlIGFwcC5cbiAqXG4gKiBAcGFyYW0gcHJvcHMuaW5pdGlhbFN0YXRlIEluaXRpYWwgc3RhdGUgb2JqZWN0IGZvciB0aGUgbmF2aWdhdGlvbiB0cmVlLlxuICogQHBhcmFtIHByb3BzLm9uU3RhdGVDaGFuZ2UgQ2FsbGJhY2sgd2hpY2ggaXMgY2FsbGVkIHdpdGggdGhlIGxhdGVzdCBuYXZpZ2F0aW9uIHN0YXRlIHdoZW4gaXQgY2hhbmdlcy5cbiAqIEBwYXJhbSBwcm9wcy5jaGlsZHJlbiBDaGlsZCBlbGVtZW50cyB0byByZW5kZXIgdGhlIGNvbnRlbnQuXG4gKiBAcGFyYW0gcHJvcHMucmVmIFJlZiBvYmplY3Qgd2hpY2ggcmVmZXJzIHRvIHRoZSBuYXZpZ2F0aW9uIG9iamVjdCBjb250YWluaW5nIGhlbHBlciBtZXRob2RzLlxuICovXG5jb25zdCBCYXNlTmF2aWdhdGlvbkNvbnRhaW5lciA9IFJlYWN0LmZvcndhcmRSZWYoXG4gIGZ1bmN0aW9uIEJhc2VOYXZpZ2F0aW9uQ29udGFpbmVyKFxuICAgIHtcbiAgICAgIGluaXRpYWxTdGF0ZSxcbiAgICAgIG9uU3RhdGVDaGFuZ2UsXG4gICAgICBpbmRlcGVuZGVudCxcbiAgICAgIGNoaWxkcmVuLFxuICAgIH06IE5hdmlnYXRpb25Db250YWluZXJQcm9wcyxcbiAgICByZWY6IFJlYWN0LlJlZjxOYXZpZ2F0aW9uQ29udGFpbmVyUmVmPlxuICApIHtcbiAgICBjb25zdCBwYXJlbnQgPSBSZWFjdC51c2VDb250ZXh0KE5hdmlnYXRpb25TdGF0ZUNvbnRleHQpO1xuXG4gICAgaWYgKCFwYXJlbnQuaXNEZWZhdWx0ICYmICFpbmRlcGVuZGVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIkxvb2tzIGxpa2UgeW91IGhhdmUgbmVzdGVkIGEgJ05hdmlnYXRpb25Db250YWluZXInIGluc2lkZSBhbm90aGVyLiBOb3JtYWxseSB5b3UgbmVlZCBvbmx5IG9uZSBjb250YWluZXIgYXQgdGhlIHJvb3Qgb2YgdGhlIGFwcCwgc28gdGhpcyB3YXMgcHJvYmFibHkgYW4gZXJyb3IuIElmIHRoaXMgd2FzIGludGVudGlvbmFsLCBwYXNzICdpbmRlcGVuZGVudD17dHJ1ZX0nIGV4cGxpY2l0ZWx5LiBOb3RlIHRoYXQgdGhpcyB3aWxsIG1ha2UgdGhlIGNoaWxkIG5hdmlnYXRvcnMgZGlzY29ubmVjdGVkIGZyb20gdGhlIHBhcmVudCBhbmQgeW91IHdvbid0IGJlIGFibGUgdG8gbmF2aWdhdGUgYmV0d2VlbiB0aGVtLlwiXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IFtzdGF0ZSwgc2V0TmF2aWdhdGlvblN0YXRlXSA9IFJlYWN0LnVzZVN0YXRlPFN0YXRlPigoKSA9PlxuICAgICAgZ2V0UGFydGlhbFN0YXRlKGluaXRpYWxTdGF0ZSA9PSBudWxsID8gdW5kZWZpbmVkIDogaW5pdGlhbFN0YXRlKVxuICAgICk7XG5cbiAgICBjb25zdCBuYXZpZ2F0aW9uU3RhdGVSZWYgPSBSZWFjdC51c2VSZWY8U3RhdGU+KCk7XG4gICAgY29uc3QgdHJhbnNhY3Rpb25TdGF0ZVJlZiA9IFJlYWN0LnVzZVJlZjxTdGF0ZSB8IG51bGw+KG51bGwpO1xuICAgIGNvbnN0IGlzVHJhbnNhY3Rpb25BY3RpdmVSZWYgPSBSZWFjdC51c2VSZWY8Ym9vbGVhbj4oZmFsc2UpO1xuICAgIGNvbnN0IGlzRmlyc3RNb3VudFJlZiA9IFJlYWN0LnVzZVJlZjxib29sZWFuPih0cnVlKTtcbiAgICBjb25zdCBza2lwVHJhY2tpbmdSZWYgPSBSZWFjdC51c2VSZWY8Ym9vbGVhbj4oZmFsc2UpO1xuXG4gICAgY29uc3QgbmF2aWdhdG9yS2V5UmVmID0gUmVhY3QudXNlUmVmPHN0cmluZyB8IHVuZGVmaW5lZD4oKTtcblxuICAgIGNvbnN0IGdldEtleSA9IFJlYWN0LnVzZUNhbGxiYWNrKCgpID0+IG5hdmlnYXRvcktleVJlZi5jdXJyZW50LCBbXSk7XG5cbiAgICBjb25zdCBzZXRLZXkgPSBSZWFjdC51c2VDYWxsYmFjaygoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIG5hdmlnYXRvcktleVJlZi5jdXJyZW50ID0ga2V5O1xuICAgIH0sIFtdKTtcblxuICAgIGNvbnN0IHBlcmZvcm1UcmFuc2FjdGlvbiA9IFJlYWN0LnVzZUNhbGxiYWNrKChjYWxsYmFjazogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgaWYgKGlzVHJhbnNhY3Rpb25BY3RpdmVSZWYuY3VycmVudCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgXCJPbmx5IG9uZSB0cmFuc2FjdGlvbiBjYW4gYmUgYWN0aXZlIGF0IGEgdGltZS4gRGlkIHlvdSBhY2NpZGVudGFsbHkgbmVzdCAncGVyZm9ybVRyYW5zYWN0aW9uJz9cIlxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBzZXROYXZpZ2F0aW9uU3RhdGUoKG5hdmlnYXRpb25TdGF0ZTogU3RhdGUpID0+IHtcbiAgICAgICAgaXNUcmFuc2FjdGlvbkFjdGl2ZVJlZi5jdXJyZW50ID0gdHJ1ZTtcbiAgICAgICAgdHJhbnNhY3Rpb25TdGF0ZVJlZi5jdXJyZW50ID0gbmF2aWdhdGlvblN0YXRlO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBpc1RyYW5zYWN0aW9uQWN0aXZlUmVmLmN1cnJlbnQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cmFuc2FjdGlvblN0YXRlUmVmLmN1cnJlbnQ7XG4gICAgICB9KTtcbiAgICB9LCBbXSk7XG5cbiAgICBjb25zdCBnZXRTdGF0ZSA9IFJlYWN0LnVzZUNhbGxiYWNrKFxuICAgICAgKCkgPT5cbiAgICAgICAgdHJhbnNhY3Rpb25TdGF0ZVJlZi5jdXJyZW50ICE9PSBudWxsXG4gICAgICAgICAgPyB0cmFuc2FjdGlvblN0YXRlUmVmLmN1cnJlbnRcbiAgICAgICAgICA6IG5hdmlnYXRpb25TdGF0ZVJlZi5jdXJyZW50LFxuICAgICAgW11cbiAgICApO1xuXG4gICAgY29uc3Qgc2V0U3RhdGUgPSBSZWFjdC51c2VDYWxsYmFjaygobmF2aWdhdGlvblN0YXRlOiBTdGF0ZSkgPT4ge1xuICAgICAgaWYgKHRyYW5zYWN0aW9uU3RhdGVSZWYuY3VycmVudCA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgXCJBbnkgJ3NldFN0YXRlJyBjYWxscyBuZWVkIHRvIGJlIGRvbmUgaW5zaWRlICdwZXJmb3JtVHJhbnNhY3Rpb24nXCJcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdHJhbnNhY3Rpb25TdGF0ZVJlZi5jdXJyZW50ID0gbmF2aWdhdGlvblN0YXRlO1xuICAgIH0sIFtdKTtcblxuICAgIGNvbnN0IHJlc2V0ID0gUmVhY3QudXNlQ2FsbGJhY2soXG4gICAgICAoc3RhdGU6IE5hdmlnYXRpb25TdGF0ZSkgPT4ge1xuICAgICAgICBwZXJmb3JtVHJhbnNhY3Rpb24oKCkgPT4ge1xuICAgICAgICAgIHNraXBUcmFja2luZ1JlZi5jdXJyZW50ID0gdHJ1ZTtcbiAgICAgICAgICBzZXRTdGF0ZShzdGF0ZSk7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIFtwZXJmb3JtVHJhbnNhY3Rpb24sIHNldFN0YXRlXVxuICAgICk7XG5cbiAgICBjb25zdCB7IHRyYWNrU3RhdGUsIHRyYWNrQWN0aW9uIH0gPSB1c2VEZXZUb29scyh7XG4gICAgICBuYW1lOiAnQHJlYWN0LW5hdmlnYXRpb24nLFxuICAgICAgcmVzZXQsXG4gICAgICBzdGF0ZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHtcbiAgICAgIGxpc3RlbmVycyxcbiAgICAgIGFkZExpc3RlbmVyOiBhZGRGb2N1c2VkTGlzdGVuZXIsXG4gICAgfSA9IHVzZUZvY3VzZWRMaXN0ZW5lcnMoKTtcblxuICAgIGNvbnN0IHsgZ2V0U3RhdGVGb3JSb3V0ZSwgYWRkU3RhdGVHZXR0ZXIgfSA9IHVzZVN0YXRlR2V0dGVycygpO1xuXG4gICAgY29uc3QgZGlzcGF0Y2ggPSAoXG4gICAgICBhY3Rpb246IE5hdmlnYXRpb25BY3Rpb24gfCAoKHN0YXRlOiBOYXZpZ2F0aW9uU3RhdGUpID0+IE5hdmlnYXRpb25BY3Rpb24pXG4gICAgKSA9PiB7XG4gICAgICBpZiAobGlzdGVuZXJzWzBdID09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKE5PVF9JTklUSUFMSVpFRF9FUlJPUik7XG4gICAgICB9XG5cbiAgICAgIGxpc3RlbmVyc1swXShuYXZpZ2F0aW9uID0+IG5hdmlnYXRpb24uZGlzcGF0Y2goYWN0aW9uKSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGNhbkdvQmFjayA9ICgpID0+IHtcbiAgICAgIGlmIChsaXN0ZW5lcnNbMF0gPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgcmVzdWx0LCBoYW5kbGVkIH0gPSBsaXN0ZW5lcnNbMF0obmF2aWdhdGlvbiA9PlxuICAgICAgICBuYXZpZ2F0aW9uLmNhbkdvQmFjaygpXG4gICAgICApO1xuXG4gICAgICBpZiAoaGFuZGxlZCkge1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCByZXNldFJvb3QgPSBSZWFjdC51c2VDYWxsYmFjayhcbiAgICAgIChzdGF0ZT86IFBhcnRpYWxTdGF0ZTxOYXZpZ2F0aW9uU3RhdGU+IHwgTmF2aWdhdGlvblN0YXRlKSA9PiB7XG4gICAgICAgIHBlcmZvcm1UcmFuc2FjdGlvbigoKSA9PiB7XG4gICAgICAgICAgdHJhY2tBY3Rpb24oJ0BAUkVTRVRfUk9PVCcpO1xuICAgICAgICAgIHNldFN0YXRlKHN0YXRlKTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAgW3BlcmZvcm1UcmFuc2FjdGlvbiwgc2V0U3RhdGUsIHRyYWNrQWN0aW9uXVxuICAgICk7XG5cbiAgICBjb25zdCBnZXRSb290U3RhdGUgPSBSZWFjdC51c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgICByZXR1cm4gZ2V0U3RhdGVGb3JSb3V0ZSgncm9vdCcpO1xuICAgIH0sIFtnZXRTdGF0ZUZvclJvdXRlXSk7XG5cbiAgICBjb25zdCBlbWl0dGVyID0gdXNlRXZlbnRFbWl0dGVyKCk7XG5cbiAgICBSZWFjdC51c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgKCkgPT4gKHtcbiAgICAgIC4uLihPYmplY3Qua2V5cyhDb21tb25BY3Rpb25zKSBhcyAoa2V5b2YgdHlwZW9mIENvbW1vbkFjdGlvbnMpW10pLnJlZHVjZTxcbiAgICAgICAgYW55XG4gICAgICA+KChhY2MsIG5hbWUpID0+IHtcbiAgICAgICAgYWNjW25hbWVdID0gKC4uLmFyZ3M6IGFueVtdKSA9PlxuICAgICAgICAgIGRpc3BhdGNoKFxuICAgICAgICAgICAgQ29tbW9uQWN0aW9uc1tuYW1lXShcbiAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAuLi5hcmdzXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIHt9KSxcbiAgICAgIC4uLmVtaXR0ZXIuY3JlYXRlKCdyb290JyksXG4gICAgICByZXNldFJvb3QsXG4gICAgICBkaXNwYXRjaCxcbiAgICAgIGNhbkdvQmFjayxcbiAgICAgIGdldFJvb3RTdGF0ZSxcbiAgICB9KSk7XG5cbiAgICBjb25zdCBidWlsZGVyQ29udGV4dCA9IFJlYWN0LnVzZU1lbW8oXG4gICAgICAoKSA9PiAoe1xuICAgICAgICBhZGRGb2N1c2VkTGlzdGVuZXIsXG4gICAgICAgIGFkZFN0YXRlR2V0dGVyLFxuICAgICAgICB0cmFja0FjdGlvbixcbiAgICAgIH0pLFxuICAgICAgW2FkZEZvY3VzZWRMaXN0ZW5lciwgdHJhY2tBY3Rpb24sIGFkZFN0YXRlR2V0dGVyXVxuICAgICk7XG5cbiAgICBjb25zdCBjb250ZXh0ID0gUmVhY3QudXNlTWVtbyhcbiAgICAgICgpID0+ICh7XG4gICAgICAgIHN0YXRlLFxuICAgICAgICBwZXJmb3JtVHJhbnNhY3Rpb24sXG4gICAgICAgIGdldFN0YXRlLFxuICAgICAgICBzZXRTdGF0ZSxcbiAgICAgICAgZ2V0S2V5LFxuICAgICAgICBzZXRLZXksXG4gICAgICB9KSxcbiAgICAgIFtnZXRLZXksIGdldFN0YXRlLCBwZXJmb3JtVHJhbnNhY3Rpb24sIHNldEtleSwgc2V0U3RhdGUsIHN0YXRlXVxuICAgICk7XG5cbiAgICBSZWFjdC51c2VFZmZlY3QoKCkgPT4ge1xuICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHN0YXRlICE9PSB1bmRlZmluZWQgJiZcbiAgICAgICAgICAhaXNTZXJpYWxpemFibGUoc3RhdGUpICYmXG4gICAgICAgICAgIWhhc1dhcm5lZEZvclNlcmlhbGl6YXRpb25cbiAgICAgICAgKSB7XG4gICAgICAgICAgaGFzV2FybmVkRm9yU2VyaWFsaXphdGlvbiA9IHRydWU7XG5cbiAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICBcIldlIGZvdW5kIG5vbi1zZXJpYWxpemFibGUgdmFsdWVzIGluIHRoZSBuYXZpZ2F0aW9uIHN0YXRlLCB3aGljaCBjYW4gYnJlYWsgdXNhZ2Ugc3VjaCBhcyBwZXJzaXN0aW5nIGFuZCByZXN0b3Jpbmcgc3RhdGUuIFRoaXMgbWlnaHQgaGFwcGVuIGlmIHlvdSBwYXNzZWQgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZXMgc3VjaCBhcyBmdW5jdGlvbiwgY2xhc3MgaW5zdGFuY2VzIGV0Yy4gaW4gcGFyYW1zLiBJZiB5b3UgbmVlZCB0byB1c2UgY29tcG9uZW50cyB3aXRoIGNhbGxiYWNrcyBpbiB5b3VyIG9wdGlvbnMsIHlvdSBjYW4gdXNlICduYXZpZ2F0aW9uLnNldE9wdGlvbnMnIGluc3RlYWQuIFNlZSBodHRwczovL3JlYWN0bmF2aWdhdGlvbi5vcmcvZG9jcy9lbi90cm91Ymxlc2hvb3RpbmcuaHRtbCNpLWdldC10aGUtd2FybmluZy13ZS1mb3VuZC1ub24tc2VyaWFsaXphYmxlLXZhbHVlcy1pbi10aGUtbmF2aWdhdGlvbi1zdGF0ZSBmb3IgbW9yZSBkZXRhaWxzLlwiXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBlbWl0dGVyLmVtaXQoe1xuICAgICAgICB0eXBlOiAnc3RhdGUnLFxuICAgICAgICBkYXRhOiB7IHN0YXRlIH0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKHNraXBUcmFja2luZ1JlZi5jdXJyZW50KSB7XG4gICAgICAgIHNraXBUcmFja2luZ1JlZi5jdXJyZW50ID0gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cmFja1N0YXRlKGdldFJvb3RTdGF0ZSk7XG4gICAgICB9XG5cbiAgICAgIG5hdmlnYXRpb25TdGF0ZVJlZi5jdXJyZW50ID0gc3RhdGU7XG4gICAgICB0cmFuc2FjdGlvblN0YXRlUmVmLmN1cnJlbnQgPSBudWxsO1xuXG4gICAgICBpZiAoIWlzRmlyc3RNb3VudFJlZi5jdXJyZW50ICYmIG9uU3RhdGVDaGFuZ2UpIHtcbiAgICAgICAgb25TdGF0ZUNoYW5nZShnZXRSb290U3RhdGUoKSk7XG4gICAgICB9XG5cbiAgICAgIGlzRmlyc3RNb3VudFJlZi5jdXJyZW50ID0gZmFsc2U7XG4gICAgfSwgW3N0YXRlLCBvblN0YXRlQ2hhbmdlLCB0cmFja1N0YXRlLCBnZXRSb290U3RhdGUsIGVtaXR0ZXJdKTtcblxuICAgIHJldHVybiAoXG4gICAgICA8TmF2aWdhdGlvbkJ1aWxkZXJDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXtidWlsZGVyQ29udGV4dH0+XG4gICAgICAgIDxOYXZpZ2F0aW9uU3RhdGVDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXtjb250ZXh0fT5cbiAgICAgICAgICA8RW5zdXJlU2luZ2xlTmF2aWdhdG9yPntjaGlsZHJlbn08L0Vuc3VyZVNpbmdsZU5hdmlnYXRvcj5cbiAgICAgICAgPC9OYXZpZ2F0aW9uU3RhdGVDb250ZXh0LlByb3ZpZGVyPlxuICAgICAgPC9OYXZpZ2F0aW9uQnVpbGRlckNvbnRleHQuUHJvdmlkZXI+XG4gICAgKTtcbiAgfVxuKTtcblxuZXhwb3J0IGRlZmF1bHQgQmFzZU5hdmlnYXRpb25Db250YWluZXI7XG4iXX0=
e45dc5fe505230cea32a14a2b5768b68
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _wrapNativeSuper2 = _interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper"));

var SyntheticError = function (_Error) {
  (0, _inherits2.default)(SyntheticError, _Error);

  function SyntheticError() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2.default)(this, SyntheticError);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2.default)(this, (_getPrototypeOf2 = (0, _getPrototypeOf3.default)(SyntheticError)).call.apply(_getPrototypeOf2, [this].concat(args)));
    _this.name = '';
    return _this;
  }

  return SyntheticError;
}((0, _wrapNativeSuper2.default)(Error));

var exceptionID = 0;

function reportException(e, isFatal) {
  var NativeExceptionsManager = require("./NativeExceptionsManager").default;

  if (NativeExceptionsManager) {
    var parseErrorStack = require("./Devtools/parseErrorStack");

    var stack = parseErrorStack(e);
    var currentExceptionID = ++exceptionID;
    var originalMessage = e.message || '';
    var message = originalMessage;

    if (e.componentStack != null) {
      message += "\n\nThis error is located at:" + e.componentStack;
    }

    var namePrefix = e.name == null || e.name === '' ? '' : e.name + ": ";
    var isFromConsoleError = e.name === 'console.error';

    if (!message.startsWith(namePrefix)) {
      message = namePrefix + message;
    }

    if (!isFromConsoleError) {
      if (console._errorOriginal) {
        console._errorOriginal(message);
      } else {
        console.error(message);
      }
    }

    message = e.jsEngine == null ? message : message + ", js engine: " + e.jsEngine;
    NativeExceptionsManager.reportException({
      message: message,
      originalMessage: message === originalMessage ? null : originalMessage,
      name: e.name == null || e.name === '' ? null : e.name,
      componentStack: typeof e.componentStack === 'string' ? e.componentStack : null,
      stack: stack,
      id: currentExceptionID,
      isFatal: isFatal,
      extraData: {
        jsEngine: e.jsEngine,
        rawStack: e.stack,
        framesPopped: e.framesToPop
      }
    });

    if (__DEV__) {
      if (e.preventSymbolication === true) {
        return;
      }

      var symbolicateStackTrace = require("./Devtools/symbolicateStackTrace");

      symbolicateStackTrace(stack).then(function (prettyStack) {
        if (prettyStack) {
          var stackWithoutCollapsedFrames = prettyStack.filter(function (frame) {
            return !frame.collapse;
          });
          NativeExceptionsManager.updateExceptionMessage(message, stackWithoutCollapsedFrames, currentExceptionID);
        } else {
          throw new Error('The stack is null');
        }
      }).catch(function (error) {
        console.log('Unable to symbolicate stack trace: ' + error.message);
      });
    }
  }
}

function handleException(e, isFatal) {
  var error;

  if (e instanceof Error) {
    error = e;
  } else {
    error = new SyntheticError(e);
  }

  reportException(error, isFatal);
}

function reactConsoleErrorHandler() {
  if (!console.reportErrorsAsExceptions) {
    console._errorOriginal.apply(console, arguments);

    return;
  }

  if (arguments[0] && arguments[0].stack) {
    reportException(arguments[0], false);
  } else {
    console._errorOriginal.apply(console, arguments);

    var stringifySafe = require("../Utilities/stringifySafe");

    var str = Array.prototype.map.call(arguments, stringifySafe).join(', ');

    if (str.slice(0, 10) === '"Warning: ') {
      return;
    }

    var _error = new SyntheticError(str);

    _error.name = 'console.error';
    _error.framesToPop = (_error.framesToPop || 0) + 1;
    reportException(_error, false);
  }
}

function installConsoleErrorReporter() {
  if (console._errorOriginal) {
    return;
  }

  console._errorOriginal = console.error.bind(console);
  console.error = reactConsoleErrorHandler;

  if (console.reportErrorsAsExceptions === undefined) {
    console.reportErrorsAsExceptions = true;
  }
}

module.exports = {
  handleException: handleException,
  installConsoleErrorReporter: installConsoleErrorReporter,
  SyntheticError: SyntheticError
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkV4Y2VwdGlvbnNNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIlN5bnRoZXRpY0Vycm9yIiwibmFtZSIsIkVycm9yIiwiZXhjZXB0aW9uSUQiLCJyZXBvcnRFeGNlcHRpb24iLCJlIiwiaXNGYXRhbCIsIk5hdGl2ZUV4Y2VwdGlvbnNNYW5hZ2VyIiwicmVxdWlyZSIsImRlZmF1bHQiLCJwYXJzZUVycm9yU3RhY2siLCJzdGFjayIsImN1cnJlbnRFeGNlcHRpb25JRCIsIm9yaWdpbmFsTWVzc2FnZSIsIm1lc3NhZ2UiLCJjb21wb25lbnRTdGFjayIsIm5hbWVQcmVmaXgiLCJpc0Zyb21Db25zb2xlRXJyb3IiLCJzdGFydHNXaXRoIiwiY29uc29sZSIsIl9lcnJvck9yaWdpbmFsIiwiZXJyb3IiLCJqc0VuZ2luZSIsImlkIiwiZXh0cmFEYXRhIiwicmF3U3RhY2siLCJmcmFtZXNQb3BwZWQiLCJmcmFtZXNUb1BvcCIsIl9fREVWX18iLCJwcmV2ZW50U3ltYm9saWNhdGlvbiIsInN5bWJvbGljYXRlU3RhY2tUcmFjZSIsInRoZW4iLCJwcmV0dHlTdGFjayIsInN0YWNrV2l0aG91dENvbGxhcHNlZEZyYW1lcyIsImZpbHRlciIsImZyYW1lIiwiY29sbGFwc2UiLCJ1cGRhdGVFeGNlcHRpb25NZXNzYWdlIiwiY2F0Y2giLCJsb2ciLCJoYW5kbGVFeGNlcHRpb24iLCJyZWFjdENvbnNvbGVFcnJvckhhbmRsZXIiLCJyZXBvcnRFcnJvcnNBc0V4Y2VwdGlvbnMiLCJhcHBseSIsImFyZ3VtZW50cyIsInN0cmluZ2lmeVNhZmUiLCJzdHIiLCJBcnJheSIsInByb3RvdHlwZSIsIm1hcCIsImNhbGwiLCJqb2luIiwic2xpY2UiLCJpbnN0YWxsQ29uc29sZUVycm9yUmVwb3J0ZXIiLCJiaW5kIiwidW5kZWZpbmVkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBVUE7Ozs7Ozs7Ozs7Ozs7O0lBSU1BLGM7Ozs7Ozs7Ozs7Ozs7OztVQUNKQyxJLEdBQWUsRTs7Ozs7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UCxHQUFpQjtBQUFDakIsRUFBQUEsZUFBZSxFQUFmQSxlQUFEO0FBQWtCYSxFQUFBQSwyQkFBMkIsRUFBM0JBLDJCQUFsQjtBQUErQ3JELEVBQUFBLGNBQWMsRUFBZEE7QUFBL0MsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmb3JtYXRcbiAqIEBmbG93IHN0cmljdC1sb2NhbFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IHR5cGUge0V4dGVuZGVkRXJyb3J9IGZyb20gJy4vRGV2dG9vbHMvcGFyc2VFcnJvclN0YWNrJztcblxuY2xhc3MgU3ludGhldGljRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIG5hbWU6IHN0cmluZyA9ICcnO1xufVxuXG4vKipcbiAqIEhhbmRsZXMgdGhlIGRldmVsb3Blci12aXNpYmxlIGFzcGVjdCBvZiBlcnJvcnMgYW5kIGV4Y2VwdGlvbnNcbiAqL1xubGV0IGV4Y2VwdGlvbklEID0gMDtcbmZ1bmN0aW9uIHJlcG9ydEV4Y2VwdGlvbihlOiBFeHRlbmRlZEVycm9yLCBpc0ZhdGFsOiBib29sZWFuKSB7XG4gIGNvbnN0IE5hdGl2ZUV4Y2VwdGlvbnNNYW5hZ2VyID0gcmVxdWlyZSgnLi9OYXRpdmVFeGNlcHRpb25zTWFuYWdlcicpLmRlZmF1bHQ7XG4gIGlmIChOYXRpdmVFeGNlcHRpb25zTWFuYWdlcikge1xuICAgIGNvbnN0IHBhcnNlRXJyb3JTdGFjayA9IHJlcXVpcmUoJy4vRGV2dG9vbHMvcGFyc2VFcnJvclN0YWNrJyk7XG4gICAgY29uc3Qgc3RhY2sgPSBwYXJzZUVycm9yU3RhY2soZSk7XG4gICAgY29uc3QgY3VycmVudEV4Y2VwdGlvbklEID0gKytleGNlcHRpb25JRDtcbiAgICBjb25zdCBvcmlnaW5hbE1lc3NhZ2UgPSBlLm1lc3NhZ2UgfHwgJyc7XG4gICAgbGV0IG1lc3NhZ2UgPSBvcmlnaW5hbE1lc3NhZ2U7XG4gICAgaWYgKGUuY29tcG9uZW50U3RhY2sgIT0gbnVsbCkge1xuICAgICAgbWVzc2FnZSArPSBgXFxuXFxuVGhpcyBlcnJvciBpcyBsb2NhdGVkIGF0OiR7ZS5jb21wb25lbnRTdGFja31gO1xuICAgIH1cbiAgICBjb25zdCBuYW1lUHJlZml4ID0gZS5uYW1lID09IG51bGwgfHwgZS5uYW1lID09PSAnJyA/ICcnIDogYCR7ZS5uYW1lfTogYDtcbiAgICBjb25zdCBpc0Zyb21Db25zb2xlRXJyb3IgPSBlLm5hbWUgPT09ICdjb25zb2xlLmVycm9yJztcblxuICAgIGlmICghbWVzc2FnZS5zdGFydHNXaXRoKG5hbWVQcmVmaXgpKSB7XG4gICAgICBtZXNzYWdlID0gbmFtZVByZWZpeCArIG1lc3NhZ2U7XG4gICAgfVxuXG4gICAgLy8gRXJyb3JzIGNyZWF0ZWQgYnkgYGNvbnNvbGUuZXJyb3JgIGhhdmUgYWxyZWFkeSBiZWVuIHByaW50ZWQuXG4gICAgaWYgKCFpc0Zyb21Db25zb2xlRXJyb3IpIHtcbiAgICAgIGlmIChjb25zb2xlLl9lcnJvck9yaWdpbmFsKSB7XG4gICAgICAgIGNvbnNvbGUuX2Vycm9yT3JpZ2luYWwobWVzc2FnZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cblxuICAgIG1lc3NhZ2UgPVxuICAgICAgZS5qc0VuZ2luZSA9PSBudWxsID8gbWVzc2FnZSA6IGAke21lc3NhZ2V9LCBqcyBlbmdpbmU6ICR7ZS5qc0VuZ2luZX1gO1xuICAgIE5hdGl2ZUV4Y2VwdGlvbnNNYW5hZ2VyLnJlcG9ydEV4Y2VwdGlvbih7XG4gICAgICBtZXNzYWdlLFxuICAgICAgb3JpZ2luYWxNZXNzYWdlOiBtZXNzYWdlID09PSBvcmlnaW5hbE1lc3NhZ2UgPyBudWxsIDogb3JpZ2luYWxNZXNzYWdlLFxuICAgICAgbmFtZTogZS5uYW1lID09IG51bGwgfHwgZS5uYW1lID09PSAnJyA/IG51bGwgOiBlLm5hbWUsXG4gICAgICBjb21wb25lbnRTdGFjazpcbiAgICAgICAgdHlwZW9mIGUuY29tcG9uZW50U3RhY2sgPT09ICdzdHJpbmcnID8gZS5jb21wb25lbnRTdGFjayA6IG51bGwsXG4gICAgICBzdGFjayxcbiAgICAgIGlkOiBjdXJyZW50RXhjZXB0aW9uSUQsXG4gICAgICBpc0ZhdGFsLFxuICAgICAgZXh0cmFEYXRhOiB7XG4gICAgICAgIGpzRW5naW5lOiBlLmpzRW5naW5lLFxuICAgICAgICByYXdTdGFjazogZS5zdGFjayxcbiAgICAgICAgZnJhbWVzUG9wcGVkOiBlLmZyYW1lc1RvUG9wLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBpZiAoX19ERVZfXykge1xuICAgICAgaWYgKGUucHJldmVudFN5bWJvbGljYXRpb24gPT09IHRydWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3Qgc3ltYm9saWNhdGVTdGFja1RyYWNlID0gcmVxdWlyZSgnLi9EZXZ0b29scy9zeW1ib2xpY2F0ZVN0YWNrVHJhY2UnKTtcbiAgICAgIHN5bWJvbGljYXRlU3RhY2tUcmFjZShzdGFjaylcbiAgICAgICAgLnRoZW4ocHJldHR5U3RhY2sgPT4ge1xuICAgICAgICAgIGlmIChwcmV0dHlTdGFjaykge1xuICAgICAgICAgICAgY29uc3Qgc3RhY2tXaXRob3V0Q29sbGFwc2VkRnJhbWVzID0gcHJldHR5U3RhY2suZmlsdGVyKFxuICAgICAgICAgICAgICBmcmFtZSA9PiAhZnJhbWUuY29sbGFwc2UsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgTmF0aXZlRXhjZXB0aW9uc01hbmFnZXIudXBkYXRlRXhjZXB0aW9uTWVzc2FnZShcbiAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgc3RhY2tXaXRob3V0Q29sbGFwc2VkRnJhbWVzLFxuICAgICAgICAgICAgICBjdXJyZW50RXhjZXB0aW9uSUQsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBzdGFjayBpcyBudWxsJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdVbmFibGUgdG8gc3ltYm9saWNhdGUgc3RhY2sgdHJhY2U6ICcgKyBlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG59XG5cbmRlY2xhcmUgdmFyIGNvbnNvbGU6IHR5cGVvZiBjb25zb2xlICYge1xuICBfZXJyb3JPcmlnaW5hbDogdHlwZW9mIGNvbnNvbGUuZXJyb3IsXG4gIHJlcG9ydEVycm9yc0FzRXhjZXB0aW9uczogYm9vbGVhbixcbn07XG5cbi8qKlxuICogTG9ncyBleGNlcHRpb25zIHRvIHRoZSAobmF0aXZlKSBjb25zb2xlIGFuZCBkaXNwbGF5cyB0aGVtXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZUV4Y2VwdGlvbihlOiBtaXhlZCwgaXNGYXRhbDogYm9vbGVhbikge1xuICBsZXQgZXJyb3I6IEVycm9yO1xuICBpZiAoZSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgZXJyb3IgPSBlO1xuICB9IGVsc2Uge1xuICAgIC8vIFdvcmthcm91bmQgZm9yIHJlcG9ydGluZyBlcnJvcnMgY2F1c2VkIGJ5IGB0aHJvdyAnc29tZSBzdHJpbmcnYFxuICAgIC8vIFVuZm9ydHVuYXRlbHkgdGhlcmUgaXMgbm8gd2F5IHRvIGZpZ3VyZSBvdXQgdGhlIHN0YWNrdHJhY2UgaW4gdGhpc1xuICAgIC8vIGNhc2UsIHNvIGlmIHlvdSBlbmRlZCB1cCBoZXJlIHRyeWluZyB0byB0cmFjZSBhbiBlcnJvciwgbG9vayBmb3JcbiAgICAvLyBgdGhyb3cgJzxlcnJvciBtZXNzYWdlPidgIHNvbWV3aGVyZSBpbiB5b3VyIGNvZGViYXNlLlxuICAgIGVycm9yID0gbmV3IFN5bnRoZXRpY0Vycm9yKGUpO1xuICB9XG4gIHJlcG9ydEV4Y2VwdGlvbihlcnJvciwgaXNGYXRhbCk7XG59XG5cbmZ1bmN0aW9uIHJlYWN0Q29uc29sZUVycm9ySGFuZGxlcigpIHtcbiAgaWYgKCFjb25zb2xlLnJlcG9ydEVycm9yc0FzRXhjZXB0aW9ucykge1xuICAgIGNvbnNvbGUuX2Vycm9yT3JpZ2luYWwuYXBwbHkoY29uc29sZSwgYXJndW1lbnRzKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoYXJndW1lbnRzWzBdICYmIGFyZ3VtZW50c1swXS5zdGFjaykge1xuICAgIC8vIHJlcG9ydEV4Y2VwdGlvbiB3aWxsIGNvbnNvbGUuZXJyb3IgdGhpcyB3aXRoIGhpZ2ggZW5vdWdoIGZpZGVsaXR5LlxuICAgIHJlcG9ydEV4Y2VwdGlvbihhcmd1bWVudHNbMF0sIC8qIGlzRmF0YWwgKi8gZmFsc2UpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuX2Vycm9yT3JpZ2luYWwuYXBwbHkoY29uc29sZSwgYXJndW1lbnRzKTtcbiAgICBjb25zdCBzdHJpbmdpZnlTYWZlID0gcmVxdWlyZSgnLi4vVXRpbGl0aWVzL3N0cmluZ2lmeVNhZmUnKTtcbiAgICBjb25zdCBzdHIgPSBBcnJheS5wcm90b3R5cGUubWFwLmNhbGwoYXJndW1lbnRzLCBzdHJpbmdpZnlTYWZlKS5qb2luKCcsICcpO1xuICAgIGlmIChzdHIuc2xpY2UoMCwgMTApID09PSAnXCJXYXJuaW5nOiAnKSB7XG4gICAgICAvLyBSZWFjdCB3YXJuaW5ncyB1c2UgY29uc29sZS5lcnJvciBzbyB0aGF0IGEgc3RhY2sgdHJhY2UgaXMgc2hvd24sIGJ1dFxuICAgICAgLy8gd2UgZG9uJ3QgKGN1cnJlbnRseSkgd2FudCB0aGVzZSB0byBzaG93IGEgcmVkYm94XG4gICAgICAvLyAoTm90ZTogTG9naWMgZHVwbGljYXRlZCBpbiBwb2x5ZmlsbHMvY29uc29sZS5qcy4pXG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGVycm9yOiBFeHRlbmRlZEVycm9yID0gbmV3IFN5bnRoZXRpY0Vycm9yKHN0cik7XG4gICAgZXJyb3IubmFtZSA9ICdjb25zb2xlLmVycm9yJztcbiAgICBlcnJvci5mcmFtZXNUb1BvcCA9IChlcnJvci5mcmFtZXNUb1BvcCB8fCAwKSArIDE7XG4gICAgcmVwb3J0RXhjZXB0aW9uKGVycm9yLCAvKiBpc0ZhdGFsICovIGZhbHNlKTtcbiAgfVxufVxuXG4vKipcbiAqIFNob3dzIGEgcmVkYm94IHdpdGggc3RhY2t0cmFjZSBmb3IgYWxsIGNvbnNvbGUuZXJyb3IgbWVzc2FnZXMuICBEaXNhYmxlIGJ5XG4gKiBzZXR0aW5nIGBjb25zb2xlLnJlcG9ydEVycm9yc0FzRXhjZXB0aW9ucyA9IGZhbHNlO2AgaW4geW91ciBhcHAuXG4gKi9cbmZ1bmN0aW9uIGluc3RhbGxDb25zb2xlRXJyb3JSZXBvcnRlcigpIHtcbiAgLy8gRW5hYmxlIHJlcG9ydEVycm9yc0FzRXhjZXB0aW9uc1xuICBpZiAoY29uc29sZS5fZXJyb3JPcmlnaW5hbCkge1xuICAgIHJldHVybjsgLy8gYWxyZWFkeSBpbnN0YWxsZWRcbiAgfVxuICAvLyBGbG93IGRvZXNuJ3QgbGlrZSBpdCB3aGVuIHlvdSBzZXQgYXJiaXRyYXJ5IHZhbHVlcyBvbiBhIGdsb2JhbCBvYmplY3RcbiAgY29uc29sZS5fZXJyb3JPcmlnaW5hbCA9IGNvbnNvbGUuZXJyb3IuYmluZChjb25zb2xlKTtcbiAgY29uc29sZS5lcnJvciA9IHJlYWN0Q29uc29sZUVycm9ySGFuZGxlcjtcbiAgaWYgKGNvbnNvbGUucmVwb3J0RXJyb3JzQXNFeGNlcHRpb25zID09PSB1bmRlZmluZWQpIHtcbiAgICAvLyBJbmRpdmlkdWFsIGFwcHMgY2FuIGRpc2FibGUgdGhpc1xuICAgIC8vIEZsb3cgZG9lc24ndCBsaWtlIGl0IHdoZW4geW91IHNldCBhcmJpdHJhcnkgdmFsdWVzIG9uIGEgZ2xvYmFsIG9iamVjdFxuICAgIGNvbnNvbGUucmVwb3J0RXJyb3JzQXNFeGNlcHRpb25zID0gdHJ1ZTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtoYW5kbGVFeGNlcHRpb24sIGluc3RhbGxDb25zb2xlRXJyb3JSZXBvcnRlciwgU3ludGhldGljRXJyb3J9O1xuIl19
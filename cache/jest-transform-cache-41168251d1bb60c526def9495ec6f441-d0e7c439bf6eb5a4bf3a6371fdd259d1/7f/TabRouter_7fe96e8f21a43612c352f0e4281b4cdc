46b3ba8eb46c7f162b4855cf3f8a234f
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = TabRouter;
exports.TabActions = void 0;

var _shortid = _interopRequireDefault(require("shortid"));

var _BaseRouter = _interopRequireDefault(require("./BaseRouter"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

var TYPE_ROUTE = 'route';
var TabActions = {
  jumpTo: function jumpTo(name, params) {
    return {
      type: 'JUMP_TO',
      payload: {
        name: name,
        params: params
      }
    };
  }
};
exports.TabActions = TabActions;

var getRouteHistory = function getRouteHistory(routes, index, backBehavior) {
  var history = [{
    type: TYPE_ROUTE,
    key: routes[index].key
  }];

  switch (backBehavior) {
    case 'initialRoute':
      if (index !== 0) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[0].key
        });
      }

      break;

    case 'order':
      for (var i = index; i > 0; i--) {
        history.unshift({
          type: TYPE_ROUTE,
          key: routes[i - 1].key
        });
      }

      break;

    case 'history':
      break;
  }

  return history;
};

var changeIndex = function changeIndex(state, index, backBehavior) {
  var history;

  if (backBehavior === 'history') {
    var currentKey = state.routes[index].key;
    history = state.history.filter(function (it) {
      return it.type === 'route' ? it.key !== currentKey : false;
    }).concat({
      type: TYPE_ROUTE,
      key: currentKey
    });
  } else {
    history = getRouteHistory(state.routes, index, backBehavior);
  }

  return _objectSpread({}, state, {
    index: index,
    history: history
  });
};

function TabRouter(_ref) {
  var initialRouteName = _ref.initialRouteName,
      _ref$backBehavior = _ref.backBehavior,
      backBehavior = _ref$backBehavior === void 0 ? 'history' : _ref$backBehavior;

  var router = _objectSpread({}, _BaseRouter.default, {
    type: 'tab',
    getInitialState: function getInitialState(_ref2) {
      var routeNames = _ref2.routeNames,
          routeParamList = _ref2.routeParamList;
      var index = initialRouteName !== undefined && routeNames.includes(initialRouteName) ? routeNames.indexOf(initialRouteName) : 0;
      var routes = routeNames.map(function (name) {
        return {
          name: name,
          key: "".concat(name, "-").concat((0, _shortid.default)()),
          params: routeParamList[name]
        };
      });
      var history = getRouteHistory(routes, index, backBehavior);
      return {
        stale: false,
        type: 'tab',
        key: "tab-".concat((0, _shortid.default)()),
        index: index,
        routeNames: routeNames,
        history: history,
        routes: routes
      };
    },
    getRehydratedState: function getRehydratedState(partialState, _ref3) {
      var _state$history, _history;

      var routeNames = _ref3.routeNames,
          routeParamList = _ref3.routeParamList;
      var state = partialState;

      if (state.stale === false) {
        return state;
      }

      var routes = routeNames.map(function (name) {
        var route = state.routes.find(function (r) {
          return r.name === name;
        });
        return _objectSpread({}, route, {
          name: name,
          key: route && route.name === name && route.key ? route.key : "".concat(name, "-").concat((0, _shortid.default)()),
          params: routeParamList[name] !== undefined ? _objectSpread({}, routeParamList[name], {}, route ? route.params : undefined) : route ? route.params : undefined
        });
      });
      var index = Math.min(Math.max(typeof state.index === 'number' ? state.index : routeNames.indexOf(state.routes[0].name), 0), routes.length - 1);
      var history = (_state$history = state.history) === null || _state$history === void 0 ? void 0 : _state$history.filter(function (it) {
        return routes.find(function (r) {
          return r.key === it.key;
        });
      });

      if (!((_history = history) === null || _history === void 0 ? void 0 : _history.length)) {
        history = getRouteHistory(routes, index, backBehavior);
      }

      return {
        stale: false,
        type: 'tab',
        key: "tab-".concat((0, _shortid.default)()),
        index: index,
        routeNames: routeNames,
        history: history,
        routes: routes
      };
    },
    getStateForRouteNamesChange: function getStateForRouteNamesChange(state, _ref4) {
      var routeNames = _ref4.routeNames,
          routeParamList = _ref4.routeParamList;
      var routes = routeNames.map(function (name) {
        return state.routes.find(function (r) {
          return r.name === name;
        }) || {
          name: name,
          key: "".concat(name, "-").concat((0, _shortid.default)()),
          params: routeParamList[name]
        };
      });
      var index = Math.max(0, routeNames.indexOf(state.routes[state.index].name));
      var history = state.history.filter(function (it) {
        return routes.find(function (r) {
          return r.key === it.key;
        });
      });

      if (!history.length) {
        history = getRouteHistory(routes, index, backBehavior);
      }

      return _objectSpread({}, state, {
        history: history,
        routeNames: routeNames,
        routes: routes,
        index: index
      });
    },
    getStateForRouteFocus: function getStateForRouteFocus(state, key) {
      var index = state.routes.findIndex(function (r) {
        return r.key === key;
      });

      if (index === -1 || index === state.index) {
        return state;
      }

      return changeIndex(state, index, backBehavior);
    },
    getStateForAction: function getStateForAction(state, action) {
      switch (action.type) {
        case 'JUMP_TO':
        case 'NAVIGATE':
          {
            var index = -1;

            if (action.type === 'NAVIGATE' && action.payload.key) {
              index = state.routes.findIndex(function (route) {
                return route.key === action.payload.key;
              });
            } else {
              index = state.routes.findIndex(function (route) {
                return route.name === action.payload.name;
              });
            }

            if (index === -1) {
              return null;
            }

            return changeIndex(_objectSpread({}, state, {
              routes: action.payload.params !== undefined ? state.routes.map(function (route, i) {
                return i === index ? _objectSpread({}, route, {
                  params: _objectSpread({}, route.params, {}, action.payload.params)
                }) : route;
              }) : state.routes
            }), index, backBehavior);
          }

        case 'GO_BACK':
          {
            if (state.history.length === 1) {
              return null;
            }

            var previousKey = state.history[state.history.length - 2].key;

            var _index = state.routes.findIndex(function (route) {
              return route.key === previousKey;
            });

            if (_index === -1) {
              return null;
            }

            return _objectSpread({}, state, {
              history: state.history.slice(0, -1),
              index: _index
            });
          }

        default:
          return _BaseRouter.default.getStateForAction(state, action);
      }
    },
    shouldActionChangeFocus: function shouldActionChangeFocus(action) {
      return action.type === 'NAVIGATE';
    },
    actionCreators: TabActions
  });

  return router;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRhYlJvdXRlci50c3giXSwibmFtZXMiOlsiVFlQRV9ST1VURSIsIlRhYkFjdGlvbnMiLCJqdW1wVG8iLCJ0eXBlIiwicGF5bG9hZCIsIm5hbWUiLCJwYXJhbXMiLCJnZXRSb3V0ZUhpc3RvcnkiLCJoaXN0b3J5Iiwia2V5Iiwicm91dGVzIiwiaW5kZXgiLCJpIiwiY2hhbmdlSW5kZXgiLCJiYWNrQmVoYXZpb3IiLCJjdXJyZW50S2V5Iiwic3RhdGUiLCJpdCIsInJvdXRlciIsIkJhc2VSb3V0ZXIiLCJnZXRJbml0aWFsU3RhdGUiLCJyb3V0ZVBhcmFtTGlzdCIsImluaXRpYWxSb3V0ZU5hbWUiLCJyb3V0ZU5hbWVzIiwic3RhbGUiLCJnZXRSZWh5ZHJhdGVkU3RhdGUiLCJyb3V0ZSIsInIiLCJ1bmRlZmluZWQiLCJNYXRoIiwiZ2V0U3RhdGVGb3JSb3V0ZU5hbWVzQ2hhbmdlIiwiZ2V0U3RhdGVGb3JSb3V0ZUZvY3VzIiwiZ2V0U3RhdGVGb3JBY3Rpb24iLCJhY3Rpb24iLCJwcmV2aW91c0tleSIsInNob3VsZEFjdGlvbkNoYW5nZUZvY3VzIiwiYWN0aW9uQ3JlYXRvcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsSUFBQSxRQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLENBQUEsU0FBQSxDQUFBLENBQUE7O0FBQ0EsSUFBQSxXQUFBLEdBQUEsc0JBQUEsQ0FBQSxPQUFBLGdCQUFBLENBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWtDQSxJQUFNQSxVQUFVLEdBQWhCLE9BQUE7QUFFTyxJQUFNQyxVQUFVLEdBQUc7QUFDeEJDLEVBQUFBLE1BRHdCLGtCQUNsQixJQURrQixFQUNsQixNQURrQixFQUM2QjtBQUNuRCxXQUFPO0FBQUVDLE1BQUFBLElBQUksRUFBTixTQUFBO0FBQW1CQyxNQUFBQSxPQUFPLEVBQUU7QUFBRUMsUUFBQUEsSUFBRixFQUFFQSxJQUFGO0FBQVFDLFFBQUFBLE1B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R0ssS0FBSyxDQUFMQSxNQUFBQSxDQUFBQSxTQUFBQSxDQUNaVSxVQUFBQSxLQUFLO0FBQUEscUJBQUlBLEtBQUssQ0FBTEEsR0FBQUEsS0FEWCxXQUNPO0FBQUEsYUFET1YsQ0FBZDs7QUFJQSxnQkFBSUwsTUFBSyxLQUFLLENBQWQsQ0FBQSxFQUFrQjtBQUNoQixxQkFBQSxJQUFBO0FBQ0Q7O0FBRUQsbUJBQUEsYUFBQSxDQUFBLEVBQUEsRUFBQSxLQUFBLEVBQUE7QUFFRUgsY0FBQUEsT0FBTyxFQUFFUSxLQUFLLENBQUxBLE9BQUFBLENBQUFBLEtBQUFBLENBQUFBLENBQUFBLEVBQXVCLENBRmxDLENBRVdBLENBRlg7QUFHRUwsY0FBQUEsS0FBQUEsRUFBQUE7QUFIRixhQUFBLENBQUE7QUFLRDs7QUFFRDtBQUNFLGlCQUFPUSxXQUFBQSxDQUFBQSxPQUFBQSxDQUFBQSxpQkFBQUEsQ0FBQUEsS0FBQUEsRUFBUCxNQUFPQSxDQUFQO0FBaEVKO0FBcklILEtBQUE7QUF5TUNnQixJQUFBQSx1QkF6TUQsbUNBeU13QixNQXpNeEIsRUF5TWlDO0FBQzlCLGFBQU9GLE1BQU0sQ0FBTkEsSUFBQUEsS0FBUCxVQUFBO0FBMU1ILEtBQUE7QUE2TUNHLElBQUFBLGNBQWMsRUFBRW5DO0FBN01qQixHQUFBLENBSEQ7O0FBbU5BLFNBQUEsTUFBQTtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNob3J0aWQgZnJvbSAnc2hvcnRpZCc7XG5pbXBvcnQgQmFzZVJvdXRlciBmcm9tICcuL0Jhc2VSb3V0ZXInO1xuaW1wb3J0IHtcbiAgTmF2aWdhdGlvblN0YXRlLFxuICBQYXJ0aWFsU3RhdGUsXG4gIENvbW1vbk5hdmlnYXRpb25BY3Rpb24sXG4gIFJvdXRlcixcbiAgRGVmYXVsdFJvdXRlck9wdGlvbnMsXG4gIFJvdXRlLFxufSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IHR5cGUgVGFiQWN0aW9uVHlwZSA9IHtcbiAgdHlwZTogJ0pVTVBfVE8nO1xuICBwYXlsb2FkOiB7IG5hbWU6IHN0cmluZzsgcGFyYW1zPzogb2JqZWN0IH07XG4gIHNvdXJjZT86IHN0cmluZztcbiAgdGFyZ2V0Pzogc3RyaW5nO1xufTtcblxuZXhwb3J0IHR5cGUgQmFja0JlaGF2aW9yID0gJ2luaXRpYWxSb3V0ZScgfCAnb3JkZXInIHwgJ2hpc3RvcnknIHwgJ25vbmUnO1xuXG5leHBvcnQgdHlwZSBUYWJSb3V0ZXJPcHRpb25zID0gRGVmYXVsdFJvdXRlck9wdGlvbnMgJiB7XG4gIGJhY2tCZWhhdmlvcj86IEJhY2tCZWhhdmlvcjtcbn07XG5cbmV4cG9ydCB0eXBlIFRhYk5hdmlnYXRpb25TdGF0ZSA9IE9taXQ8TmF2aWdhdGlvblN0YXRlLCAnaGlzdG9yeSc+ICYge1xuICAvKipcbiAgICogVHlwZSBvZiB0aGUgcm91dGVyLCBpbiB0aGlzIGNhc2UsIGl0J3MgdGFiLlxuICAgKi9cbiAgdHlwZTogJ3RhYic7XG4gIC8qKlxuICAgKiBMaXN0IG9mIHByZXZpb3VzbHkgdmlzaXRlZCByb3V0ZSBrZXlzLlxuICAgKi9cbiAgaGlzdG9yeTogeyB0eXBlOiAncm91dGUnOyBrZXk6IHN0cmluZyB9W107XG59O1xuXG5jb25zdCBUWVBFX1JPVVRFID0gJ3JvdXRlJyBhcyBjb25zdDtcblxuZXhwb3J0IGNvbnN0IFRhYkFjdGlvbnMgPSB7XG4gIGp1bXBUbyhuYW1lOiBzdHJpbmcsIHBhcmFtcz86IG9iamVjdCk6IFRhYkFjdGlvblR5cGUge1xuICAgIHJldHVybiB7IHR5cGU6ICdKVU1QX1RPJywgcGF5bG9hZDogeyBuYW1lLCBwYXJhbXMgfSB9O1xuICB9LFxufTtcblxuY29uc3QgZ2V0Um91dGVIaXN0b3J5ID0gKFxuICByb3V0ZXM6IFJvdXRlPHN0cmluZz5bXSxcbiAgaW5kZXg6IG51bWJlcixcbiAgYmFja0JlaGF2aW9yOiBCYWNrQmVoYXZpb3JcbikgPT4ge1xuICBjb25zdCBoaXN0b3J5ID0gW3sgdHlwZTogVFlQRV9ST1VURSwga2V5OiByb3V0ZXNbaW5kZXhdLmtleSB9XTtcblxuICBzd2l0Y2ggKGJhY2tCZWhhdmlvcikge1xuICAgIGNhc2UgJ2luaXRpYWxSb3V0ZSc6XG4gICAgICBpZiAoaW5kZXggIT09IDApIHtcbiAgICAgICAgaGlzdG9yeS51bnNoaWZ0KHsgdHlwZTogVFlQRV9ST1VURSwga2V5OiByb3V0ZXNbMF0ua2V5IH0pO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnb3JkZXInOlxuICAgICAgZm9yIChsZXQgaSA9IGluZGV4OyBpID4gMDsgaS0tKSB7XG4gICAgICAgIGhpc3RvcnkudW5zaGlmdCh7IHR5cGU6IFRZUEVfUk9VVEUsIGtleTogcm91dGVzW2kgLSAxXS5rZXkgfSk7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlICdoaXN0b3J5JzpcbiAgICAgIC8vIFRoZSBoaXN0b3J5IHdpbGwgZmlsbCB1cCBvbiBuYXZpZ2F0aW9uXG4gICAgICBicmVhaztcbiAgfVxuXG4gIHJldHVybiBoaXN0b3J5O1xufTtcblxuY29uc3QgY2hhbmdlSW5kZXggPSAoXG4gIHN0YXRlOiBUYWJOYXZpZ2F0aW9uU3RhdGUsXG4gIGluZGV4OiBudW1iZXIsXG4gIGJhY2tCZWhhdmlvcjogQmFja0JlaGF2aW9yXG4pID0+IHtcbiAgbGV0IGhpc3Rvcnk7XG5cbiAgaWYgKGJhY2tCZWhhdmlvciA9PT0gJ2hpc3RvcnknKSB7XG4gICAgY29uc3QgY3VycmVudEtleSA9IHN0YXRlLnJvdXRlc1tpbmRleF0ua2V5O1xuXG4gICAgaGlzdG9yeSA9IHN0YXRlLmhpc3RvcnlcbiAgICAgIC5maWx0ZXIoaXQgPT4gKGl0LnR5cGUgPT09ICdyb3V0ZScgPyBpdC5rZXkgIT09IGN1cnJlbnRLZXkgOiBmYWxzZSkpXG4gICAgICAuY29uY2F0KHsgdHlwZTogVFlQRV9ST1VURSwga2V5OiBjdXJyZW50S2V5IH0pO1xuICB9IGVsc2Uge1xuICAgIGhpc3RvcnkgPSBnZXRSb3V0ZUhpc3Rvcnkoc3RhdGUucm91dGVzLCBpbmRleCwgYmFja0JlaGF2aW9yKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLi4uc3RhdGUsXG4gICAgaW5kZXgsXG4gICAgaGlzdG9yeSxcbiAgfTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFRhYlJvdXRlcih7XG4gIGluaXRpYWxSb3V0ZU5hbWUsXG4gIGJhY2tCZWhhdmlvciA9ICdoaXN0b3J5Jyxcbn06IFRhYlJvdXRlck9wdGlvbnMpIHtcbiAgY29uc3Qgcm91dGVyOiBSb3V0ZXI8XG4gICAgVGFiTmF2aWdhdGlvblN0YXRlLFxuICAgIFRhYkFjdGlvblR5cGUgfCBDb21tb25OYXZpZ2F0aW9uQWN0aW9uXG4gID4gPSB7XG4gICAgLi4uQmFzZVJvdXRlcixcblxuICAgIHR5cGU6ICd0YWInLFxuXG4gICAgZ2V0SW5pdGlhbFN0YXRlKHsgcm91dGVOYW1lcywgcm91dGVQYXJhbUxpc3QgfSkge1xuICAgICAgY29uc3QgaW5kZXggPVxuICAgICAgICBpbml0aWFsUm91dGVOYW1lICE9PSB1bmRlZmluZWQgJiYgcm91dGVOYW1lcy5pbmNsdWRlcyhpbml0aWFsUm91dGVOYW1lKVxuICAgICAgICAgID8gcm91dGVOYW1lcy5pbmRleE9mKGluaXRpYWxSb3V0ZU5hbWUpXG4gICAgICAgICAgOiAwO1xuXG4gICAgICBjb25zdCByb3V0ZXMgPSByb3V0ZU5hbWVzLm1hcChuYW1lID0+ICh7XG4gICAgICAgIG5hbWUsXG4gICAgICAgIGtleTogYCR7bmFtZX0tJHtzaG9ydGlkKCl9YCxcbiAgICAgICAgcGFyYW1zOiByb3V0ZVBhcmFtTGlzdFtuYW1lXSxcbiAgICAgIH0pKTtcblxuICAgICAgY29uc3QgaGlzdG9yeSA9IGdldFJvdXRlSGlzdG9yeShyb3V0ZXMsIGluZGV4LCBiYWNrQmVoYXZpb3IpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGFsZTogZmFsc2UsXG4gICAgICAgIHR5cGU6ICd0YWInLFxuICAgICAgICBrZXk6IGB0YWItJHtzaG9ydGlkKCl9YCxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgIGhpc3RvcnksXG4gICAgICAgIHJvdXRlcyxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGdldFJlaHlkcmF0ZWRTdGF0ZShwYXJ0aWFsU3RhdGUsIHsgcm91dGVOYW1lcywgcm91dGVQYXJhbUxpc3QgfSkge1xuICAgICAgbGV0IHN0YXRlID0gcGFydGlhbFN0YXRlO1xuXG4gICAgICBpZiAoc3RhdGUuc3RhbGUgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3Qgcm91dGVzID0gcm91dGVOYW1lcy5tYXAobmFtZSA9PiB7XG4gICAgICAgIGNvbnN0IHJvdXRlID0gKHN0YXRlIGFzIFBhcnRpYWxTdGF0ZTxUYWJOYXZpZ2F0aW9uU3RhdGU+KS5yb3V0ZXMuZmluZChcbiAgICAgICAgICByID0+IHIubmFtZSA9PT0gbmFtZVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4ucm91dGUsXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBrZXk6XG4gICAgICAgICAgICByb3V0ZSAmJiByb3V0ZS5uYW1lID09PSBuYW1lICYmIHJvdXRlLmtleVxuICAgICAgICAgICAgICA/IHJvdXRlLmtleVxuICAgICAgICAgICAgICA6IGAke25hbWV9LSR7c2hvcnRpZCgpfWAsXG4gICAgICAgICAgcGFyYW1zOlxuICAgICAgICAgICAgcm91dGVQYXJhbUxpc3RbbmFtZV0gIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIC4uLnJvdXRlUGFyYW1MaXN0W25hbWVdLFxuICAgICAgICAgICAgICAgICAgLi4uKHJvdXRlID8gcm91dGUucGFyYW1zIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogcm91dGVcbiAgICAgICAgICAgICAgPyByb3V0ZS5wYXJhbXNcbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICAgIH0gYXMgUm91dGU8c3RyaW5nPjtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBpbmRleCA9IE1hdGgubWluKFxuICAgICAgICBNYXRoLm1heChcbiAgICAgICAgICB0eXBlb2Ygc3RhdGUuaW5kZXggPT09ICdudW1iZXInXG4gICAgICAgICAgICA/IHN0YXRlLmluZGV4XG4gICAgICAgICAgICA6IHJvdXRlTmFtZXMuaW5kZXhPZihzdGF0ZS5yb3V0ZXNbMF0ubmFtZSksXG4gICAgICAgICAgMFxuICAgICAgICApLFxuICAgICAgICByb3V0ZXMubGVuZ3RoIC0gMVxuICAgICAgKTtcblxuICAgICAgbGV0IGhpc3RvcnkgPSBzdGF0ZS5oaXN0b3J5Py5maWx0ZXIoaXQgPT5cbiAgICAgICAgcm91dGVzLmZpbmQociA9PiByLmtleSA9PT0gaXQua2V5KVxuICAgICAgKTtcblxuICAgICAgaWYgKCFoaXN0b3J5Py5sZW5ndGgpIHtcbiAgICAgICAgaGlzdG9yeSA9IGdldFJvdXRlSGlzdG9yeShyb3V0ZXMsIGluZGV4LCBiYWNrQmVoYXZpb3IpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGFsZTogZmFsc2UsXG4gICAgICAgIHR5cGU6ICd0YWInLFxuICAgICAgICBrZXk6IGB0YWItJHtzaG9ydGlkKCl9YCxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgIGhpc3RvcnksXG4gICAgICAgIHJvdXRlcyxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGdldFN0YXRlRm9yUm91dGVOYW1lc0NoYW5nZShzdGF0ZSwgeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBjb25zdCByb3V0ZXMgPSByb3V0ZU5hbWVzLm1hcChcbiAgICAgICAgbmFtZSA9PlxuICAgICAgICAgIHN0YXRlLnJvdXRlcy5maW5kKHIgPT4gci5uYW1lID09PSBuYW1lKSB8fCB7XG4gICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAga2V5OiBgJHtuYW1lfS0ke3Nob3J0aWQoKX1gLFxuICAgICAgICAgICAgcGFyYW1zOiByb3V0ZVBhcmFtTGlzdFtuYW1lXSxcbiAgICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICBjb25zdCBpbmRleCA9IE1hdGgubWF4KFxuICAgICAgICAwLFxuICAgICAgICByb3V0ZU5hbWVzLmluZGV4T2Yoc3RhdGUucm91dGVzW3N0YXRlLmluZGV4XS5uYW1lKVxuICAgICAgKTtcblxuICAgICAgbGV0IGhpc3RvcnkgPSBzdGF0ZS5oaXN0b3J5LmZpbHRlcihpdCA9PlxuICAgICAgICByb3V0ZXMuZmluZChyID0+IHIua2V5ID09PSBpdC5rZXkpXG4gICAgICApO1xuXG4gICAgICBpZiAoIWhpc3RvcnkubGVuZ3RoKSB7XG4gICAgICAgIGhpc3RvcnkgPSBnZXRSb3V0ZUhpc3Rvcnkocm91dGVzLCBpbmRleCwgYmFja0JlaGF2aW9yKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGhpc3RvcnksXG4gICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgIHJvdXRlcyxcbiAgICAgICAgaW5kZXgsXG4gICAgICB9O1xuICAgIH0sXG5cbiAgICBnZXRTdGF0ZUZvclJvdXRlRm9jdXMoc3RhdGUsIGtleSkge1xuICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5yb3V0ZXMuZmluZEluZGV4KHIgPT4gci5rZXkgPT09IGtleSk7XG5cbiAgICAgIGlmIChpbmRleCA9PT0gLTEgfHwgaW5kZXggPT09IHN0YXRlLmluZGV4KSB7XG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KHN0YXRlLCBpbmRleCwgYmFja0JlaGF2aW9yKTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JBY3Rpb24oc3RhdGUsIGFjdGlvbikge1xuICAgICAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgICAgICBjYXNlICdKVU1QX1RPJzpcbiAgICAgICAgY2FzZSAnTkFWSUdBVEUnOiB7XG4gICAgICAgICAgbGV0IGluZGV4ID0gLTE7XG5cbiAgICAgICAgICBpZiAoYWN0aW9uLnR5cGUgPT09ICdOQVZJR0FURScgJiYgYWN0aW9uLnBheWxvYWQua2V5KSB7XG4gICAgICAgICAgICBpbmRleCA9IHN0YXRlLnJvdXRlcy5maW5kSW5kZXgoXG4gICAgICAgICAgICAgIHJvdXRlID0+IHJvdXRlLmtleSA9PT0gYWN0aW9uLnBheWxvYWQua2V5XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbmRleCA9IHN0YXRlLnJvdXRlcy5maW5kSW5kZXgoXG4gICAgICAgICAgICAgIHJvdXRlID0+IHJvdXRlLm5hbWUgPT09IGFjdGlvbi5wYXlsb2FkLm5hbWVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIGNoYW5nZUluZGV4KFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgICAgICAgcm91dGVzOlxuICAgICAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLnBhcmFtcyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICA/IHN0YXRlLnJvdXRlcy5tYXAoKHJvdXRlLCBpKSA9PlxuICAgICAgICAgICAgICAgICAgICAgIGkgPT09IGluZGV4XG4gICAgICAgICAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yb3V0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnJvdXRlLnBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLmFjdGlvbi5wYXlsb2FkLnBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICA6IHJvdXRlXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgIDogc3RhdGUucm91dGVzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgYmFja0JlaGF2aW9yXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNhc2UgJ0dPX0JBQ0snOiB7XG4gICAgICAgICAgaWYgKHN0YXRlLmhpc3RvcnkubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBwcmV2aW91c0tleSA9IHN0YXRlLmhpc3Rvcnlbc3RhdGUuaGlzdG9yeS5sZW5ndGggLSAyXS5rZXk7XG4gICAgICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5yb3V0ZXMuZmluZEluZGV4KFxuICAgICAgICAgICAgcm91dGUgPT4gcm91dGUua2V5ID09PSBwcmV2aW91c0tleVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgICBoaXN0b3J5OiBzdGF0ZS5oaXN0b3J5LnNsaWNlKDAsIC0xKSxcbiAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJldHVybiBCYXNlUm91dGVyLmdldFN0YXRlRm9yQWN0aW9uKHN0YXRlLCBhY3Rpb24pO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBzaG91bGRBY3Rpb25DaGFuZ2VGb2N1cyhhY3Rpb24pIHtcbiAgICAgIHJldHVybiBhY3Rpb24udHlwZSA9PT0gJ05BVklHQVRFJztcbiAgICB9LFxuXG4gICAgYWN0aW9uQ3JlYXRvcnM6IFRhYkFjdGlvbnMsXG4gIH07XG5cbiAgcmV0dXJuIHJvdXRlcjtcbn1cbiJdfQ==
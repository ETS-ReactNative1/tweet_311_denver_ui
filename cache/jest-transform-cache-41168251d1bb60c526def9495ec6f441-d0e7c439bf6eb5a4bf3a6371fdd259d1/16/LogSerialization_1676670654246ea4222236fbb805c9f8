b6505f2f6b43706a6a3393d956ca10f4
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.EXPO_CONSOLE_METHOD_NAME = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _expoConstants = _interopRequireDefault(require("expo-constants"));

var _prettyFormat = _interopRequireDefault(require("pretty-format"));

var _parseErrorStack = _interopRequireDefault(require("react-native/Libraries/Core/Devtools/parseErrorStack"));

var _symbolicateStackTrace = _interopRequireDefault(require("react-native/Libraries/Core/Devtools/symbolicateStackTrace"));

var _ReactNodeFormatter = _interopRequireDefault(require("./format/ReactNodeFormatter"));

var EXPO_CONSOLE_METHOD_NAME = '__expoConsoleLog';
exports.EXPO_CONSOLE_METHOD_NAME = EXPO_CONSOLE_METHOD_NAME;

function serializeLogDataAsync(data, level) {
  var serializedValues, includesStack, rawStack, syntheticError, stack, errorMessage, serializedError, error, _errorMessage, _serializedError;

  return _regenerator.default.async(function serializeLogDataAsync$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          includesStack = false;

          if (!_stackTraceLogsSupported()) {
            _context.next = 32;
            break;
          }

          if (!_isUnhandledPromiseRejection(data, level)) {
            _context.next = 11;
            break;
          }

          rawStack = data[0];
          syntheticError = {
            stack: rawStack
          };
          _context.next = 7;
          return _regenerator.default.awrap(_symbolicateErrorAsync(syntheticError));

        case 7:
          stack = _context.sent;

          if (!stack.length) {
            serializedValues = _stringifyLogData(data);
          } else {
            errorMessage = rawStack.split('\n')[1];
            serializedValues = [{
              message: "[Unhandled promise rejection: " + errorMessage + "]",
              stack: _formatStack(stack)
            }];
            includesStack = true;
          }

          _context.next = 30;
          break;

        case 11:
          if (!(data.length === 1 && data[0] instanceof Error)) {
            _context.next = 19;
            break;
          }

          _context.next = 14;
          return _regenerator.default.awrap(_serializeErrorAsync(data[0]));

        case 14:
          serializedError = _context.sent;
          serializedValues = [serializedError];
          includesStack = serializedError.hasOwnProperty('stack');
          _context.next = 30;
          break;

        case 19:
          if (!(level === 'warn' || level === 'error')) {
            _context.next = 29;
            break;
          }

          error = _captureConsoleStackTrace();
          _errorMessage = _stringifyLogData(data).join(', ');
          _context.next = 24;
          return _regenerator.default.awrap(_serializeErrorAsync(error, _errorMessage));

        case 24:
          _serializedError = _context.sent;
          serializedValues = [_serializedError];
          includesStack = _serializedError.hasOwnProperty('stack');
          _context.next = 30;
          break;

        case 29:
          serializedValues = _stringifyLogData(data);

        case 30:
          _context.next = 33;
          break;

        case 32:
          serializedValues = _stringifyLogData(data);

        case 33:
          return _context.abrupt("return", {
            body: (0, _toConsumableArray2.default)(serializedValues),
            includesStack: includesStack
          });

        case 34:
        case "end":
          return _context.stop();
      }
    }
  });
}

function _stringifyLogData(data) {
  return data.map(function (item) {
    if (typeof item === 'string') {
      return item;
    } else {
      var LOG_MESSAGE_MAX_LENGTH = 10000;
      var result = (0, _prettyFormat.default)(item, {
        plugins: [_ReactNodeFormatter.default]
      });

      if (result.length > LOG_MESSAGE_MAX_LENGTH) {
        var truncatedResult = result.substring(0, LOG_MESSAGE_MAX_LENGTH);
        truncatedResult += "...(truncated to the first " + LOG_MESSAGE_MAX_LENGTH + " characters)";
        return truncatedResult;
      } else {
        return result;
      }
    }
  });
}

function _serializeErrorAsync(error, message) {
  var messageParts, firstUselessLine, stack, formattedStack;
  return _regenerator.default.async(function _serializeErrorAsync$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          if (message == null) {
            message = error.message;
          }

          messageParts = message.split('\n');
          firstUselessLine = messageParts.indexOf('This error is located at:');

          if (firstUselessLine > 0) {
            message = messageParts.slice(0, firstUselessLine - 1).join('\n');
          }

          if (!(!error.stack || !error.stack.length)) {
            _context2.next = 6;
            break;
          }

          return _context2.abrupt("return", (0, _prettyFormat.default)(error));

        case 6:
          _context2.next = 8;
          return _regenerator.default.awrap(_symbolicateErrorAsync(error));

        case 8:
          stack = _context2.sent;
          formattedStack = _formatStack(stack);
          return _context2.abrupt("return", {
            message: message,
            stack: formattedStack
          });

        case 11:
        case "end":
          return _context2.stop();
      }
    }
  });
}

function _symbolicateErrorAsync(error) {
  var parsedStack, symbolicatedStack;
  return _regenerator.default.async(function _symbolicateErrorAsync$(_context3) {
    while (1) {
      switch (_context3.prev = _context3.next) {
        case 0:
          parsedStack = (0, _parseErrorStack.default)(error);
          _context3.prev = 1;
          _context3.next = 4;
          return _regenerator.default.awrap((0, _symbolicateStackTrace.default)(parsedStack));

        case 4:
          symbolicatedStack = _context3.sent;
          _context3.next = 10;
          break;

        case 7:
          _context3.prev = 7;
          _context3.t0 = _context3["catch"](1);
          return _context3.abrupt("return", parsedStack);

        case 10:
          if (symbolicatedStack) {
            _context3.next = 12;
            break;
          }

          return _context3.abrupt("return", parsedStack);

        case 12:
          return _context3.abrupt("return", symbolicatedStack.map(_removeProjectRoot));

        case 13:
        case "end":
          return _context3.stop();
      }
    }
  }, null, null, [[1, 7]]);
}

function _formatStack(stack) {
  return stack.map(function (frame) {
    var line = frame.file + ":" + frame.lineNumber;

    if (frame.column != null) {
      line += ":" + frame.column;
    }

    line += " in " + frame.methodName;
    return line;
  }).join('\n');
}

function _removeProjectRoot(frame) {
  var filename = frame.file;

  if (filename == null) {
    return frame;
  }

  var projectRoot = _getProjectRoot();

  if (projectRoot == null) {
    return frame;
  }

  if (filename.startsWith(projectRoot)) {
    filename = filename.substring(projectRoot.length);

    if (filename[0] === '/' || filename[0] === '\\') {
      filename = filename.substring(1);
    }

    frame.file = filename;
  }

  return frame;
}

function _stackTraceLogsSupported() {
  return !!(__DEV__ && _getProjectRoot());
}

function _isUnhandledPromiseRejection(data, level) {
  return level === 'warn' && typeof data[0] === 'string' && /^Possible Unhandled Promise Rejection/.test(data[0]);
}

function _captureConsoleStackTrace() {
  try {
    throw new Error();
  } catch (error) {
    var stackLines = error.stack.split('\n');
    var consoleMethodIndex = stackLines.findIndex(function (frame) {
      return frame.includes(EXPO_CONSOLE_METHOD_NAME);
    });

    if (consoleMethodIndex !== -1) {
      stackLines = stackLines.slice(consoleMethodIndex + 1);
      error.stack = stackLines.join('\n');
    }

    return error;
  }
}

function _getProjectRoot() {
  return _expoConstants.default.manifest && _expoConstants.default.manifest.developer ? _expoConstants.default.manifest.developer.projectRoot : null;
}

var _default = {
  serializeLogDataAsync: serializeLogDataAsync
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sb2dzL0xvZ1NlcmlhbGl6YXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFPTyxJQUFNLHdCQUF3QixHQUFHLGtCQUFqQzs7O0FBRVAsU0FBZSxxQkFBZixDQUFxQyxJQUFyQyxFQUFzRCxLQUF0RDtBQUFBOztBQUFBO0FBQUE7QUFBQTtBQUFBO0FBRU0sVUFBQSxhQUZOLEdBRXNCLEtBRnRCOztBQUFBLGVBSU0sd0JBQXdCLEVBSjlCO0FBQUE7QUFBQTtBQUFBOztBQUFBLGVBS1EsNEJBQTRCLENBQUMsSUFBRCxFQUFPLEtBQVAsQ0FMcEM7QUFBQTtBQUFBO0FBQUE7O0FBTVUsVUFBQSxRQU5WLEdBTXFCLElBQUksQ0FBQyxDQUFELENBTnpCO0FBT1UsVUFBQSxjQVBWLEdBTzJCO0FBQUUsWUFBQSxLQUFLLEVBQUU7QUFBVCxXQVAzQjtBQUFBO0FBQUEsNENBUXdCLHNCQUFzQixDQUFDLGNBQUQsQ0FSOUM7O0FBQUE7QUFRVSxVQUFBLEtBUlY7O0FBVU0sY0FBSSxDQUFDLEtBQUssQ0FBQyxNQUFYLEVBQW1CO0FBQ2pCLFlBQUEsZ0JBQWdCLEdBQUcsaUJBQWlCLENBQUMsSUFBRCxDQUFwQztBQUNELFdBRkQsTUFFTztBQUVELFlBQUEsWUFGQyxHQUVjLFFBQVEsQ0FBQyxLQUFULENBQWUsSUFBZixFQUFxQixDQUFyQixDQUZkO0FBR0wsWUFBQSxnQkFBZ0IsR0FBRyxDQUNqQjtBQUNFLGNBQUEsT0FBTyxxQ0FBbUMsWUFBbkMsTUFEVDtBQUVFLGNBQUEsS0FBSyxFQUFFLFlBQVksQ0FBQyxLQUFEO0FBRnJCLGFBRGlCLENBQW5CO0FBTUEsWUFBQSxhQUFhLEdBQUcsSUFBaEI7QUFDRDs7QUF0QlA7QUFBQTs7QUFBQTtBQUFBLGdCQXVCZSxJQUFJLENBQUMsTUFBTCxLQUFnQixDQUFoQixJQUFxQixJQUFJLENBQUMsQ0FBRCxDQUFKLFlBQW1CLEtB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SUFBbEIsQ0FBakI7QUFDQSxRQUFJLGtCQUFrQixHQUFHLFVBQVUsQ0FBQyxTQUFYLENBQXFCLFVBQUEsS0FBSztBQUFBLGFBQ2pELEtBQUssQ0FBQyxRQUFOLENBQWUsd0JBQWYsQ0FEaUQ7QUFBQSxLQUExQixDQUF6Qjs7QUFHQSxRQUFJLGtCQUFrQixLQUFLLENBQUMsQ0FBNUIsRUFBK0I7QUFDN0IsTUFBQSxVQUFVLEdBQUcsVUFBVSxDQUFDLEtBQVgsQ0FBaUIsa0JBQWtCLEdBQUcsQ0FBdEMsQ0FBYjtBQUNBLE1BQUEsS0FBSyxDQUFDLEtBQU4sR0FBYyxVQUFVLENBQUMsSUFBWCxDQUFnQixJQUFoQixDQUFkO0FBQ0Q7O0FBQ0QsV0FBTyxLQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTLGVBQVQsR0FBd0I7QUFDdEIsU0FBTyx1QkFBVSxRQUFWLElBQXNCLHVCQUFVLFFBQVYsQ0FBbUIsU0FBekMsR0FDSCx1QkFBVSxRQUFWLENBQW1CLFNBQW5CLENBQTZCLFdBRDFCLEdBRUgsSUFGSjtBQUdEOztlQUVjO0FBQ2IsRUFBQSxxQkFBcUIsRUFBckI7QUFEYSxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENvbnN0YW50cyBmcm9tICdleHBvLWNvbnN0YW50cyc7XG5pbXBvcnQgcHJldHR5Rm9ybWF0IGZyb20gJ3ByZXR0eS1mb3JtYXQnO1xuaW1wb3J0IHBhcnNlRXJyb3JTdGFjaywgeyBTdGFja0ZyYW1lIH0gZnJvbSAncmVhY3QtbmF0aXZlL0xpYnJhcmllcy9Db3JlL0RldnRvb2xzL3BhcnNlRXJyb3JTdGFjayc7XG5pbXBvcnQgc3ltYm9saWNhdGVTdGFja1RyYWNlIGZyb20gJ3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29yZS9EZXZ0b29scy9zeW1ib2xpY2F0ZVN0YWNrVHJhY2UnO1xuXG5pbXBvcnQgeyBMb2dEYXRhLCBMb2dMZXZlbCB9IGZyb20gJy4vUmVtb3RlTG9nZ2luZyc7XG5pbXBvcnQgUmVhY3ROb2RlRm9ybWF0dGVyIGZyb20gJy4vZm9ybWF0L1JlYWN0Tm9kZUZvcm1hdHRlcic7XG5cbnR5cGUgU2VyaWFsaXplZERhdGEgPSB7XG4gIGJvZHk6IExvZ0RhdGFbXTtcbiAgaW5jbHVkZXNTdGFjazogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCBjb25zdCBFWFBPX0NPTlNPTEVfTUVUSE9EX05BTUUgPSAnX19leHBvQ29uc29sZUxvZyc7XG5cbmFzeW5jIGZ1bmN0aW9uIHNlcmlhbGl6ZUxvZ0RhdGFBc3luYyhkYXRhOiB1bmtub3duW10sIGxldmVsOiBMb2dMZXZlbCk6IFByb21pc2U8U2VyaWFsaXplZERhdGE+IHtcbiAgbGV0IHNlcmlhbGl6ZWRWYWx1ZXM6IFJlYWRvbmx5QXJyYXk8TG9nRGF0YT47XG4gIGxldCBpbmNsdWRlc1N0YWNrID0gZmFsc2U7XG5cbiAgaWYgKF9zdGFja1RyYWNlTG9nc1N1cHBvcnRlZCgpKSB7XG4gICAgaWYgKF9pc1VuaGFuZGxlZFByb21pc2VSZWplY3Rpb24oZGF0YSwgbGV2ZWwpKSB7XG4gICAgICBsZXQgcmF3U3RhY2sgPSBkYXRhWzBdIGFzIHN0cmluZztcbiAgICAgIGxldCBzeW50aGV0aWNFcnJvciA9IHsgc3RhY2s6IHJhd1N0YWNrIH07XG4gICAgICBsZXQgc3RhY2sgPSBhd2FpdCBfc3ltYm9saWNhdGVFcnJvckFzeW5jKHN5bnRoZXRpY0Vycm9yIGFzIEVycm9yKTtcblxuICAgICAgaWYgKCFzdGFjay5sZW5ndGgpIHtcbiAgICAgICAgc2VyaWFsaXplZFZhbHVlcyA9IF9zdHJpbmdpZnlMb2dEYXRhKGRhdGEpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTk9URTogVGhpcyBkb2Vzbid0IGhhbmRsZSBlcnJvciBtZXNzYWdlcyB3aXRoIG5ld2xpbmVzXG4gICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSByYXdTdGFjay5zcGxpdCgnXFxuJylbMV07XG4gICAgICAgIHNlcmlhbGl6ZWRWYWx1ZXMgPSBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogYFtVbmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb246ICR7ZXJyb3JNZXNzYWdlfV1gLFxuICAgICAgICAgICAgc3RhY2s6IF9mb3JtYXRTdGFjayhzdGFjayksXG4gICAgICAgICAgfSxcbiAgICAgICAgXTtcbiAgICAgICAgaW5jbHVkZXNTdGFjayA9IHRydWU7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChkYXRhLmxlbmd0aCA9PT0gMSAmJiBkYXRhWzBdIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgIC8vIFdoZW4gdGhlcmUncyBvbmx5IG9uZSBhcmd1bWVudCB0byB0aGUgbG9nIGZ1bmN0aW9uIGFuZCB0aGF0IGFyZ3VtZW50IGlzIGFuIGVycm9yLCB3ZVxuICAgICAgLy8gaW5jbHVkZSB0aGUgZXJyb3IncyBzdGFjay4gSWYgdGhlcmUncyBtb3JlIHRoYW4gb25lIGFyZ3VtZW50IHRoZW4gd2UgZG9uJ3QgaW5jbHVkZSB0aGVcbiAgICAgIC8vIHN0YWNrIGJlY2F1c2UgaXQncyBub3QgZWFzeSB0byBkaXNwbGF5IG5pY2VseSBpbiBvdXIgY3VycmVudCBVSS5cblxuICAgICAgbGV0IHNlcmlhbGl6ZWRFcnJvciA9IGF3YWl0IF9zZXJpYWxpemVFcnJvckFzeW5jKGRhdGFbMF0gYXMgRXJyb3IpO1xuICAgICAgc2VyaWFsaXplZFZhbHVlcyA9IFtzZXJpYWxpemVkRXJyb3JdO1xuICAgICAgaW5jbHVkZXNTdGFjayA9IHNlcmlhbGl6ZWRFcnJvci5oYXNPd25Qcm9wZXJ0eSgnc3RhY2snKTtcbiAgICB9IGVsc2UgaWYgKGxldmVsID09PSAnd2FybicgfHwgbGV2ZWwgPT09ICdlcnJvcicpIHtcbiAgICAgIC8vIEZvciBjb25zb2xlLndhcm4gYW5kIGNvbnNvbGUuZXJyb3IgaXQgaXMgdXN1YWxseSB1c2VmdWwgdG8ga25vdyB0aGUgc3RhY2sgdGhhdCBsZWFkcyB0byB0aGVcbiAgICAgIC8vIHdhcm5pbmcgb3IgZXJyb3IsIHNvIHdlIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB0byBoZWxwIG91dCB3aXRoIGRlYnVnZ2luZ1xuXG4gICAgICBsZXQgZXJyb3IgPSBfY2FwdHVyZUNvbnNvbGVTdGFja1RyYWNlKCk7XG4gICAgICAvLyBbXCJoZWxsb1wiLCBcIndvcmxkXCJdIGJlY29tZXMgXCJoZWxsbywgd29ybGRcIlxuICAgICAgbGV0IGVycm9yTWVzc2FnZSA9IF9zdHJpbmdpZnlMb2dEYXRhKGRhdGEpLmpvaW4oJywgJyk7XG5cbiAgICAgIGxldCBzZXJpYWxpemVkRXJyb3IgPSBhd2FpdCBfc2VyaWFsaXplRXJyb3JBc3luYyhlcnJvciwgZXJyb3JNZXNzYWdlKTtcbiAgICAgIHNlcmlhbGl6ZWRWYWx1ZXMgPSBbc2VyaWFsaXplZEVycm9yXTtcbiAgICAgIGluY2x1ZGVzU3RhY2sgPSBzZXJpYWxpemVkRXJyb3IuaGFzT3duUHJvcGVydHkoJ3N0YWNrJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNlcmlhbGl6ZWRWYWx1ZXMgPSBfc3RyaW5naWZ5TG9nRGF0YShkYXRhKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc2VyaWFsaXplZFZhbHVlcyA9IF9zdHJpbmdpZnlMb2dEYXRhKGRhdGEpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBib2R5OiBbLi4uc2VyaWFsaXplZFZhbHVlc10sXG4gICAgaW5jbHVkZXNTdGFjayxcbiAgfTtcbn1cblxuZnVuY3Rpb24gX3N0cmluZ2lmeUxvZ0RhdGEoZGF0YTogdW5rbm93bltdKTogc3RyaW5nW10ge1xuICByZXR1cm4gZGF0YS5tYXAoaXRlbSA9PiB7XG4gICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGl0ZW07XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGRlZmluZSB0aGUgbWF4IGxlbmd0aCBmb3IgbG9nIG1zZyB0byBiZSBmaXJzdCAxMDAwMCBjaGFyYWN0ZXJzXG4gICAgICBjb25zdCBMT0dfTUVTU0FHRV9NQVhfTEVOR1RIID0gMTAwMDA7XG4gICAgICBsZXQgcmVzdWx0ID0gcHJldHR5Rm9ybWF0KGl0ZW0sIHsgcGx1Z2luczogW1JlYWN0Tm9kZUZvcm1hdHRlcl0gfSk7XG4gICAgICAvLyBjaGVjayB0aGUgc2l6ZSBvZiBzdHJpbmcgcmV0dXJuZWRcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gTE9HX01FU1NBR0VfTUFYX0xFTkdUSCkge1xuICAgICAgICBsZXQgdHJ1bmNhdGVkUmVzdWx0ID0gcmVzdWx0LnN1YnN0cmluZygwLCBMT0dfTUVTU0FHRV9NQVhfTEVOR1RIKTtcbiAgICAgICAgLy8gdHJ1bmNhdGUgdGhlIHJlc3VsdCBzdHJpbmcgdG8gdGhlIG1heCBsZW5ndGhcbiAgICAgICAgdHJ1bmNhdGVkUmVzdWx0ICs9IGAuLi4odHJ1bmNhdGVkIHRvIHRoZSBmaXJzdCAke0xPR19NRVNTQUdFX01BWF9MRU5HVEh9IGNoYXJhY3RlcnMpYDtcbiAgICAgICAgcmV0dXJuIHRydW5jYXRlZFJlc3VsdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX3NlcmlhbGl6ZUVycm9yQXN5bmMoZXJyb3I6IEVycm9yLCBtZXNzYWdlPzogc3RyaW5nKTogUHJvbWlzZTxMb2dEYXRhPiB7XG4gIGlmIChtZXNzYWdlID09IG51bGwpIHtcbiAgICBtZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgfVxuXG4gIC8vIG5vdGUoYnJlbnR2YXRuZSk6IFJlYWN0IE5hdGl2ZSBjdXJyZW50bHkgYXBwZW5kcyBwYXJ0IG9mIHRoZSBzdGFjayBpbnNpZGUgb2ZcbiAgLy8gdGhlIGVycm9yIG1lc3NhZ2UgaXRzZWxmIGZvciBzb21lIHJlYXNvbi4gVGhpcyBpcyBqdXN0IGNvbmZ1c2luZyBhbmQgd2UgZG9uJ3RcbiAgLy8gd2FudCB0byBpbmNsdWRlIGl0IGluIHRoZSBleHBvLWNsaSBvdXRwdXRcbiAgbGV0IG1lc3NhZ2VQYXJ0cyA9IG1lc3NhZ2Uuc3BsaXQoJ1xcbicpO1xuICBsZXQgZmlyc3RVc2VsZXNzTGluZSA9IG1lc3NhZ2VQYXJ0cy5pbmRleE9mKCdUaGlzIGVycm9yIGlzIGxvY2F0ZWQgYXQ6Jyk7XG4gIGlmIChmaXJzdFVzZWxlc3NMaW5lID4gMCkge1xuICAgIG1lc3NhZ2UgPSBtZXNzYWdlUGFydHMuc2xpY2UoMCwgZmlyc3RVc2VsZXNzTGluZSAtIDEpLmpvaW4oJ1xcbicpO1xuICB9XG5cbiAgaWYgKCFlcnJvci5zdGFjayB8fCAhZXJyb3Iuc3RhY2subGVuZ3RoKSB7XG4gICAgcmV0dXJuIHByZXR0eUZvcm1hdChlcnJvcik7XG4gIH1cblxuICBsZXQgc3RhY2sgPSBhd2FpdCBfc3ltYm9saWNhdGVFcnJvckFzeW5jKGVycm9yKTtcbiAgbGV0IGZvcm1hdHRlZFN0YWNrID0gX2Zvcm1hdFN0YWNrKHN0YWNrKTtcblxuICByZXR1cm4geyBtZXNzYWdlLCBzdGFjazogZm9ybWF0dGVkU3RhY2sgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX3N5bWJvbGljYXRlRXJyb3JBc3luYyhlcnJvcjogRXJyb3IpOiBQcm9taXNlPFN0YWNrRnJhbWVbXT4ge1xuICBsZXQgcGFyc2VkU3RhY2sgPSBwYXJzZUVycm9yU3RhY2soZXJyb3IpO1xuICBsZXQgc3ltYm9saWNhdGVkU3RhY2s6IFN0YWNrRnJhbWVbXSB8IG51bGw7XG4gIHRyeSB7XG4gICAgc3ltYm9saWNhdGVkU3RhY2sgPSBhd2FpdCBzeW1ib2xpY2F0ZVN0YWNrVHJhY2UocGFyc2VkU3RhY2spO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIHJldHVybiBwYXJzZWRTdGFjaztcbiAgfVxuXG4gIC8vIEluIHRoaXMgY29udGV4dCBhbiB1bnN5bWJvbGljYXRlZCBzdGFjayBpcyBiZXR0ZXIgdGhhbiBubyBzdGFja1xuICBpZiAoIXN5bWJvbGljYXRlZFN0YWNrKSB7XG4gICAgcmV0dXJuIHBhcnNlZFN0YWNrO1xuICB9XG5cbiAgLy8gQ2xlYW4gdGhlIHN0YWNrIHRyYWNlXG4gIHJldHVybiBzeW1ib2xpY2F0ZWRTdGFjay5tYXAoX3JlbW92ZVByb2plY3RSb290KTtcbn1cblxuZnVuY3Rpb24gX2Zvcm1hdFN0YWNrKHN0YWNrOiBTdGFja0ZyYW1lW10pOiBzdHJpbmcge1xuICByZXR1cm4gc3RhY2tcbiAgICAubWFwKGZyYW1lID0+IHtcbiAgICAgIGxldCBsaW5lID0gYCR7ZnJhbWUuZmlsZX06JHtmcmFtZS5saW5lTnVtYmVyfWA7XG4gICAgICBpZiAoZnJhbWUuY29sdW1uICE9IG51bGwpIHtcbiAgICAgICAgbGluZSArPSBgOiR7ZnJhbWUuY29sdW1ufWA7XG4gICAgICB9XG4gICAgICBsaW5lICs9IGAgaW4gJHtmcmFtZS5tZXRob2ROYW1lfWA7XG4gICAgICByZXR1cm4gbGluZTtcbiAgICB9KVxuICAgIC5qb2luKCdcXG4nKTtcbn1cblxuZnVuY3Rpb24gX3JlbW92ZVByb2plY3RSb290KGZyYW1lOiBTdGFja0ZyYW1lKTogU3RhY2tGcmFtZSB7XG4gIGxldCBmaWxlbmFtZSA9IGZyYW1lLmZpbGU7XG4gIGlmIChmaWxlbmFtZSA9PSBudWxsKSB7XG4gICAgcmV0dXJuIGZyYW1lO1xuICB9XG5cbiAgbGV0IHByb2plY3RSb290ID0gX2dldFByb2plY3RSb290KCk7XG4gIGlmIChwcm9qZWN0Um9vdCA9PSBudWxsKSB7XG4gICAgcmV0dXJuIGZyYW1lO1xuICB9XG5cbiAgaWYgKGZpbGVuYW1lLnN0YXJ0c1dpdGgocHJvamVjdFJvb3QpKSB7XG4gICAgZmlsZW5hbWUgPSBmaWxlbmFtZS5zdWJzdHJpbmcocHJvamVjdFJvb3QubGVuZ3RoKTtcbiAgICBpZiAoZmlsZW5hbWVbMF0gPT09ICcvJyB8fCBmaWxlbmFtZVswXSA9PT0gJ1xcXFwnKSB7XG4gICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cmluZygxKTtcbiAgICB9XG4gICAgZnJhbWUuZmlsZSA9IGZpbGVuYW1lO1xuICB9XG5cbiAgcmV0dXJuIGZyYW1lO1xufVxuXG4vKipcbiAqIFJldHVybnMgd2hldGhlciB0aGUgZGV2ZWxvcG1lbnQgc2VydmVyIHRoYXQgc2VydmVkIHRoaXMgcHJvamVjdCBzdXBwb3J0cyBsb2dzIHdpdGggYSBzdGFjayB0cmFjZS5cbiAqIFNwZWNpZmljYWxseSwgdGhlIHZlcnNpb24gb2YgRXhwbyBDTEkgdGhhdCBpbmNsdWRlcyBgcHJvamVjdFJvb3RgIGluIHRoZSBtYW5pZmVzdCBhbHNvIGFjY2VwdHNcbiAqIHBheWxvYWRzIG9mIHRoZSBmb3JtOlxuICpcbiAqIHtcbiAqICAgaW5jbHVkZXNTdGFjazogYm9vbGVhbiwgYm9keTogW3sgbWVzc2FnZTogc3RyaW5nLCBzdGFjazogc3RyaW5nIH1dLFxuICogfVxuICovXG5mdW5jdGlvbiBfc3RhY2tUcmFjZUxvZ3NTdXBwb3J0ZWQoKTogYm9vbGVhbiB7XG4gIHJldHVybiAhIShfX0RFVl9fICYmIF9nZXRQcm9qZWN0Um9vdCgpKTtcbn1cblxuZnVuY3Rpb24gX2lzVW5oYW5kbGVkUHJvbWlzZVJlamVjdGlvbihkYXRhOiB1bmtub3duW10sIGxldmVsOiBMb2dMZXZlbCk6IGJvb2xlYW4ge1xuICByZXR1cm4gKFxuICAgIGxldmVsID09PSAnd2FybicgJiZcbiAgICB0eXBlb2YgZGF0YVswXSA9PT0gJ3N0cmluZycgJiZcbiAgICAvXlBvc3NpYmxlIFVuaGFuZGxlZCBQcm9taXNlIFJlamVjdGlvbi8udGVzdChkYXRhWzBdIGFzIHN0cmluZylcbiAgKTtcbn1cblxuZnVuY3Rpb24gX2NhcHR1cmVDb25zb2xlU3RhY2tUcmFjZSgpOiBFcnJvciB7XG4gIHRyeSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbGV0IHN0YWNrTGluZXMgPSBlcnJvci5zdGFjay5zcGxpdCgnXFxuJyk7XG4gICAgbGV0IGNvbnNvbGVNZXRob2RJbmRleCA9IHN0YWNrTGluZXMuZmluZEluZGV4KGZyYW1lID0+XG4gICAgICBmcmFtZS5pbmNsdWRlcyhFWFBPX0NPTlNPTEVfTUVUSE9EX05BTUUpXG4gICAgKTtcbiAgICBpZiAoY29uc29sZU1ldGhvZEluZGV4ICE9PSAtMSkge1xuICAgICAgc3RhY2tMaW5lcyA9IHN0YWNrTGluZXMuc2xpY2UoY29uc29sZU1ldGhvZEluZGV4ICsgMSk7XG4gICAgICBlcnJvci5zdGFjayA9IHN0YWNrTGluZXMuam9pbignXFxuJyk7XG4gICAgfVxuICAgIHJldHVybiBlcnJvcjtcbiAgfVxufVxuXG5mdW5jdGlvbiBfZ2V0UHJvamVjdFJvb3QoKTogc3RyaW5nIHwgbnVsbCB7XG4gIHJldHVybiBDb25zdGFudHMubWFuaWZlc3QgJiYgQ29uc3RhbnRzLm1hbmlmZXN0LmRldmVsb3BlclxuICAgID8gQ29uc3RhbnRzLm1hbmlmZXN0LmRldmVsb3Blci5wcm9qZWN0Um9vdFxuICAgIDogbnVsbDtcbn1cblxuZXhwb3J0IGRlZmF1bHQge1xuICBzZXJpYWxpemVMb2dEYXRhQXN5bmMsXG59O1xuIl0sInNvdXJjZVJvb3QiOiIifQ==
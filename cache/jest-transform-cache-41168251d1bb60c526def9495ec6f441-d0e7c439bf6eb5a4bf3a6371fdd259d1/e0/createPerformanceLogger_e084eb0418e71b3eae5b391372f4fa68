0e2894222f5d424af45cb9dc36764d43
'use strict';

var Systrace = require("../Performance/Systrace");

var infoLog = require("./infoLog");

var performanceNow = global.nativeQPLTimestamp || global.nativePerformanceNow || require('fbjs/lib/performanceNow');

var _cookies = {};
var PRINT_TO_CONSOLE = false;

function createPerformanceLogger() {
  var result = {
    _timespans: {},
    _extras: {},
    _points: {},
    addTimespan: function addTimespan(key, lengthInMs, description) {
      if (this._timespans[key]) {
        if (PRINT_TO_CONSOLE && __DEV__) {
          infoLog('PerformanceLogger: Attempting to add a timespan that already exists ', key);
        }

        return;
      }

      this._timespans[key] = {
        description: description,
        totalTime: lengthInMs
      };
    },
    startTimespan: function startTimespan(key, description) {
      if (this._timespans[key]) {
        if (PRINT_TO_CONSOLE && __DEV__) {
          infoLog('PerformanceLogger: Attempting to start a timespan that already exists ', key);
        }

        return;
      }

      this._timespans[key] = {
        description: description,
        startTime: performanceNow()
      };
      _cookies[key] = Systrace.beginAsyncEvent(key);

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'start: ' + key);
      }
    },
    stopTimespan: function stopTimespan(key) {
      var timespan = this._timespans[key];

      if (!timespan || !timespan.startTime) {
        if (PRINT_TO_CONSOLE && __DEV__) {
          infoLog('PerformanceLogger: Attempting to end a timespan that has not started ', key);
        }

        return;
      }

      if (timespan.endTime) {
        if (PRINT_TO_CONSOLE && __DEV__) {
          infoLog('PerformanceLogger: Attempting to end a timespan that has already ended ', key);
        }

        return;
      }

      timespan.endTime = performanceNow();
      timespan.totalTime = timespan.endTime - (timespan.startTime || 0);

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'end: ' + key);
      }

      Systrace.endAsyncEvent(key, _cookies[key]);
      delete _cookies[key];
    },
    clear: function clear() {
      this._timespans = {};
      this._extras = {};
      this._points = {};

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'clear');
      }
    },
    clearCompleted: function clearCompleted() {
      for (var _key in this._timespans) {
        if (this._timespans[_key].totalTime) {
          delete this._timespans[_key];
        }
      }

      this._extras = {};
      this._points = {};

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'clearCompleted');
      }
    },
    clearExceptTimespans: function clearExceptTimespans(keys) {
      this._timespans = Object.keys(this._timespans).reduce(function (previous, key) {
        if (keys.indexOf(key) !== -1) {
          previous[key] = this._timespans[key];
        }

        return previous;
      }, {});
      this._extras = {};
      this._points = {};

      if (PRINT_TO_CONSOLE) {
        infoLog('PerformanceLogger.js', 'clearExceptTimespans', keys);
      }
    },
    currentTimestamp: function currentTimestamp() {
      return performanceNow();
    },
    getTimespans: function getTimespans() {
      return this._timespans;
    },
    hasTimespan: function hasTimespan(key) {
      return !!this._timespans[key];
    },
    logTimespans: function logTimespans() {
      if (PRINT_TO_CONSOLE) {
        for (var _key2 in this._timespans) {
          if (this._timespans[_key2].totalTime) {
            infoLog(_key2 + ': ' + this._timespans[_key2].totalTime + 'ms');
          }
        }
      }
    },
    addTimespans: function addTimespans(newTimespans, labels) {
      for (var ii = 0, l = newTimespans.length; ii < l; ii += 2) {
        var label = labels[ii / 2];
        this.addTimespan(label, newTimespans[ii + 1] - newTimespans[ii], label);
      }
    },
    setExtra: function setExtra(key, value) {
      if (this._extras[key]) {
        if (PRINT_TO_CONSOLE && __DEV__) {
          infoLog('PerformanceLogger: Attempting to set an extra that already exists ', {
            key: key,
            currentValue: this._extras[key],
            attemptedValue: value
          });
        }

        return;
      }

      this._extras[key] = value;
    },
    getExtras: function getExtras() {
      return this._extras;
    },
    removeExtra: function removeExtra(key) {
      var value = this._extras[key];
      delete this._extras[key];
      return value;
    },
    logExtras: function logExtras() {
      if (PRINT_TO_CONSOLE) {
        infoLog(this._extras);
      }
    },
    markPoint: function markPoint(key, timestamp) {
      if (this._points[key]) {
        if (PRINT_TO_CONSOLE && __DEV__) {
          infoLog('PerformanceLogger: Attempting to mark a point that has been already logged ', key);
        }

        return;
      }

      this._points[key] = timestamp != null ? timestamp : performanceNow();
    },
    getPoints: function getPoints() {
      return this._points;
    },
    logPoints: function logPoints() {
      if (PRINT_TO_CONSOLE) {
        for (var _key3 in this._points) {
          infoLog(_key3 + ': ' + this._points[_key3] + 'ms');
        }
      }
    },
    logEverything: function logEverything() {
      this.logTimespans();
      this.logExtras();
      this.logPoints();
    }
  };
  return result;
}

module.exports = createPerformanceLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZVBlcmZvcm1hbmNlTG9nZ2VyLmpzIl0sIm5hbWVzIjpbIlN5c3RyYWNlIiwicmVxdWlyZSIsImluZm9Mb2ciLCJwZXJmb3JtYW5jZU5vdyIsImdsb2JhbCIsIm5hdGl2ZVFQTFRpbWVzdGFtcCIsIm5hdGl2ZVBlcmZvcm1hbmNlTm93IiwiX2Nvb2tpZXMiLCJQUklOVF9UT19DT05TT0xFIiwiY3JlYXRlUGVyZm9ybWFuY2VMb2dnZXIiLCJyZXN1bHQiLCJfdGltZXNwYW5zIiwiX2V4dHJhcyIsIl9wb2ludHMiLCJhZGRUaW1lc3BhbiIsImtleSIsImxlbmd0aEluTXMiLCJkZXNjcmlwdGlvbiIsIl9fREVWX18iLCJ0b3RhbFRpbWUiLCJzdGFydFRpbWVzcGFuIiwic3RhcnRUaW1lIiwiYmVnaW5Bc3luY0V2ZW50Iiwic3RvcFRpbWVzcGFuIiwidGltZXNwYW4iLCJlbmRUaW1lIiwiZW5kQXN5bmNFdmVudCIsImNsZWFyIiwiY2xlYXJDb21wbGV0ZWQiLCJjbGVhckV4Y2VwdFRpbWVzcGFucyIsImtleXMiLCJPYmplY3QiLCJyZWR1Y2UiLCJwcmV2aW91cyIsImluZGV4T2YiLCJjdXJyZW50VGltZXN0YW1wIiwiZ2V0VGltZXNwYW5zIiwiaGFzVGltZXNwYW4iLCJsb2dUaW1lc3BhbnMiLCJhZGRUaW1lc3BhbnMiLCJuZXdUaW1lc3BhbnMiLCJsYWJlbHMiLCJpaSIsImwiLCJsZW5ndGgiLCJsYWJlbCIsInNldEV4dHJhIiwidmFsdWUiLCJjdXJyZW50VmFsdWUiLCJhdHRlbXB0ZWRWYWx1ZSIsImdldEV4dHJhcyIsInJlbW92ZUV4dHJhIiwibG9nRXh0cmFzIiwibWFya1BvaW50IiwidGltZXN0YW1wIiwiZ2V0UG9pbnRzIiwibG9nUG9pbnRzIiwibG9nRXZlcnl0aGluZyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOztBQUVBLElBQU1BLFFBQVEsR0FBR0MsT0FBTywyQkFBeEI7O0FBRUEsSUFBTUMsT0FBTyxHQUFHRCxP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QUEsT0FBTyxDQUNMLDZFQURLLEVBRUxhLEdBRkssQ0FBUDtBQUlEOztBQUNEO0FBQ0Q7O0FBQ0QsV0FBS0YsT0FBTCxDQUFhRSxHQUFiLElBQW9CdUMsU0FBcEIsV0FBb0JBLFNBQXBCLEdBQWlDbkQsY0FBYyxFQUEvQztBQUNELEtBdkxDO0FBeUxGb0QsSUFBQUEsU0F6TEUsdUJBeUxVO0FBQ1YsYUFBTyxLQUFLMUMsT0FBWjtBQUNELEtBM0xDO0FBNkxGMkMsSUFBQUEsU0E3TEUsdUJBNkxVO0FBQ1YsVUFBSWhELGdCQUFKLEVBQXNCO0FBQ3BCLGFBQUssSUFBTU8sS0FBWCxJQUFrQixLQUFLRixPQUF2QixFQUFnQztBQUM5QlgsVUFBQUEsT0FBTyxDQUFDYSxLQUFHLEdBQUcsSUFBTixHQUFhLEtBQUtGLE9BQUwsQ0FBYUUsS0FBYixDQUFiLEdBQWlDLElBQWxDLENBQVA7QUFDRDtBQUNGO0FBQ0YsS0FuTUM7QUFxTUYwQyxJQUFBQSxhQXJNRSwyQkFxTWM7QUFDZCxXQUFLbkIsWUFBTDtBQUNBLFdBQUtjLFNBQUw7QUFDQSxXQUFLSSxTQUFMO0FBQ0Q7QUF6TUMsR0FKSjtBQStNQSxTQUFPOUMsTUFBUDtBQUNEOztBQUVEZ0QsTUFBTSxDQUFDQyxPQUFQLEdBQWlCbEQsdUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IFN5c3RyYWNlID0gcmVxdWlyZSgnLi4vUGVyZm9ybWFuY2UvU3lzdHJhY2UnKTtcblxuY29uc3QgaW5mb0xvZyA9IHJlcXVpcmUoJy4vaW5mb0xvZycpO1xuY29uc3QgcGVyZm9ybWFuY2VOb3cgPVxuICBnbG9iYWwubmF0aXZlUVBMVGltZXN0YW1wIHx8XG4gIGdsb2JhbC5uYXRpdmVQZXJmb3JtYW5jZU5vdyB8fFxuICByZXF1aXJlKCdmYmpzL2xpYi9wZXJmb3JtYW5jZU5vdycpO1xuXG50eXBlIFRpbWVzcGFuID0ge1xuICBkZXNjcmlwdGlvbj86IHN0cmluZyxcbiAgdG90YWxUaW1lPzogbnVtYmVyLFxuICBzdGFydFRpbWU/OiBudW1iZXIsXG4gIGVuZFRpbWU/OiBudW1iZXIsXG59O1xuXG5leHBvcnQgdHlwZSBJUGVyZm9ybWFuY2VMb2dnZXIgPSB7XG4gIGFkZFRpbWVzcGFuKHN0cmluZywgbnVtYmVyLCBzdHJpbmcgfCB2b2lkKTogdm9pZCxcbiAgc3RhcnRUaW1lc3BhbihzdHJpbmcsIHN0cmluZyB8IHZvaWQpOiB2b2lkLFxuICBzdG9wVGltZXNwYW4oc3RyaW5nKTogdm9pZCxcbiAgY2xlYXIoKTogdm9pZCxcbiAgY2xlYXJDb21wbGV0ZWQoKTogdm9pZCxcbiAgY2xlYXJFeGNlcHRUaW1lc3BhbnMoQXJyYXk8c3RyaW5nPik6IHZvaWQsXG4gIGN1cnJlbnRUaW1lc3RhbXAoKTogbnVtYmVyLFxuICBnZXRUaW1lc3BhbnMoKToge1trZXk6IHN0cmluZ106IFRpbWVzcGFufSxcbiAgaGFzVGltZXNwYW4oc3RyaW5nKTogYm9vbGVhbixcbiAgbG9nVGltZXNwYW5zKCk6IHZvaWQsXG4gIGFkZFRpbWVzcGFucyhBcnJheTxudW1iZXI+LCBBcnJheTxzdHJpbmc+KTogdm9pZCxcbiAgc2V0RXh0cmEoc3RyaW5nLCBhbnkpOiB2b2lkLFxuICBnZXRFeHRyYXMoKToge1trZXk6IHN0cmluZ106IGFueX0sXG4gIHJlbW92ZUV4dHJhKHN0cmluZyk6ID9hbnksXG4gIGxvZ0V4dHJhcygpOiB2b2lkLFxuICBtYXJrUG9pbnQoc3RyaW5nLCBudW1iZXIgfCB2b2lkKTogdm9pZCxcbiAgZ2V0UG9pbnRzKCk6IHtba2V5OiBzdHJpbmddOiBudW1iZXJ9LFxuICBsb2dQb2ludHMoKTogdm9pZCxcbiAgbG9nRXZlcnl0aGluZygpOiB2b2lkLFxufTtcblxuY29uc3QgX2Nvb2tpZXM6IHtba2V5OiBzdHJpbmddOiBudW1iZXJ9ID0ge307XG5cbmNvbnN0IFBSSU5UX1RPX0NPTlNPTEU6IGZhbHNlID0gZmFsc2U7IC8vIFR5cGUgYXMgZmFsc2UgdG8gcHJldmVudCBhY2NpZGVudGFsbHkgY29tbWl0dGluZyBgdHJ1ZWA7XG5cbi8qKlxuICogVGhpcyBmdW5jdGlvbiBjcmVhdGVzIHBlcmZvcm1hbmNlIGxvZ2dlcnMgdGhhdCBjYW4gYmUgdXNlZCB0byBjb2xsZWN0IGFuZCBsb2dcbiAqIHZhcmlvdXMgcGVyZm9ybWFuY2UgZGF0YSBzdWNoIGFzIHRpbWVzcGFucywgcG9pbnRzIGFuZCBleHRyYXMuXG4gKiBUaGUgbG9nZ2VycyBuZWVkIHRvIGhhdmUgbWluaW1hbCBvdmVyaGVhZCBzaW5jZSB0aGV5J3JlIHVzZWQgaW4gcHJvZHVjdGlvbi5cbiAqL1xuZnVuY3Rpb24gY3JlYXRlUGVyZm9ybWFuY2VMb2dnZXIoKTogSVBlcmZvcm1hbmNlTG9nZ2VyIHtcbiAgY29uc3QgcmVzdWx0OiBJUGVyZm9ybWFuY2VMb2dnZXIgJiB7XG4gICAgX3RpbWVzcGFuczoge1trZXk6IHN0cmluZ106IFRpbWVzcGFufSxcbiAgICBfZXh0cmFzOiB7W2tleTogc3RyaW5nXTogYW55fSxcbiAgICBfcG9pbnRzOiB7W2tleTogc3RyaW5nXTogbnVtYmVyfSxcbiAgfSA9IHtcbiAgICBfdGltZXNwYW5zOiB7fSxcbiAgICBfZXh0cmFzOiB7fSxcbiAgICBfcG9pbnRzOiB7fSxcblxuICAgIGFkZFRpbWVzcGFuKGtleTogc3RyaW5nLCBsZW5ndGhJbk1zOiBudW1iZXIsIGRlc2NyaXB0aW9uPzogc3RyaW5nKSB7XG4gICAgICBpZiAodGhpcy5fdGltZXNwYW5zW2tleV0pIHtcbiAgICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUgJiYgX19ERVZfXykge1xuICAgICAgICAgIGluZm9Mb2coXG4gICAgICAgICAgICAnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gYWRkIGEgdGltZXNwYW4gdGhhdCBhbHJlYWR5IGV4aXN0cyAnLFxuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl90aW1lc3BhbnNba2V5XSA9IHtcbiAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxuICAgICAgICB0b3RhbFRpbWU6IGxlbmd0aEluTXMsXG4gICAgICB9O1xuICAgIH0sXG5cbiAgICBzdGFydFRpbWVzcGFuKGtleTogc3RyaW5nLCBkZXNjcmlwdGlvbj86IHN0cmluZykge1xuICAgICAgaWYgKHRoaXMuX3RpbWVzcGFuc1trZXldKSB7XG4gICAgICAgIGlmIChQUklOVF9UT19DT05TT0xFICYmIF9fREVWX18pIHtcbiAgICAgICAgICBpbmZvTG9nKFxuICAgICAgICAgICAgJ1BlcmZvcm1hbmNlTG9nZ2VyOiBBdHRlbXB0aW5nIHRvIHN0YXJ0IGEgdGltZXNwYW4gdGhhdCBhbHJlYWR5IGV4aXN0cyAnLFxuICAgICAgICAgICAga2V5LFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl90aW1lc3BhbnNba2V5XSA9IHtcbiAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxuICAgICAgICBzdGFydFRpbWU6IHBlcmZvcm1hbmNlTm93KCksXG4gICAgICB9O1xuICAgICAgX2Nvb2tpZXNba2V5XSA9IFN5c3RyYWNlLmJlZ2luQXN5bmNFdmVudChrZXkpO1xuICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUpIHtcbiAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXIuanMnLCAnc3RhcnQ6ICcgKyBrZXkpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBzdG9wVGltZXNwYW4oa2V5OiBzdHJpbmcpIHtcbiAgICAgIGNvbnN0IHRpbWVzcGFuID0gdGhpcy5fdGltZXNwYW5zW2tleV07XG4gICAgICBpZiAoIXRpbWVzcGFuIHx8ICF0aW1lc3Bhbi5zdGFydFRpbWUpIHtcbiAgICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUgJiYgX19ERVZfXykge1xuICAgICAgICAgIGluZm9Mb2coXG4gICAgICAgICAgICAnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gZW5kIGEgdGltZXNwYW4gdGhhdCBoYXMgbm90IHN0YXJ0ZWQgJyxcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh0aW1lc3Bhbi5lbmRUaW1lKSB7XG4gICAgICAgIGlmIChQUklOVF9UT19DT05TT0xFICYmIF9fREVWX18pIHtcbiAgICAgICAgICBpbmZvTG9nKFxuICAgICAgICAgICAgJ1BlcmZvcm1hbmNlTG9nZ2VyOiBBdHRlbXB0aW5nIHRvIGVuZCBhIHRpbWVzcGFuIHRoYXQgaGFzIGFscmVhZHkgZW5kZWQgJyxcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGltZXNwYW4uZW5kVGltZSA9IHBlcmZvcm1hbmNlTm93KCk7XG4gICAgICB0aW1lc3Bhbi50b3RhbFRpbWUgPSB0aW1lc3Bhbi5lbmRUaW1lIC0gKHRpbWVzcGFuLnN0YXJ0VGltZSB8fCAwKTtcbiAgICAgIGlmIChQUklOVF9UT19DT05TT0xFKSB7XG4gICAgICAgIGluZm9Mb2coJ1BlcmZvcm1hbmNlTG9nZ2VyLmpzJywgJ2VuZDogJyArIGtleSk7XG4gICAgICB9XG5cbiAgICAgIFN5c3RyYWNlLmVuZEFzeW5jRXZlbnQoa2V5LCBfY29va2llc1trZXldKTtcbiAgICAgIGRlbGV0ZSBfY29va2llc1trZXldO1xuICAgIH0sXG5cbiAgICBjbGVhcigpIHtcbiAgICAgIHRoaXMuX3RpbWVzcGFucyA9IHt9O1xuICAgICAgdGhpcy5fZXh0cmFzID0ge307XG4gICAgICB0aGlzLl9wb2ludHMgPSB7fTtcbiAgICAgIGlmIChQUklOVF9UT19DT05TT0xFKSB7XG4gICAgICAgIGluZm9Mb2coJ1BlcmZvcm1hbmNlTG9nZ2VyLmpzJywgJ2NsZWFyJyk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIGNsZWFyQ29tcGxldGVkKCkge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5fdGltZXNwYW5zKSB7XG4gICAgICAgIGlmICh0aGlzLl90aW1lc3BhbnNba2V5XS50b3RhbFRpbWUpIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fdGltZXNwYW5zW2tleV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuX2V4dHJhcyA9IHt9O1xuICAgICAgdGhpcy5fcG9pbnRzID0ge307XG4gICAgICBpZiAoUFJJTlRfVE9fQ09OU09MRSkge1xuICAgICAgICBpbmZvTG9nKCdQZXJmb3JtYW5jZUxvZ2dlci5qcycsICdjbGVhckNvbXBsZXRlZCcpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBjbGVhckV4Y2VwdFRpbWVzcGFucyhrZXlzOiBBcnJheTxzdHJpbmc+KSB7XG4gICAgICB0aGlzLl90aW1lc3BhbnMgPSBPYmplY3Qua2V5cyh0aGlzLl90aW1lc3BhbnMpLnJlZHVjZShmdW5jdGlvbihcbiAgICAgICAgcHJldmlvdXMsXG4gICAgICAgIGtleSxcbiAgICAgICkge1xuICAgICAgICBpZiAoa2V5cy5pbmRleE9mKGtleSkgIT09IC0xKSB7XG4gICAgICAgICAgcHJldmlvdXNba2V5XSA9IHRoaXMuX3RpbWVzcGFuc1trZXldO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBwcmV2aW91cztcbiAgICAgIH0sXG4gICAgICB7fSk7XG4gICAgICB0aGlzLl9leHRyYXMgPSB7fTtcbiAgICAgIHRoaXMuX3BvaW50cyA9IHt9O1xuICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUpIHtcbiAgICAgICAgaW5mb0xvZygnUGVyZm9ybWFuY2VMb2dnZXIuanMnLCAnY2xlYXJFeGNlcHRUaW1lc3BhbnMnLCBrZXlzKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgY3VycmVudFRpbWVzdGFtcCgpIHtcbiAgICAgIHJldHVybiBwZXJmb3JtYW5jZU5vdygpO1xuICAgIH0sXG5cbiAgICBnZXRUaW1lc3BhbnMoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fdGltZXNwYW5zO1xuICAgIH0sXG5cbiAgICBoYXNUaW1lc3BhbihrZXk6IHN0cmluZykge1xuICAgICAgcmV0dXJuICEhdGhpcy5fdGltZXNwYW5zW2tleV07XG4gICAgfSxcblxuICAgIGxvZ1RpbWVzcGFucygpIHtcbiAgICAgIGlmIChQUklOVF9UT19DT05TT0xFKSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3RpbWVzcGFucykge1xuICAgICAgICAgIGlmICh0aGlzLl90aW1lc3BhbnNba2V5XS50b3RhbFRpbWUpIHtcbiAgICAgICAgICAgIGluZm9Mb2coa2V5ICsgJzogJyArIHRoaXMuX3RpbWVzcGFuc1trZXldLnRvdGFsVGltZSArICdtcycpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG5cbiAgICBhZGRUaW1lc3BhbnMobmV3VGltZXNwYW5zOiBBcnJheTxudW1iZXI+LCBsYWJlbHM6IEFycmF5PHN0cmluZz4pIHtcbiAgICAgIGZvciAobGV0IGlpID0gMCwgbCA9IG5ld1RpbWVzcGFucy5sZW5ndGg7IGlpIDwgbDsgaWkgKz0gMikge1xuICAgICAgICBjb25zdCBsYWJlbCA9IGxhYmVsc1tpaSAvIDJdO1xuICAgICAgICB0aGlzLmFkZFRpbWVzcGFuKGxhYmVsLCBuZXdUaW1lc3BhbnNbaWkgKyAxXSAtIG5ld1RpbWVzcGFuc1tpaV0sIGxhYmVsKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgc2V0RXh0cmEoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICAgIGlmICh0aGlzLl9leHRyYXNba2V5XSkge1xuICAgICAgICBpZiAoUFJJTlRfVE9fQ09OU09MRSAmJiBfX0RFVl9fKSB7XG4gICAgICAgICAgaW5mb0xvZyhcbiAgICAgICAgICAgICdQZXJmb3JtYW5jZUxvZ2dlcjogQXR0ZW1wdGluZyB0byBzZXQgYW4gZXh0cmEgdGhhdCBhbHJlYWR5IGV4aXN0cyAnLFxuICAgICAgICAgICAge2tleSwgY3VycmVudFZhbHVlOiB0aGlzLl9leHRyYXNba2V5XSwgYXR0ZW1wdGVkVmFsdWU6IHZhbHVlfSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuX2V4dHJhc1trZXldID0gdmFsdWU7XG4gICAgfSxcblxuICAgIGdldEV4dHJhcygpIHtcbiAgICAgIHJldHVybiB0aGlzLl9leHRyYXM7XG4gICAgfSxcblxuICAgIHJlbW92ZUV4dHJhKGtleTogc3RyaW5nKTogP2FueSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuX2V4dHJhc1trZXldO1xuICAgICAgZGVsZXRlIHRoaXMuX2V4dHJhc1trZXldO1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH0sXG5cbiAgICBsb2dFeHRyYXMoKSB7XG4gICAgICBpZiAoUFJJTlRfVE9fQ09OU09MRSkge1xuICAgICAgICBpbmZvTG9nKHRoaXMuX2V4dHJhcyk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIG1hcmtQb2ludChrZXk6IHN0cmluZywgdGltZXN0YW1wPzogbnVtYmVyKSB7XG4gICAgICBpZiAodGhpcy5fcG9pbnRzW2tleV0pIHtcbiAgICAgICAgaWYgKFBSSU5UX1RPX0NPTlNPTEUgJiYgX19ERVZfXykge1xuICAgICAgICAgIGluZm9Mb2coXG4gICAgICAgICAgICAnUGVyZm9ybWFuY2VMb2dnZXI6IEF0dGVtcHRpbmcgdG8gbWFyayBhIHBvaW50IHRoYXQgaGFzIGJlZW4gYWxyZWFkeSBsb2dnZWQgJyxcbiAgICAgICAgICAgIGtleSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMuX3BvaW50c1trZXldID0gdGltZXN0YW1wID8/IHBlcmZvcm1hbmNlTm93KCk7XG4gICAgfSxcblxuICAgIGdldFBvaW50cygpIHtcbiAgICAgIHJldHVybiB0aGlzLl9wb2ludHM7XG4gICAgfSxcblxuICAgIGxvZ1BvaW50cygpIHtcbiAgICAgIGlmIChQUklOVF9UT19DT05TT0xFKSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuX3BvaW50cykge1xuICAgICAgICAgIGluZm9Mb2coa2V5ICsgJzogJyArIHRoaXMuX3BvaW50c1trZXldICsgJ21zJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuXG4gICAgbG9nRXZlcnl0aGluZygpIHtcbiAgICAgIHRoaXMubG9nVGltZXNwYW5zKCk7XG4gICAgICB0aGlzLmxvZ0V4dHJhcygpO1xuICAgICAgdGhpcy5sb2dQb2ludHMoKTtcbiAgICB9LFxuICB9O1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGNyZWF0ZVBlcmZvcm1hbmNlTG9nZ2VyO1xuIl19
74d116815952e3ad6662f17bf20d0ec1
var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Asset = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _core = require("@unimodules/core");

var _AssetRegistry = require("./AssetRegistry");

var AssetSources = _interopRequireWildcard(require("./AssetSources"));

var AssetUris = _interopRequireWildcard(require("./AssetUris"));

var _EmbeddedAssets = require("./EmbeddedAssets");

var ImageAssets = _interopRequireWildcard(require("./ImageAssets"));

var _PlatformUtils = require("./PlatformUtils");

var _resolveAssetSource2 = _interopRequireDefault(require("./resolveAssetSource"));

var Asset = function () {
  function Asset(_ref) {
    var name = _ref.name,
        type = _ref.type,
        _ref$hash = _ref.hash,
        hash = _ref$hash === void 0 ? null : _ref$hash,
        uri = _ref.uri,
        width = _ref.width,
        height = _ref.height;
    (0, _classCallCheck2.default)(this, Asset);
    this.hash = null;
    this.localUri = null;
    this.width = null;
    this.height = null;
    this.downloading = false;
    this.downloaded = false;
    this._downloadCallbacks = [];
    this.name = name;
    this.type = type;
    this.hash = hash;
    this.uri = uri;

    if (typeof width === 'number') {
      this.width = width;
    }

    if (typeof height === 'number') {
      this.height = height;
    }

    if (_PlatformUtils.IS_MANAGED_ENV && hash) {
      this.localUri = (0, _EmbeddedAssets.getEmbeddedAssetUri)(hash, type);

      if (this.localUri) {
        this.downloaded = true;
      }
    }

    if (_core.Platform.OS === 'web') {
      if (!name) {
        this.name = AssetUris.getFilename(uri);
      }

      if (!type) {
        this.type = AssetUris.getFileExtension(uri);
      }
    }
  }

  (0, _createClass2.default)(Asset, [{
    key: "downloadAsync",
    value: function downloadAsync() {
      var _this = this;

      var _ref2, width, height, name;

      return _regenerator.default.async(function downloadAsync$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              if (!this.downloaded) {
                _context.next = 2;
                break;
              }

              return _context.abrupt("return");

            case 2:
              if (!this.downloading) {
                _context.next = 6;
                break;
              }

              _context.next = 5;
              return _regenerator.default.awrap(new Promise(function (resolve, reject) {
                _this._downloadCallbacks.push({
                  resolve: resolve,
                  reject: reject
                });
              }));

            case 5:
              return _context.abrupt("return");

            case 6:
              this.downloading = true;
              _context.prev = 7;

              if (!(_core.Platform.OS === 'web')) {
                _context.next = 22;
                break;
              }

              if (!ImageAssets.isImageType(this.type)) {
                _context.next = 21;
                break;
              }

              _context.next = 12;
              return _regenerator.default.awrap(ImageAssets.getImageInfoAsync(this.uri));

            case 12:
              _ref2 = _context.sent;
              width = _ref2.width;
              height = _ref2.height;
              name = _ref2.name;
              this.width = width;
              this.height = height;
              this.name = name;
              _context.next = 22;
              break;

            case 21:
              this.name = AssetUris.getFilename(this.uri);

            case 22:
              _context.next = 24;
              return _regenerator.default.awrap((0, _PlatformUtils.downloadAsync)(this.uri, this.hash, this.type, this.name));

            case 24:
              this.localUri = _context.sent;
              this.downloaded = true;

              this._downloadCallbacks.forEach(function (_ref3) {
                var resolve = _ref3.resolve;
                return resolve();
              });

              _context.next = 33;
              break;

            case 29:
              _context.prev = 29;
              _context.t0 = _context["catch"](7);

              this._downloadCallbacks.forEach(function (_ref4) {
                var reject = _ref4.reject;
                return reject(_context.t0);
              });

              throw _context.t0;

            case 33:
              _context.prev = 33;
              this.downloading = false;
              this._downloadCallbacks = [];
              return _context.finish(33);

            case 37:
            case "end":
              return _context.stop();
          }
        }
      }, null, this, [[7, 29, 33, 37]]);
    }
  }], [{
    key: "loadAsync",
    value: function loadAsync(moduleId) {
      var moduleIds = Array.isArray(moduleId) ? moduleId : [moduleId];
      return Promise.all(moduleIds.map(function (moduleId) {
        return Asset.fromModule(moduleId).downloadAsync();
      }));
    }
  }, {
    key: "fromModule",
    value: function fromModule(virtualAssetModule) {
      if (typeof virtualAssetModule === 'string') {
        return Asset.fromURI(virtualAssetModule);
      }

      var meta = (0, _AssetRegistry.getAssetByID)(virtualAssetModule);

      if (!meta) {
        throw new Error("Module \"" + virtualAssetModule + "\" is missing from the asset registry");
      }

      if (!_PlatformUtils.IS_MANAGED_ENV) {
        var _resolveAssetSource = (0, _resolveAssetSource2.default)(virtualAssetModule),
            uri = _resolveAssetSource.uri;

        var asset = new Asset({
          name: meta.name,
          type: meta.type,
          hash: meta.hash,
          uri: uri,
          width: meta.width,
          height: meta.height
        });

        if (_core.Platform.OS === 'android' && !uri.includes(':') && (meta.width || meta.height)) {
          asset.localUri = asset.uri;
          asset.downloaded = true;
        }

        Asset.byHash[meta.hash] = asset;
        return asset;
      }

      return Asset.fromMetadata(meta);
    }
  }, {
    key: "fromMetadata",
    value: function fromMetadata(meta) {
      var metaHash = meta.hash;

      if (Asset.byHash[metaHash]) {
        return Asset.byHash[metaHash];
      } else if (!_PlatformUtils.IS_MANAGED_ENV && !Asset.byHash[metaHash]) {
        throw new Error('Assets must be initialized with Asset.fromModule');
      }

      var _AssetSources$selectA = AssetSources.selectAssetSource(meta),
          uri = _AssetSources$selectA.uri,
          hash = _AssetSources$selectA.hash;

      var asset = new Asset({
        name: meta.name,
        type: meta.type,
        hash: hash,
        uri: uri,
        width: meta.width,
        height: meta.height
      });
      Asset.byHash[metaHash] = asset;
      return asset;
    }
  }, {
    key: "fromURI",
    value: function fromURI(uri) {
      if (Asset.byUri[uri]) {
        return Asset.byUri[uri];
      }

      var type = '';

      if (uri.indexOf(';base64') > -1) {
        type = uri.split(';')[0].split('/')[1];
      } else {
        var extension = AssetUris.getFileExtension(uri);
        type = extension.startsWith('.') ? extension.substring(1) : extension;
      }

      var asset = new Asset({
        name: '',
        type: type,
        hash: null,
        uri: uri
      });
      Asset.byUri[uri] = asset;
      return asset;
    }
  }]);
  return Asset;
}();

exports.Asset = Asset;
Asset.byHash = {};
Asset.byUri = {};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QixRQUFBLEdBQUcsRUFBSDtBQUpzQixPQUFWLENBQWQ7QUFPQSxNQUFBLEtBQUssQ0FBQyxLQUFOLENBQVksR0FBWixJQUFtQixLQUFuQjtBQUVBLGFBQU8sS0FBUDtBQUNEOzs7Ozs7QUF2SU0sS0FBQSxDQUFBLE1BQUEsR0FBUyxFQUFUO0FBQ0EsS0FBQSxDQUFBLEtBQUEsR0FBUSxFQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAdW5pbW9kdWxlcy9jb3JlJztcblxuaW1wb3J0IHsgZ2V0QXNzZXRCeUlEIH0gZnJvbSAnLi9Bc3NldFJlZ2lzdHJ5JztcbmltcG9ydCAqIGFzIEFzc2V0U291cmNlcyBmcm9tICcuL0Fzc2V0U291cmNlcyc7XG5pbXBvcnQgKiBhcyBBc3NldFVyaXMgZnJvbSAnLi9Bc3NldFVyaXMnO1xuaW1wb3J0IHsgZ2V0RW1iZWRkZWRBc3NldFVyaSB9IGZyb20gJy4vRW1iZWRkZWRBc3NldHMnO1xuaW1wb3J0ICogYXMgSW1hZ2VBc3NldHMgZnJvbSAnLi9JbWFnZUFzc2V0cyc7XG5pbXBvcnQgeyBkb3dubG9hZEFzeW5jLCBJU19NQU5BR0VEX0VOViB9IGZyb20gJy4vUGxhdGZvcm1VdGlscyc7XG5pbXBvcnQgcmVzb2x2ZUFzc2V0U291cmNlIGZyb20gJy4vcmVzb2x2ZUFzc2V0U291cmNlJztcblxudHlwZSBBc3NldERlc2NyaXB0b3IgPSB7XG4gIG5hbWU6IHN0cmluZztcbiAgdHlwZTogc3RyaW5nO1xuICBoYXNoPzogc3RyaW5nIHwgbnVsbDtcbiAgdXJpOiBzdHJpbmc7XG4gIHdpZHRoPzogbnVtYmVyIHwgbnVsbDtcbiAgaGVpZ2h0PzogbnVtYmVyIHwgbnVsbDtcbn07XG5cbnR5cGUgRG93bmxvYWRQcm9taXNlQ2FsbGJhY2tzID0ge1xuICByZXNvbHZlOiAoKSA9PiB2b2lkO1xuICByZWplY3Q6IChlcnJvcjogRXJyb3IpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBBc3NldE1ldGFkYXRhID0gQXNzZXRTb3VyY2VzLkFzc2V0TWV0YWRhdGE7XG5cbmV4cG9ydCBjbGFzcyBBc3NldCB7XG4gIHN0YXRpYyBieUhhc2ggPSB7fTtcbiAgc3RhdGljIGJ5VXJpID0ge307XG5cbiAgbmFtZTogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGhhc2g6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICB1cmk6IHN0cmluZztcbiAgbG9jYWxVcmk6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICB3aWR0aDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIGhlaWdodDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIGRvd25sb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIGRvd25sb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgX2Rvd25sb2FkQ2FsbGJhY2tzOiBEb3dubG9hZFByb21pc2VDYWxsYmFja3NbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHsgbmFtZSwgdHlwZSwgaGFzaCA9IG51bGwsIHVyaSwgd2lkdGgsIGhlaWdodCB9OiBBc3NldERlc2NyaXB0b3IpIHtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMudHlwZSA9IHR5cGU7XG4gICAgdGhpcy5oYXNoID0gaGFzaDtcbiAgICB0aGlzLnVyaSA9IHVyaTtcblxuICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICdudW1iZXInKSB7XG4gICAgICB0aGlzLndpZHRoID0gd2lkdGg7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgaGVpZ2h0ID09PSAnbnVtYmVyJykge1xuICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgfVxuXG4gICAgLy8gVGhpcyBvbmx5IGFwcGxpZXMgdG8gYXNzZXRzIHRoYXQgYXJlIGJ1bmRsZWQgaW4gRXhwbyBzdGFuZGFsb25lIGFwcHNcbiAgICBpZiAoSVNfTUFOQUdFRF9FTlYgJiYgaGFzaCkge1xuICAgICAgdGhpcy5sb2NhbFVyaSA9IGdldEVtYmVkZGVkQXNzZXRVcmkoaGFzaCwgdHlwZSk7XG4gICAgICBpZiAodGhpcy5sb2NhbFVyaSkge1xuICAgICAgICB0aGlzLmRvd25sb2FkZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICd3ZWInKSB7XG4gICAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gQXNzZXRVcmlzLmdldEZpbGVuYW1lKHVyaSk7XG4gICAgICB9XG4gICAgICBpZiAoIXR5cGUpIHtcbiAgICAgICAgdGhpcy50eXBlID0gQXNzZXRVcmlzLmdldEZpbGVFeHRlbnNpb24odXJpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdGF0aWMgbG9hZEFzeW5jKG1vZHVsZUlkOiBudW1iZXIgfCBudW1iZXJbXSk6IFByb21pc2U8dm9pZFtdPiB7XG4gICAgY29uc3QgbW9kdWxlSWRzID0gQXJyYXkuaXNBcnJheShtb2R1bGVJZCkgPyBtb2R1bGVJZCA6IFttb2R1bGVJZF07XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKG1vZHVsZUlkcy5tYXAobW9kdWxlSWQgPT4gQXNzZXQuZnJvbU1vZHVsZShtb2R1bGVJZCkuZG93bmxvYWRBc3luYygpKSk7XG4gIH1cblxuICBzdGF0aWMgZnJvbU1vZHVsZSh2aXJ0dWFsQXNzZXRNb2R1bGU6IG51bWJlciB8IHN0cmluZyk6IEFzc2V0IHtcbiAgICBpZiAodHlwZW9mIHZpcnR1YWxBc3NldE1vZHVsZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBBc3NldC5mcm9tVVJJKHZpcnR1YWxBc3NldE1vZHVsZSk7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YSA9IGdldEFzc2V0QnlJRCh2aXJ0dWFsQXNzZXRNb2R1bGUpO1xuICAgIGlmICghbWV0YSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2R1bGUgXCIke3ZpcnR1YWxBc3NldE1vZHVsZX1cIiBpcyBtaXNzaW5nIGZyb20gdGhlIGFzc2V0IHJlZ2lzdHJ5YCk7XG4gICAgfVxuXG4gICAgLy8gT3V0c2lkZSBvZiB0aGUgbWFuYWdlZCBlbnYgd2UgbmVlZCB0aGUgbW9kdWxlSWQgdG8gaW5pdGlhbGl6ZSB0aGUgYXNzZXRcbiAgICAvLyBiZWNhdXNlIHJlc29sdmVBc3NldFNvdXJjZSBkZXBlbmRzIG9uIGl0XG4gICAgaWYgKCFJU19NQU5BR0VEX0VOVikge1xuICAgICAgY29uc3QgeyB1cmkgfSA9IHJlc29sdmVBc3NldFNvdXJjZSh2aXJ0dWFsQXNzZXRNb2R1bGUpO1xuICAgICAgY29uc3QgYXNzZXQgPSBuZXcgQXNzZXQoe1xuICAgICAgICBuYW1lOiBtZXRhLm5hbWUsXG4gICAgICAgIHR5cGU6IG1ldGEudHlwZSxcbiAgICAgICAgaGFzaDogbWV0YS5oYXNoLFxuICAgICAgICB1cmksXG4gICAgICAgIHdpZHRoOiBtZXRhLndpZHRoLFxuICAgICAgICBoZWlnaHQ6IG1ldGEuaGVpZ2h0LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFRPRE86IEZpbGVTeXN0ZW0gc2hvdWxkIHByb2JhYmx5IHN1cHBvcnQgJ2Rvd25sb2FkaW5nJyBmcm9tIGRyYXdhYmxlXG4gICAgICAvLyByZXNvdXJjZXMgQnV0IGZvciBub3cgaXQgZG9lc24ndCAoaXQgb25seSBzdXBwb3J0cyByYXcgcmVzb3VyY2VzKSBhbmRcbiAgICAgIC8vIFJlYWN0IE5hdGl2ZSdzIEltYWdlIHdvcmtzIGZpbmUgd2l0aCBkcmF3YWJsZSByZXNvdXJjZSBuYW1lcyBmb3JcbiAgICAgIC8vIGltYWdlcy5cbiAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnICYmICF1cmkuaW5jbHVkZXMoJzonKSAmJiAobWV0YS53aWR0aCB8fCBtZXRhLmhlaWdodCkpIHtcbiAgICAgICAgYXNzZXQubG9jYWxVcmkgPSBhc3NldC51cmk7XG4gICAgICAgIGFzc2V0LmRvd25sb2FkZWQgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBBc3NldC5ieUhhc2hbbWV0YS5oYXNoXSA9IGFzc2V0O1xuICAgICAgcmV0dXJuIGFzc2V0O1xuICAgIH1cblxuICAgIHJldHVybiBBc3NldC5mcm9tTWV0YWRhdGEobWV0YSk7XG4gIH1cblxuICBzdGF0aWMgZnJvbU1ldGFkYXRhKG1ldGE6IEFzc2V0TWV0YWRhdGEpOiBBc3NldCB7XG4gICAgLy8gVGhlIGhhc2ggb2YgdGhlIHdob2xlIGFzc2V0LCBub3QgdG8gYmUgY29uZnVzZWQgd2l0aCB0aGUgaGFzaCBvZiBhIHNwZWNpZmljIGZpbGUgcmV0dXJuZWRcbiAgICAvLyBmcm9tIGBzZWxlY3RBc3NldFNvdXJjZWBcbiAgICBjb25zdCBtZXRhSGFzaCA9IG1ldGEuaGFzaDtcbiAgICBpZiAoQXNzZXQuYnlIYXNoW21ldGFIYXNoXSkge1xuICAgICAgcmV0dXJuIEFzc2V0LmJ5SGFzaFttZXRhSGFzaF07XG4gICAgfSBlbHNlIGlmICghSVNfTUFOQUdFRF9FTlYgJiYgIUFzc2V0LmJ5SGFzaFttZXRhSGFzaF0pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQXNzZXRzIG11c3QgYmUgaW5pdGlhbGl6ZWQgd2l0aCBBc3NldC5mcm9tTW9kdWxlJyk7XG4gICAgfVxuXG4gICAgY29uc3QgeyB1cmksIGhhc2ggfSA9IEFzc2V0U291cmNlcy5zZWxlY3RBc3NldFNvdXJjZShtZXRhKTtcbiAgICBjb25zdCBhc3NldCA9IG5ldyBBc3NldCh7XG4gICAgICBuYW1lOiBtZXRhLm5hbWUsXG4gICAgICB0eXBlOiBtZXRhLnR5cGUsXG4gICAgICBoYXNoLFxuICAgICAgdXJpLFxuICAgICAgd2lkdGg6IG1ldGEud2lkdGgsXG4gICAgICBoZWlnaHQ6IG1ldGEuaGVpZ2h0LFxuICAgIH0pO1xuICAgIEFzc2V0LmJ5SGFzaFttZXRhSGFzaF0gPSBhc3NldDtcbiAgICByZXR1cm4gYXNzZXQ7XG4gIH1cblxuICBzdGF0aWMgZnJvbVVSSSh1cmk6IHN0cmluZyk6IEFzc2V0IHtcbiAgICBpZiAoQXNzZXQuYnlVcmlbdXJpXSkge1xuICAgICAgcmV0dXJuIEFzc2V0LmJ5VXJpW3VyaV07XG4gICAgfVxuXG4gICAgLy8gUG9zc2libHkgYSBCYXNlNjQtZW5jb2RlZCBVUklcbiAgICBsZXQgdHlwZSA9ICcnO1xuICAgIGlmICh1cmkuaW5kZXhPZignO2Jhc2U2NCcpID4gLTEpIHtcbiAgICAgIHR5cGUgPSB1cmkuc3BsaXQoJzsnKVswXS5zcGxpdCgnLycpWzFdO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBleHRlbnNpb24gPSBBc3NldFVyaXMuZ2V0RmlsZUV4dGVuc2lvbih1cmkpO1xuICAgICAgdHlwZSA9IGV4dGVuc2lvbi5zdGFydHNXaXRoKCcuJykgPyBleHRlbnNpb24uc3Vic3RyaW5nKDEpIDogZXh0ZW5zaW9uO1xuICAgIH1cblxuICAgIGNvbnN0IGFzc2V0ID0gbmV3IEFzc2V0KHtcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgdHlwZSxcbiAgICAgIGhhc2g6IG51bGwsXG4gICAgICB1cmksXG4gICAgfSk7XG5cbiAgICBBc3NldC5ieVVyaVt1cmldID0gYXNzZXQ7XG5cbiAgICByZXR1cm4gYXNzZXQ7XG4gIH1cblxuICBhc3luYyBkb3dubG9hZEFzeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmRvd25sb2FkZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuZG93bmxvYWRpbmcpIHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy5fZG93bmxvYWRDYWxsYmFja3MucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRvd25sb2FkaW5nID0gdHJ1ZTtcblxuICAgIHRyeSB7XG4gICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICd3ZWInKSB7XG4gICAgICAgIGlmIChJbWFnZUFzc2V0cy5pc0ltYWdlVHlwZSh0aGlzLnR5cGUpKSB7XG4gICAgICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0LCBuYW1lIH0gPSBhd2FpdCBJbWFnZUFzc2V0cy5nZXRJbWFnZUluZm9Bc3luYyh0aGlzLnVyaSk7XG4gICAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5uYW1lID0gQXNzZXRVcmlzLmdldEZpbGVuYW1lKHRoaXMudXJpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5sb2NhbFVyaSA9IGF3YWl0IGRvd25sb2FkQXN5bmModGhpcy51cmksIHRoaXMuaGFzaCwgdGhpcy50eXBlLCB0aGlzLm5hbWUpO1xuXG4gICAgICB0aGlzLmRvd25sb2FkZWQgPSB0cnVlO1xuICAgICAgdGhpcy5fZG93bmxvYWRDYWxsYmFja3MuZm9yRWFjaCgoeyByZXNvbHZlIH0pID0+IHJlc29sdmUoKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5fZG93bmxvYWRDYWxsYmFja3MuZm9yRWFjaCgoeyByZWplY3QgfSkgPT4gcmVqZWN0KGUpKTtcbiAgICAgIHRocm93IGU7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuZG93bmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIHRoaXMuX2Rvd25sb2FkQ2FsbGJhY2tzID0gW107XG4gICAgfVxuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9
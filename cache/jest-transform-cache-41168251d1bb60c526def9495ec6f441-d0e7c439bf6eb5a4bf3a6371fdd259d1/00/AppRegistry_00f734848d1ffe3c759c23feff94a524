8463f635c2ef77fbe84c5107e6c3bc1e
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _NativeHeadlessJsTaskSupport = _interopRequireDefault(require("./NativeHeadlessJsTaskSupport"));

var _HeadlessJsTaskError = _interopRequireDefault(require("./HeadlessJsTaskError"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var BatchedBridge = require("../BatchedBridge/BatchedBridge");

var BugReporting = require("../BugReporting/BugReporting");

var ReactNative = require("../Renderer/shims/ReactNative");

var SceneTracker = require("../Utilities/SceneTracker");

var infoLog = require("../Utilities/infoLog");

var invariant = require('invariant');

var renderApplication = require("./renderApplication");

var createPerformanceLogger = require("../Utilities/createPerformanceLogger");

var runnables = {};
var runCount = 1;
var sections = {};
var taskProviders = new Map();
var taskCancelProviders = new Map();

var componentProviderInstrumentationHook = function componentProviderInstrumentationHook(component) {
  return component();
};

var wrapperComponentProvider;
var showFabricIndicator = false;
var AppRegistry = {
  setWrapperComponentProvider: function setWrapperComponentProvider(provider) {
    wrapperComponentProvider = provider;
  },
  enableFabricIndicator: function enableFabricIndicator(enabled) {
    showFabricIndicator = enabled;
  },
  registerConfig: function registerConfig(config) {
    config.forEach(function (appConfig) {
      if (appConfig.run) {
        AppRegistry.registerRunnable(appConfig.appKey, appConfig.run);
      } else {
        invariant(appConfig.component != null, 'AppRegistry.registerConfig(...): Every config is expected to set ' + 'either `run` or `component`, but `%s` has neither.', appConfig.appKey);
        AppRegistry.registerComponent(appConfig.appKey, appConfig.component, appConfig.section);
      }
    });
  },
  registerComponent: function registerComponent(appKey, componentProvider, section) {
    var scopedPerformanceLogger = createPerformanceLogger();
    runnables[appKey] = {
      componentProvider: componentProvider,
      run: function run(appParameters) {
        renderApplication(componentProviderInstrumentationHook(componentProvider, scopedPerformanceLogger), appParameters.initialProps, appParameters.rootTag, wrapperComponentProvider && wrapperComponentProvider(appParameters), appParameters.fabric, showFabricIndicator, scopedPerformanceLogger);
      }
    };

    if (section) {
      sections[appKey] = runnables[appKey];
    }

    return appKey;
  },
  registerRunnable: function registerRunnable(appKey, run) {
    runnables[appKey] = {
      run: run
    };
    return appKey;
  },
  registerSection: function registerSection(appKey, component) {
    AppRegistry.registerComponent(appKey, component, true);
  },
  getAppKeys: function getAppKeys() {
    return Object.keys(runnables);
  },
  getSectionKeys: function getSectionKeys() {
    return Object.keys(sections);
  },
  getSections: function getSections() {
    return _objectSpread({}, sections);
  },
  getRunnable: function getRunnable(appKey) {
    return runnables[appKey];
  },
  getRegistry: function getRegistry() {
    return {
      sections: AppRegistry.getSectionKeys(),
      runnables: _objectSpread({}, runnables)
    };
  },
  setComponentProviderInstrumentationHook: function setComponentProviderInstrumentationHook(hook) {
    componentProviderInstrumentationHook = hook;
  },
  runApplication: function runApplication(appKey, appParameters) {
    var msg = 'Running "' + appKey + '" with ' + JSON.stringify(appParameters);
    infoLog(msg);
    BugReporting.addSource('AppRegistry.runApplication' + runCount++, function () {
      return msg;
    });
    invariant(runnables[appKey] && runnables[appKey].run, "\"" + appKey + "\" has not been registered. This can happen if:\n" + '* Metro (the local dev server) is run from the wrong folder. ' + 'Check if Metro is running, stop it and restart it in the current project.\n' + "* A module failed to load due to an error and `AppRegistry.registerComponent` wasn't called.");
    SceneTracker.setActiveScene({
      name: appKey
    });
    runnables[appKey].run(appParameters);
  },
  unmountApplicationComponentAtRootTag: function unmountApplicationComponentAtRootTag(rootTag) {
    ReactNative.unmountComponentAtNodeAndRemoveContainer(rootTag);
  },
  registerHeadlessTask: function registerHeadlessTask(taskKey, taskProvider) {
    this.registerCancellableHeadlessTask(taskKey, taskProvider, function () {
      return function () {};
    });
  },
  registerCancellableHeadlessTask: function registerCancellableHeadlessTask(taskKey, taskProvider, taskCancelProvider) {
    if (taskProviders.has(taskKey)) {
      console.warn("registerHeadlessTask or registerCancellableHeadlessTask called multiple times for same key '" + taskKey + "'");
    }

    taskProviders.set(taskKey, taskProvider);
    taskCancelProviders.set(taskKey, taskCancelProvider);
  },
  startHeadlessTask: function startHeadlessTask(taskId, taskKey, data) {
    var taskProvider = taskProviders.get(taskKey);

    if (!taskProvider) {
      console.warn("No task registered for key " + taskKey);

      if (_NativeHeadlessJsTaskSupport.default) {
        _NativeHeadlessJsTaskSupport.default.notifyTaskFinished(taskId);
      }

      return;
    }

    taskProvider()(data).then(function () {
      if (_NativeHeadlessJsTaskSupport.default) {
        _NativeHeadlessJsTaskSupport.default.notifyTaskFinished(taskId);
      }
    }).catch(function (reason) {
      console.error(reason);

      if (_NativeHeadlessJsTaskSupport.default && reason instanceof _HeadlessJsTaskError.default) {
        _NativeHeadlessJsTaskSupport.default.notifyTaskRetry(taskId).then(function (retryPosted) {
          if (!retryPosted) {
            _NativeHeadlessJsTaskSupport.default.notifyTaskFinished(taskId);
          }
        });
      }
    });
  },
  cancelHeadlessTask: function cancelHeadlessTask(taskId, taskKey) {
    var taskCancelProvider = taskCancelProviders.get(taskKey);

    if (!taskCancelProvider) {
      throw new Error("No task canceller registered for key '" + taskKey + "'");
    }

    taskCancelProvider()();
  }
};
BatchedBridge.registerCallableModule('AppRegistry', AppRegistry);
module.exports = AppRegistry;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFwcFJlZ2lzdHJ5LmpzIl0sIm5hbWVzIjpbIkJhdGNoZWRCcmlkZ2UiLCJyZXF1aXJlIiwiQnVnUmVwb3J0aW5nIiwiUmVhY3ROYXRpdmUiLCJTY2VuZVRyYWNrZXIiLCJpbmZvTG9nIiwiaW52YXJpYW50IiwicmVuZGVyQXBwbGljYXRpb24iLCJjcmVhdGVQZXJmb3JtYW5jZUxvZ2dlciIsInJ1bm5hYmxlcyIsInJ1bkNvdW50Iiwic2VjdGlvbnMiLCJ0YXNrUHJvdmlkZXJzIiwiTWFwIiwidGFza0NhbmNlbFByb3ZpZGVycyIsImNvbXBvbmVudFByb3ZpZGVySW5zdHJ1bWVudGF0aW9uSG9vayIsImNvbXBvbmVudCIsIndyYXBwZXJDb21wb25lbnRQcm92aWRlciIsInNob3dGYWJyaWNJbmRpY2F0b3IiLCJBcHBSZWdpc3RyeSIsInNldFdyYXBwZXJDb21wb25lbnRQcm92aWRlciIsInByb3ZpZGVyIiwiZW5hYmxlRmFicmljSW5kaWNhdG9yIiwiZW5hYmxlZCIsInJlZ2lzdGVyQ29uZmlnIiwiY29uZmlnIiwiZm9yRWFjaCIsImFwcENvbmZpZyIsInJ1biIsInJlZ2lzdGVyUnVubmFibGUiLCJhcHBLZXkiLCJyZWdpc3RlckNvbXBvbmVudCIsInNlY3Rpb24iLCJjb21wb25lbnRQcm92aWRlciIsInNjb3BlZFBlcmZvcm1hbmNlTG9nZ2VyIiwiYXBwUGFyYW1ldGVycyIsImluaXRpYWxQcm9wcyIsInJvb3RUYWciLCJmYWJyaWMiLCJyZWdpc3RlclNlY3Rpb24iLCJnZXRBcHBLZXlzIiwiT2JqZWN0Iiwia2V5cyIsImdldFNlY3Rpb25LZXlzIiwiZ2V0U2VjdGlvbnMiLCJnZXRSdW5uYWJsZSIsImdldFJlZ2lzdHJ5Iiwic2V0Q29tcG9uZW50UHJvdmlkZXJJbnN0cnVtZW50YXRpb25Ib29rIiwiaG9vayIsInJ1bkFwcGxpY2F0aW9uIiwibXNnIiwiSlNPTiIsInN0cmluZ2lmeSIsImFkZFNvdXJjZSIsInNldEFjdGl2ZVNjZW5lIiwibmFtZSIsInVubW91bnRBcHBsaWNhdGlvbkNvbXBvbmVudEF0Um9vdFRhZyIsInVubW91bnRDb21wb25lbnRBdE5vZGVBbmRSZW1vdmVDb250YWluZXIiLCJyZWdpc3RlckhlYWRsZXNzVGFzayIsInRhc2tLZXkiLCJ0YXNrUHJvdmlkZXIiLCJyZWdpc3RlckNhbmNlbGxhYmxlSGVhZGxlc3NUYXNrIiwidGFza0NhbmNlbFByb3ZpZGVyIiwiaGFzIiwiY29uc29sZSIsIndhcm4iLCJzZXQiLCJzdGFydEhlYWRsZXNzVGFzayIsInRhc2tJZCIsImRhdGEiLCJnZXQiLCJOYXRpdmVIZWFkbGVzc0pzVGFza1N1cHBvcnQiLCJub3RpZnlUYXNrRmluaXNoZWQiLCJ0aGVuIiwiY2F0Y2giLCJyZWFzb24iLCJlcnJvciIsIkhlYWRsZXNzSnNUYXNrRXJyb3IiLCJub3RpZnlUYXNrUmV0cnkiLCJyZXRyeVBvc3RlZCIsImNhbmNlbEhlYWRsZXNzVGFzayIsIkVycm9yIiwicmVnaXN0ZXJDYWxsYWJsZU1vZHVsZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVNBOzs7Ozs7QUFhQTs7QUFDQTs7Ozs7O0FBWkEsSUFBTUEsYUFBYSxHQUFHQyxPQUFPLGtDQUE3Qjs7QUFDQSxJQUFNQyxZQUFZLEdBQUdELE9BQU8sZ0NBQTVCOztBQUNBLElBQU1FLFdBQVcsR0FBR0YsT0FBTyxpQ0FBM0I7O0FBQ0EsSUFBTUcsWUFBWSxHQUFHSCxPQUFPLDZCQUE1Qjs7QUFFQSxJQUFNSSxPQUFPLEdBQUdKLE9BQU8sd0JBQXZCOztBQUNBLElBQU1LLFNBQVMsR0FBR0wsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBQ0EsSUFBTU0saUJBQWlCLEdBQUdOLE9BQU8sdUJBQWpDOztBQUNBLElBQU1PLHVCQUF1QixHQUFHUCxPQUFPLHdDQUF2Qzs7QUFtQ0EsSUFBTVEsU0FBb0IsR0FBRyxFQUE3QjtBQUNBLElBQUlDLFFBQVEsR0FBRyxDQUFmO0FBQ0EsSUFBTUMsUUFBbUIsR0FBRyxFQUE1QjtBQUNBLElBQU1DLGFBQXdDLEdBQUcs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QUEvQztBQUNEOztBQUNEO0FBQ0Q7O0FBQ0RSLElBQUFBLFlBQVksR0FBR1MsSUFBSCxDQUFaLENBQ0dJLElBREgsQ0FDUSxZQUFNO0FBQ1YsVUFBSUYsb0NBQUosRUFBaUM7QUFDL0JBLDZDQUE0QkMsa0JBQTVCLENBQStDSixNQUEvQztBQUNEO0FBQ0YsS0FMSCxFQU1HTSxLQU5ILENBTVMsVUFBQUMsTUFBTSxFQUFJO0FBQ2ZYLE1BQUFBLE9BQU8sQ0FBQ1ksS0FBUixDQUFjRCxNQUFkOztBQUVBLFVBQ0VKLHdDQUNBSSxNQUFNLFlBQVlFLDRCQUZwQixFQUdFO0FBQ0FOLDZDQUE0Qk8sZUFBNUIsQ0FBNENWLE1BQTVDLEVBQW9ESyxJQUFwRCxDQUNFLFVBQUFNLFdBQVcsRUFBSTtBQUNiLGNBQUksQ0FBQ0EsV0FBTCxFQUFrQjtBQUNoQlIsaURBQTRCQyxrQkFBNUIsQ0FBK0NKLE1BQS9DO0FBQ0Q7QUFDRixTQUxIO0FBT0Q7QUFDRixLQXJCSDtBQXNCRCxHQTNNaUI7QUFrTmxCWSxFQUFBQSxrQkFsTmtCLDhCQWtOQ1osTUFsTkQsRUFrTmlCVCxPQWxOakIsRUFrTndDO0FBQ3hELFFBQU1HLGtCQUFrQixHQUFHaEQsbUJBQW1CLENBQUN3RCxHQUFwQixDQUF3QlgsT0FBeEIsQ0FBM0I7O0FBQ0EsUUFBSSxDQUFDRyxrQkFBTCxFQUF5QjtBQUN2QixZQUFNLElBQUltQixLQUFKLDRDQUFtRHRCLE9BQW5ELE9BQU47QUFDRDs7QUFDREcsSUFBQUEsa0JBQWtCO0FBQ25CO0FBeE5pQixDQUFwQjtBQTJOQTlELGFBQWEsQ0FBQ2tGLHNCQUFkLENBQXFDLGFBQXJDLEVBQW9EL0QsV0FBcEQ7QUFFQWdFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQmpFLFdBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEJhdGNoZWRCcmlkZ2UgPSByZXF1aXJlKCcuLi9CYXRjaGVkQnJpZGdlL0JhdGNoZWRCcmlkZ2UnKTtcbmNvbnN0IEJ1Z1JlcG9ydGluZyA9IHJlcXVpcmUoJy4uL0J1Z1JlcG9ydGluZy9CdWdSZXBvcnRpbmcnKTtcbmNvbnN0IFJlYWN0TmF0aXZlID0gcmVxdWlyZSgnLi4vUmVuZGVyZXIvc2hpbXMvUmVhY3ROYXRpdmUnKTtcbmNvbnN0IFNjZW5lVHJhY2tlciA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9TY2VuZVRyYWNrZXInKTtcblxuY29uc3QgaW5mb0xvZyA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9pbmZvTG9nJyk7XG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdpbnZhcmlhbnQnKTtcbmNvbnN0IHJlbmRlckFwcGxpY2F0aW9uID0gcmVxdWlyZSgnLi9yZW5kZXJBcHBsaWNhdGlvbicpO1xuY29uc3QgY3JlYXRlUGVyZm9ybWFuY2VMb2dnZXIgPSByZXF1aXJlKCcuLi9VdGlsaXRpZXMvY3JlYXRlUGVyZm9ybWFuY2VMb2dnZXInKTtcbmltcG9ydCB0eXBlIHtJUGVyZm9ybWFuY2VMb2dnZXJ9IGZyb20gJy4uL1V0aWxpdGllcy9jcmVhdGVQZXJmb3JtYW5jZUxvZ2dlcic7XG5cbmltcG9ydCBOYXRpdmVIZWFkbGVzc0pzVGFza1N1cHBvcnQgZnJvbSAnLi9OYXRpdmVIZWFkbGVzc0pzVGFza1N1cHBvcnQnO1xuaW1wb3J0IEhlYWRsZXNzSnNUYXNrRXJyb3IgZnJvbSAnLi9IZWFkbGVzc0pzVGFza0Vycm9yJztcblxudHlwZSBUYXNrID0gKHRhc2tEYXRhOiBhbnkpID0+IFByb21pc2U8dm9pZD47XG50eXBlIFRhc2tQcm92aWRlciA9ICgpID0+IFRhc2s7XG50eXBlIFRhc2tDYW5jZWxsZXIgPSAoKSA9PiB2b2lkO1xudHlwZSBUYXNrQ2FuY2VsUHJvdmlkZXIgPSAoKSA9PiBUYXNrQ2FuY2VsbGVyO1xuXG5leHBvcnQgdHlwZSBDb21wb25lbnRQcm92aWRlciA9ICgpID0+IFJlYWN0JENvbXBvbmVudFR5cGU8YW55PjtcbmV4cG9ydCB0eXBlIENvbXBvbmVudFByb3ZpZGVySW5zdHJ1bWVudGF0aW9uSG9vayA9IChcbiAgY29tcG9uZW50OiBDb21wb25lbnRQcm92aWRlcixcbiAgc2NvcGVkUGVyZm9ybWFuY2VMb2dnZXI6IElQZXJmb3JtYW5jZUxvZ2dlcixcbikgPT4gUmVhY3QkQ29tcG9uZW50VHlwZTxhbnk+O1xuZXhwb3J0IHR5cGUgQXBwQ29uZmlnID0ge1xuICBhcHBLZXk6IHN0cmluZyxcbiAgY29tcG9uZW50PzogQ29tcG9uZW50UHJvdmlkZXIsXG4gIHJ1bj86IEZ1bmN0aW9uLFxuICBzZWN0aW9uPzogYm9vbGVhbixcbn07XG5leHBvcnQgdHlwZSBSdW5uYWJsZSA9IHtcbiAgY29tcG9uZW50PzogQ29tcG9uZW50UHJvdmlkZXIsXG4gIHJ1bjogRnVuY3Rpb24sXG59O1xuZXhwb3J0IHR5cGUgUnVubmFibGVzID0ge1xuICBbYXBwS2V5OiBzdHJpbmddOiBSdW5uYWJsZSxcbn07XG5leHBvcnQgdHlwZSBSZWdpc3RyeSA9IHtcbiAgc2VjdGlvbnM6IEFycmF5PHN0cmluZz4sXG4gIHJ1bm5hYmxlczogUnVubmFibGVzLFxufTtcbmV4cG9ydCB0eXBlIFdyYXBwZXJDb21wb25lbnRQcm92aWRlciA9IGFueSA9PiBSZWFjdCRDb21wb25lbnRUeXBlPCo+O1xuXG5jb25zdCBydW5uYWJsZXM6IFJ1bm5hYmxlcyA9IHt9O1xubGV0IHJ1bkNvdW50ID0gMTtcbmNvbnN0IHNlY3Rpb25zOiBSdW5uYWJsZXMgPSB7fTtcbmNvbnN0IHRhc2tQcm92aWRlcnM6IE1hcDxzdHJpbmcsIFRhc2tQcm92aWRlcj4gPSBuZXcgTWFwKCk7XG5jb25zdCB0YXNrQ2FuY2VsUHJvdmlkZXJzOiBNYXA8c3RyaW5nLCBUYXNrQ2FuY2VsUHJvdmlkZXI+ID0gbmV3IE1hcCgpO1xubGV0IGNvbXBvbmVudFByb3ZpZGVySW5zdHJ1bWVudGF0aW9uSG9vazogQ29tcG9uZW50UHJvdmlkZXJJbnN0cnVtZW50YXRpb25Ib29rID0gKFxuICBjb21wb25lbnQ6IENvbXBvbmVudFByb3ZpZGVyLFxuKSA9PiBjb21wb25lbnQoKTtcblxubGV0IHdyYXBwZXJDb21wb25lbnRQcm92aWRlcjogP1dyYXBwZXJDb21wb25lbnRQcm92aWRlcjtcbmxldCBzaG93RmFicmljSW5kaWNhdG9yID0gZmFsc2U7XG5cbi8qKlxuICogYEFwcFJlZ2lzdHJ5YCBpcyB0aGUgSmF2YVNjcmlwdCBlbnRyeSBwb2ludCB0byBydW5uaW5nIGFsbCBSZWFjdCBOYXRpdmUgYXBwcy5cbiAqXG4gKiBTZWUgaHR0cDovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC1uYXRpdmUvZG9jcy9hcHByZWdpc3RyeS5odG1sXG4gKi9cbmNvbnN0IEFwcFJlZ2lzdHJ5ID0ge1xuICBzZXRXcmFwcGVyQ29tcG9uZW50UHJvdmlkZXIocHJvdmlkZXI6IFdyYXBwZXJDb21wb25lbnRQcm92aWRlcikge1xuICAgIHdyYXBwZXJDb21wb25lbnRQcm92aWRlciA9IHByb3ZpZGVyO1xuICB9LFxuXG4gIGVuYWJsZUZhYnJpY0luZGljYXRvcihlbmFibGVkOiBib29sZWFuKTogdm9pZCB7XG4gICAgc2hvd0ZhYnJpY0luZGljYXRvciA9IGVuYWJsZWQ7XG4gIH0sXG5cbiAgcmVnaXN0ZXJDb25maWcoY29uZmlnOiBBcnJheTxBcHBDb25maWc+KTogdm9pZCB7XG4gICAgY29uZmlnLmZvckVhY2goYXBwQ29uZmlnID0+IHtcbiAgICAgIGlmIChhcHBDb25maWcucnVuKSB7XG4gICAgICAgIEFwcFJlZ2lzdHJ5LnJlZ2lzdGVyUnVubmFibGUoYXBwQ29uZmlnLmFwcEtleSwgYXBwQ29uZmlnLnJ1bik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbnZhcmlhbnQoXG4gICAgICAgICAgYXBwQ29uZmlnLmNvbXBvbmVudCAhPSBudWxsLFxuICAgICAgICAgICdBcHBSZWdpc3RyeS5yZWdpc3RlckNvbmZpZyguLi4pOiBFdmVyeSBjb25maWcgaXMgZXhwZWN0ZWQgdG8gc2V0ICcgK1xuICAgICAgICAgICAgJ2VpdGhlciBgcnVuYCBvciBgY29tcG9uZW50YCwgYnV0IGAlc2AgaGFzIG5laXRoZXIuJyxcbiAgICAgICAgICBhcHBDb25maWcuYXBwS2V5LFxuICAgICAgICApO1xuICAgICAgICBBcHBSZWdpc3RyeS5yZWdpc3RlckNvbXBvbmVudChcbiAgICAgICAgICBhcHBDb25maWcuYXBwS2V5LFxuICAgICAgICAgIGFwcENvbmZpZy5jb21wb25lbnQsXG4gICAgICAgICAgYXBwQ29uZmlnLnNlY3Rpb24sXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVycyBhbiBhcHAncyByb290IGNvbXBvbmVudC5cbiAgICpcbiAgICogU2VlIGh0dHA6Ly9mYWNlYm9vay5naXRodWIuaW8vcmVhY3QtbmF0aXZlL2RvY3MvYXBwcmVnaXN0cnkuaHRtbCNyZWdpc3RlcmNvbXBvbmVudFxuICAgKi9cbiAgcmVnaXN0ZXJDb21wb25lbnQoXG4gICAgYXBwS2V5OiBzdHJpbmcsXG4gICAgY29tcG9uZW50UHJvdmlkZXI6IENvbXBvbmVudFByb3ZpZGVyLFxuICAgIHNlY3Rpb24/OiBib29sZWFuLFxuICApOiBzdHJpbmcge1xuICAgIGxldCBzY29wZWRQZXJmb3JtYW5jZUxvZ2dlciA9IGNyZWF0ZVBlcmZvcm1hbmNlTG9nZ2VyKCk7XG4gICAgcnVubmFibGVzW2FwcEtleV0gPSB7XG4gICAgICBjb21wb25lbnRQcm92aWRlcixcbiAgICAgIHJ1bjogYXBwUGFyYW1ldGVycyA9PiB7XG4gICAgICAgIHJlbmRlckFwcGxpY2F0aW9uKFxuICAgICAgICAgIGNvbXBvbmVudFByb3ZpZGVySW5zdHJ1bWVudGF0aW9uSG9vayhcbiAgICAgICAgICAgIGNvbXBvbmVudFByb3ZpZGVyLFxuICAgICAgICAgICAgc2NvcGVkUGVyZm9ybWFuY2VMb2dnZXIsXG4gICAgICAgICAgKSxcbiAgICAgICAgICBhcHBQYXJhbWV0ZXJzLmluaXRpYWxQcm9wcyxcbiAgICAgICAgICBhcHBQYXJhbWV0ZXJzLnJvb3RUYWcsXG4gICAgICAgICAgd3JhcHBlckNvbXBvbmVudFByb3ZpZGVyICYmIHdyYXBwZXJDb21wb25lbnRQcm92aWRlcihhcHBQYXJhbWV0ZXJzKSxcbiAgICAgICAgICBhcHBQYXJhbWV0ZXJzLmZhYnJpYyxcbiAgICAgICAgICBzaG93RmFicmljSW5kaWNhdG9yLFxuICAgICAgICAgIHNjb3BlZFBlcmZvcm1hbmNlTG9nZ2VyLFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9O1xuICAgIGlmIChzZWN0aW9uKSB7XG4gICAgICBzZWN0aW9uc1thcHBLZXldID0gcnVubmFibGVzW2FwcEtleV07XG4gICAgfVxuICAgIHJldHVybiBhcHBLZXk7XG4gIH0sXG5cbiAgcmVnaXN0ZXJSdW5uYWJsZShhcHBLZXk6IHN0cmluZywgcnVuOiBGdW5jdGlvbik6IHN0cmluZyB7XG4gICAgcnVubmFibGVzW2FwcEtleV0gPSB7cnVufTtcbiAgICByZXR1cm4gYXBwS2V5O1xuICB9LFxuXG4gIHJlZ2lzdGVyU2VjdGlvbihhcHBLZXk6IHN0cmluZywgY29tcG9uZW50OiBDb21wb25lbnRQcm92aWRlcik6IHZvaWQge1xuICAgIEFwcFJlZ2lzdHJ5LnJlZ2lzdGVyQ29tcG9uZW50KGFwcEtleSwgY29tcG9uZW50LCB0cnVlKTtcbiAgfSxcblxuICBnZXRBcHBLZXlzKCk6IEFycmF5PHN0cmluZz4ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhydW5uYWJsZXMpO1xuICB9LFxuXG4gIGdldFNlY3Rpb25LZXlzKCk6IEFycmF5PHN0cmluZz4ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhzZWN0aW9ucyk7XG4gIH0sXG5cbiAgZ2V0U2VjdGlvbnMoKTogUnVubmFibGVzIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4uc2VjdGlvbnMsXG4gICAgfTtcbiAgfSxcblxuICBnZXRSdW5uYWJsZShhcHBLZXk6IHN0cmluZyk6ID9SdW5uYWJsZSB7XG4gICAgcmV0dXJuIHJ1bm5hYmxlc1thcHBLZXldO1xuICB9LFxuXG4gIGdldFJlZ2lzdHJ5KCk6IFJlZ2lzdHJ5IHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VjdGlvbnM6IEFwcFJlZ2lzdHJ5LmdldFNlY3Rpb25LZXlzKCksXG4gICAgICBydW5uYWJsZXM6IHsuLi5ydW5uYWJsZXN9LFxuICAgIH07XG4gIH0sXG5cbiAgc2V0Q29tcG9uZW50UHJvdmlkZXJJbnN0cnVtZW50YXRpb25Ib29rKFxuICAgIGhvb2s6IENvbXBvbmVudFByb3ZpZGVySW5zdHJ1bWVudGF0aW9uSG9vayxcbiAgKSB7XG4gICAgY29tcG9uZW50UHJvdmlkZXJJbnN0cnVtZW50YXRpb25Ib29rID0gaG9vaztcbiAgfSxcblxuICAvKipcbiAgICogTG9hZHMgdGhlIEphdmFTY3JpcHQgYnVuZGxlIGFuZCBydW5zIHRoZSBhcHAuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FwcHJlZ2lzdHJ5Lmh0bWwjcnVuYXBwbGljYXRpb25cbiAgICovXG4gIHJ1bkFwcGxpY2F0aW9uKGFwcEtleTogc3RyaW5nLCBhcHBQYXJhbWV0ZXJzOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBtc2cgPVxuICAgICAgJ1J1bm5pbmcgXCInICsgYXBwS2V5ICsgJ1wiIHdpdGggJyArIEpTT04uc3RyaW5naWZ5KGFwcFBhcmFtZXRlcnMpO1xuICAgIGluZm9Mb2cobXNnKTtcbiAgICBCdWdSZXBvcnRpbmcuYWRkU291cmNlKFxuICAgICAgJ0FwcFJlZ2lzdHJ5LnJ1bkFwcGxpY2F0aW9uJyArIHJ1bkNvdW50KyssXG4gICAgICAoKSA9PiBtc2csXG4gICAgKTtcbiAgICBpbnZhcmlhbnQoXG4gICAgICBydW5uYWJsZXNbYXBwS2V5XSAmJiBydW5uYWJsZXNbYXBwS2V5XS5ydW4sXG4gICAgICBgXCIke2FwcEtleX1cIiBoYXMgbm90IGJlZW4gcmVnaXN0ZXJlZC4gVGhpcyBjYW4gaGFwcGVuIGlmOlxcbmAgK1xuICAgICAgICAnKiBNZXRybyAodGhlIGxvY2FsIGRldiBzZXJ2ZXIpIGlzIHJ1biBmcm9tIHRoZSB3cm9uZyBmb2xkZXIuICcgK1xuICAgICAgICAnQ2hlY2sgaWYgTWV0cm8gaXMgcnVubmluZywgc3RvcCBpdCBhbmQgcmVzdGFydCBpdCBpbiB0aGUgY3VycmVudCBwcm9qZWN0LlxcbicgK1xuICAgICAgICBcIiogQSBtb2R1bGUgZmFpbGVkIHRvIGxvYWQgZHVlIHRvIGFuIGVycm9yIGFuZCBgQXBwUmVnaXN0cnkucmVnaXN0ZXJDb21wb25lbnRgIHdhc24ndCBjYWxsZWQuXCIsXG4gICAgKTtcblxuICAgIFNjZW5lVHJhY2tlci5zZXRBY3RpdmVTY2VuZSh7bmFtZTogYXBwS2V5fSk7XG4gICAgcnVubmFibGVzW2FwcEtleV0ucnVuKGFwcFBhcmFtZXRlcnMpO1xuICB9LFxuXG4gIC8qKlxuICAgKiBTdG9wcyBhbiBhcHBsaWNhdGlvbiB3aGVuIGEgdmlldyBzaG91bGQgYmUgZGVzdHJveWVkLlxuICAgKlxuICAgKiBTZWUgaHR0cDovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC1uYXRpdmUvZG9jcy9hcHByZWdpc3RyeS5odG1sI3VubW91bnRhcHBsaWNhdGlvbmNvbXBvbmVudGF0cm9vdHRhZ1xuICAgKi9cbiAgdW5tb3VudEFwcGxpY2F0aW9uQ29tcG9uZW50QXRSb290VGFnKHJvb3RUYWc6IG51bWJlcik6IHZvaWQge1xuICAgIFJlYWN0TmF0aXZlLnVubW91bnRDb21wb25lbnRBdE5vZGVBbmRSZW1vdmVDb250YWluZXIocm9vdFRhZyk7XG4gIH0sXG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgaGVhZGxlc3MgdGFzay4gQSBoZWFkbGVzcyB0YXNrIGlzIGEgYml0IG9mIGNvZGUgdGhhdCBydW5zIHdpdGhvdXQgYSBVSS5cbiAgICpcbiAgICogU2VlIGh0dHA6Ly9mYWNlYm9vay5naXRodWIuaW8vcmVhY3QtbmF0aXZlL2RvY3MvYXBwcmVnaXN0cnkuaHRtbCNyZWdpc3RlcmhlYWRsZXNzdGFza1xuICAgKi9cbiAgcmVnaXN0ZXJIZWFkbGVzc1Rhc2sodGFza0tleTogc3RyaW5nLCB0YXNrUHJvdmlkZXI6IFRhc2tQcm92aWRlcik6IHZvaWQge1xuICAgIHRoaXMucmVnaXN0ZXJDYW5jZWxsYWJsZUhlYWRsZXNzVGFzayh0YXNrS2V5LCB0YXNrUHJvdmlkZXIsICgpID0+ICgpID0+IHtcbiAgICAgIC8qIENhbmNlbCBpcyBuby1vcCAqL1xuICAgIH0pO1xuICB9LFxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIGNhbmNlbGxhYmxlIGhlYWRsZXNzIHRhc2suIEEgaGVhZGxlc3MgdGFzayBpcyBhIGJpdCBvZiBjb2RlIHRoYXQgcnVucyB3aXRob3V0IGEgVUkuXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FwcHJlZ2lzdHJ5Lmh0bWwjcmVnaXN0ZXJjYW5jZWxsYWJsZWhlYWRsZXNzdGFza1xuICAgKi9cbiAgcmVnaXN0ZXJDYW5jZWxsYWJsZUhlYWRsZXNzVGFzayhcbiAgICB0YXNrS2V5OiBzdHJpbmcsXG4gICAgdGFza1Byb3ZpZGVyOiBUYXNrUHJvdmlkZXIsXG4gICAgdGFza0NhbmNlbFByb3ZpZGVyOiBUYXNrQ2FuY2VsUHJvdmlkZXIsXG4gICk6IHZvaWQge1xuICAgIGlmICh0YXNrUHJvdmlkZXJzLmhhcyh0YXNrS2V5KSkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgcmVnaXN0ZXJIZWFkbGVzc1Rhc2sgb3IgcmVnaXN0ZXJDYW5jZWxsYWJsZUhlYWRsZXNzVGFzayBjYWxsZWQgbXVsdGlwbGUgdGltZXMgZm9yIHNhbWUga2V5ICcke3Rhc2tLZXl9J2AsXG4gICAgICApO1xuICAgIH1cbiAgICB0YXNrUHJvdmlkZXJzLnNldCh0YXNrS2V5LCB0YXNrUHJvdmlkZXIpO1xuICAgIHRhc2tDYW5jZWxQcm92aWRlcnMuc2V0KHRhc2tLZXksIHRhc2tDYW5jZWxQcm92aWRlcik7XG4gIH0sXG5cbiAgLyoqXG4gICAqIE9ubHkgY2FsbGVkIGZyb20gbmF0aXZlIGNvZGUuIFN0YXJ0cyBhIGhlYWRsZXNzIHRhc2suXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FwcHJlZ2lzdHJ5Lmh0bWwjc3RhcnRoZWFkbGVzc3Rhc2tcbiAgICovXG4gIHN0YXJ0SGVhZGxlc3NUYXNrKHRhc2tJZDogbnVtYmVyLCB0YXNrS2V5OiBzdHJpbmcsIGRhdGE6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IHRhc2tQcm92aWRlciA9IHRhc2tQcm92aWRlcnMuZ2V0KHRhc2tLZXkpO1xuICAgIGlmICghdGFza1Byb3ZpZGVyKSB7XG4gICAgICBjb25zb2xlLndhcm4oYE5vIHRhc2sgcmVnaXN0ZXJlZCBmb3Iga2V5ICR7dGFza0tleX1gKTtcbiAgICAgIGlmIChOYXRpdmVIZWFkbGVzc0pzVGFza1N1cHBvcnQpIHtcbiAgICAgICAgTmF0aXZlSGVhZGxlc3NKc1Rhc2tTdXBwb3J0Lm5vdGlmeVRhc2tGaW5pc2hlZCh0YXNrSWQpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0YXNrUHJvdmlkZXIoKShkYXRhKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBpZiAoTmF0aXZlSGVhZGxlc3NKc1Rhc2tTdXBwb3J0KSB7XG4gICAgICAgICAgTmF0aXZlSGVhZGxlc3NKc1Rhc2tTdXBwb3J0Lm5vdGlmeVRhc2tGaW5pc2hlZCh0YXNrSWQpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IocmVhc29uKTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgTmF0aXZlSGVhZGxlc3NKc1Rhc2tTdXBwb3J0ICYmXG4gICAgICAgICAgcmVhc29uIGluc3RhbmNlb2YgSGVhZGxlc3NKc1Rhc2tFcnJvclxuICAgICAgICApIHtcbiAgICAgICAgICBOYXRpdmVIZWFkbGVzc0pzVGFza1N1cHBvcnQubm90aWZ5VGFza1JldHJ5KHRhc2tJZCkudGhlbihcbiAgICAgICAgICAgIHJldHJ5UG9zdGVkID0+IHtcbiAgICAgICAgICAgICAgaWYgKCFyZXRyeVBvc3RlZCkge1xuICAgICAgICAgICAgICAgIE5hdGl2ZUhlYWRsZXNzSnNUYXNrU3VwcG9ydC5ub3RpZnlUYXNrRmluaXNoZWQodGFza0lkKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgfSxcblxuICAvKipcbiAgICogT25seSBjYWxsZWQgZnJvbSBuYXRpdmUgY29kZS4gQ2FuY2VscyBhIGhlYWRsZXNzIHRhc2suXG4gICAqXG4gICAqIFNlZSBodHRwOi8vZmFjZWJvb2suZ2l0aHViLmlvL3JlYWN0LW5hdGl2ZS9kb2NzL2FwcHJlZ2lzdHJ5Lmh0bWwjY2FuY2VsaGVhZGxlc3N0YXNrXG4gICAqL1xuICBjYW5jZWxIZWFkbGVzc1Rhc2sodGFza0lkOiBudW1iZXIsIHRhc2tLZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHRhc2tDYW5jZWxQcm92aWRlciA9IHRhc2tDYW5jZWxQcm92aWRlcnMuZ2V0KHRhc2tLZXkpO1xuICAgIGlmICghdGFza0NhbmNlbFByb3ZpZGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHRhc2sgY2FuY2VsbGVyIHJlZ2lzdGVyZWQgZm9yIGtleSAnJHt0YXNrS2V5fSdgKTtcbiAgICB9XG4gICAgdGFza0NhbmNlbFByb3ZpZGVyKCkoKTtcbiAgfSxcbn07XG5cbkJhdGNoZWRCcmlkZ2UucmVnaXN0ZXJDYWxsYWJsZU1vZHVsZSgnQXBwUmVnaXN0cnknLCBBcHBSZWdpc3RyeSk7XG5cbm1vZHVsZS5leHBvcnRzID0gQXBwUmVnaXN0cnk7XG4iXX0=
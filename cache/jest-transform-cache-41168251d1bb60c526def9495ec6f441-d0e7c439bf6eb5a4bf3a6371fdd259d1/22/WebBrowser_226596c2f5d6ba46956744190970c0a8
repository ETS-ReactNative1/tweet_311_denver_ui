799987c46133c5dd04715ff692f62302
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getCustomTabsSupportingBrowsersAsync = getCustomTabsSupportingBrowsersAsync;
exports.warmUpAsync = warmUpAsync;
exports.mayInitWithUrlAsync = mayInitWithUrlAsync;
exports.coolDownAsync = coolDownAsync;
exports.openBrowserAsync = openBrowserAsync;
exports.dismissBrowser = dismissBrowser;
exports.openAuthSessionAsync = openAuthSessionAsync;
exports.dismissAuthSession = dismissAuthSession;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _reactNative = require("react-native");

var _core = require("@unimodules/core");

var _ExpoWebBrowser = _interopRequireDefault(require("./ExpoWebBrowser"));

var emptyCustomTabsPackages = {
  defaultBrowserPackage: undefined,
  preferredBrowserPackage: undefined,
  browserPackages: [],
  servicePackages: []
};

function getCustomTabsSupportingBrowsersAsync() {
  return _regenerator.default.async(function getCustomTabsSupportingBrowsersAsync$(_context) {
    while (1) {
      switch (_context.prev = _context.next) {
        case 0:
          if (_ExpoWebBrowser.default.getCustomTabsSupportingBrowsersAsync) {
            _context.next = 2;
            break;
          }

          throw new _core.UnavailabilityError('WebBrowser', 'getCustomTabsSupportingBrowsersAsync');

        case 2:
          if (!(_reactNative.Platform.OS !== 'android')) {
            _context.next = 6;
            break;
          }

          return _context.abrupt("return", emptyCustomTabsPackages);

        case 6:
          _context.next = 8;
          return _regenerator.default.awrap(_ExpoWebBrowser.default.getCustomTabsSupportingBrowsersAsync());

        case 8:
          return _context.abrupt("return", _context.sent);

        case 9:
        case "end":
          return _context.stop();
      }
    }
  });
}

function warmUpAsync(browserPackage) {
  return _regenerator.default.async(function warmUpAsync$(_context2) {
    while (1) {
      switch (_context2.prev = _context2.next) {
        case 0:
          if (_ExpoWebBrowser.default.warmUpAsync) {
            _context2.next = 2;
            break;
          }

          throw new _core.UnavailabilityError('WebBrowser', 'warmUpAsync');

        case 2:
          if (!(_reactNative.Platform.OS !== 'android')) {
            _context2.next = 6;
            break;
          }

          return _context2.abrupt("return", {});

        case 6:
          _context2.next = 8;
          return _regenerator.default.awrap(_ExpoWebBrowser.default.warmUpAsync(browserPackage));

        case 8:
          return _context2.abrupt("return", _context2.sent);

        case 9:
        case "end":
          return _context2.stop();
      }
    }
  });
}

function mayInitWithUrlAsync(url, browserPackage) {
  return _regenerator.default.async(function mayInitWithUrlAsync$(_context3) {
    while (1) {
      switch (_context3.prev = _context3.next) {
        case 0:
          if (_ExpoWebBrowser.default.mayInitWithUrlAsync) {
            _context3.next = 2;
            break;
          }

          throw new _core.UnavailabilityError('WebBrowser', 'mayInitWithUrlAsync');

        case 2:
          if (!(_reactNative.Platform.OS !== 'android')) {
            _context3.next = 6;
            break;
          }

          return _context3.abrupt("return", {});

        case 6:
          _context3.next = 8;
          return _regenerator.default.awrap(_ExpoWebBrowser.default.mayInitWithUrlAsync(url, browserPackage));

        case 8:
          return _context3.abrupt("return", _context3.sent);

        case 9:
        case "end":
          return _context3.stop();
      }
    }
  });
}

function coolDownAsync(browserPackage) {
  return _regenerator.default.async(function coolDownAsync$(_context4) {
    while (1) {
      switch (_context4.prev = _context4.next) {
        case 0:
          if (_ExpoWebBrowser.default.coolDownAsync) {
            _context4.next = 2;
            break;
          }

          throw new _core.UnavailabilityError('WebBrowser', 'coolDownAsync');

        case 2:
          if (!(_reactNative.Platform.OS !== 'android')) {
            _context4.next = 6;
            break;
          }

          return _context4.abrupt("return", {});

        case 6:
          _context4.next = 8;
          return _regenerator.default.awrap(_ExpoWebBrowser.default.coolDownAsync(browserPackage));

        case 8:
          return _context4.abrupt("return", _context4.sent);

        case 9:
        case "end":
          return _context4.stop();
      }
    }
  });
}

function openBrowserAsync(url) {
  var browserParams,
      _args5 = arguments;
  return _regenerator.default.async(function openBrowserAsync$(_context5) {
    while (1) {
      switch (_context5.prev = _context5.next) {
        case 0:
          browserParams = _args5.length > 1 && _args5[1] !== undefined ? _args5[1] : {};

          if (_ExpoWebBrowser.default.openBrowserAsync) {
            _context5.next = 3;
            break;
          }

          throw new _core.UnavailabilityError('WebBrowser', 'openBrowserAsync');

        case 3:
          _context5.next = 5;
          return _regenerator.default.awrap(_ExpoWebBrowser.default.openBrowserAsync(url, browserParams));

        case 5:
          return _context5.abrupt("return", _context5.sent);

        case 6:
        case "end":
          return _context5.stop();
      }
    }
  });
}

function dismissBrowser() {
  if (!_ExpoWebBrowser.default.dismissBrowser) {
    throw new _core.UnavailabilityError('WebBrowser', 'dismissBrowser');
  }

  _ExpoWebBrowser.default.dismissBrowser();
}

function openAuthSessionAsync(url, redirectUrl) {
  return _regenerator.default.async(function openAuthSessionAsync$(_context6) {
    while (1) {
      switch (_context6.prev = _context6.next) {
        case 0:
          if (!_authSessionIsNativelySupported()) {
            _context6.next = 6;
            break;
          }

          if (_ExpoWebBrowser.default.openAuthSessionAsync) {
            _context6.next = 3;
            break;
          }

          throw new _core.UnavailabilityError('WebBrowser', 'openAuthSessionAsync');

        case 3:
          return _context6.abrupt("return", _ExpoWebBrowser.default.openAuthSessionAsync(url, redirectUrl));

        case 6:
          return _context6.abrupt("return", _openAuthSessionPolyfillAsync(url, redirectUrl));

        case 7:
        case "end":
          return _context6.stop();
      }
    }
  });
}

function dismissAuthSession() {
  if (_authSessionIsNativelySupported()) {
    if (!_ExpoWebBrowser.default.dismissAuthSession) {
      throw new _core.UnavailabilityError('WebBrowser', 'dismissAuthSession');
    }

    _ExpoWebBrowser.default.dismissAuthSession();
  } else {
    if (!_ExpoWebBrowser.default.dismissBrowser) {
      throw new _core.UnavailabilityError('WebBrowser', 'dismissAuthSession');
    }

    _ExpoWebBrowser.default.dismissBrowser();
  }
}

function _authSessionIsNativelySupported() {
  if (_reactNative.Platform.OS === 'android') {
    return false;
  }

  var versionNumber = parseInt(String(_reactNative.Platform.Version), 10);
  return versionNumber >= 11;
}

var _redirectHandler = null;
var _onWebBrowserCloseAndroid = null;

function _onAppStateChangeAndroid(state) {
  if (state === 'active' && _onWebBrowserCloseAndroid) {
    _onWebBrowserCloseAndroid();
  }
}

function _openBrowserAndWaitAndroidAsync(startUrl) {
  var appStateChangedToActive, result, _ref, type;

  return _regenerator.default.async(function _openBrowserAndWaitAndroidAsync$(_context7) {
    while (1) {
      switch (_context7.prev = _context7.next) {
        case 0:
          appStateChangedToActive = new Promise(function (resolve) {
            _onWebBrowserCloseAndroid = resolve;

            _reactNative.AppState.addEventListener('change', _onAppStateChangeAndroid);
          });
          result = {
            type: 'cancel'
          };
          _context7.next = 4;
          return _regenerator.default.awrap(openBrowserAsync(startUrl));

        case 4:
          _ref = _context7.sent;
          type = _ref.type;

          if (!(type === 'opened')) {
            _context7.next = 10;
            break;
          }

          _context7.next = 9;
          return _regenerator.default.awrap(appStateChangedToActive);

        case 9:
          result = {
            type: 'dismiss'
          };

        case 10:
          _reactNative.AppState.removeEventListener('change', _onAppStateChangeAndroid);

          _onWebBrowserCloseAndroid = null;
          return _context7.abrupt("return", result);

        case 13:
        case "end":
          return _context7.stop();
      }
    }
  });
}

function _openAuthSessionPolyfillAsync(startUrl, returnUrl) {
  return _regenerator.default.async(function _openAuthSessionPolyfillAsync$(_context8) {
    while (1) {
      switch (_context8.prev = _context8.next) {
        case 0:
          if (!_redirectHandler) {
            _context8.next = 2;
            break;
          }

          throw new Error("The WebBrowser's auth session is in an invalid state with a redirect handler set when it should not be");

        case 2:
          if (!_onWebBrowserCloseAndroid) {
            _context8.next = 4;
            break;
          }

          throw new Error("WebBrowser is already open, only one can be open at a time");

        case 4:
          _context8.prev = 4;

          if (!(_reactNative.Platform.OS === 'android')) {
            _context8.next = 11;
            break;
          }

          _context8.next = 8;
          return _regenerator.default.awrap(Promise.race([_openBrowserAndWaitAndroidAsync(startUrl), _waitForRedirectAsync(returnUrl)]));

        case 8:
          return _context8.abrupt("return", _context8.sent);

        case 11:
          _context8.next = 13;
          return _regenerator.default.awrap(Promise.race([openBrowserAsync(startUrl), _waitForRedirectAsync(returnUrl)]));

        case 13:
          return _context8.abrupt("return", _context8.sent);

        case 14:
          _context8.prev = 14;

          if (_ExpoWebBrowser.default.dismissBrowser) {
            _ExpoWebBrowser.default.dismissBrowser();
          }

          _stopWaitingForRedirect();

          return _context8.finish(14);

        case 18:
        case "end":
          return _context8.stop();
      }
    }
  }, null, null, [[4,, 14, 18]]);
}

function _stopWaitingForRedirect() {
  if (!_redirectHandler) {
    throw new Error("The WebBrowser auth session is in an invalid state with no redirect handler when one should be set");
  }

  _reactNative.Linking.removeEventListener('url', _redirectHandler);

  _redirectHandler = null;
}

function _waitForRedirectAsync(returnUrl) {
  return new Promise(function (resolve) {
    _redirectHandler = function _redirectHandler(event) {
      if (event.url.startsWith(returnUrl)) {
        resolve({
          url: event.url,
          type: 'success'
        });
      }
    };

    _reactNative.Linking.addEventListener('url', _redirectHandler);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LEVBQUU7QUFBeEIsU0FBRCxDQUFQO0FBQ0Q7QUFDRixLQUpEOztBQU1BLHlCQUFRLGdCQUFSLENBQXlCLEtBQXpCLEVBQWdDLGdCQUFoQztBQUNELEdBUk0sQ0FBUDtBQVNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwU3RhdGUsIExpbmtpbmcsIFBsYXRmb3JtLCBBcHBTdGF0ZVN0YXR1cyB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5pbXBvcnQgeyBVbmF2YWlsYWJpbGl0eUVycm9yIH0gZnJvbSAnQHVuaW1vZHVsZXMvY29yZSc7XG5pbXBvcnQgRXhwb25lbnRXZWJCcm93c2VyIGZyb20gJy4vRXhwb1dlYkJyb3dzZXInO1xuXG5pbXBvcnQge1xuICBSZWRpcmVjdEV2ZW50LFxuICBPcGVuQnJvd3Nlck9wdGlvbnMsXG4gIEF1dGhTZXNzaW9uUmVzdWx0LFxuICBDdXN0b21UYWJzQnJvd3NlcnNSZXN1bHRzLFxuICBCcm93c2VyUmVzdWx0LFxuICBSZWRpcmVjdFJlc3VsdCxcbiAgTWF5SW5pdFdpdGhVcmxSZXN1bHQsXG4gIFdhcm1VcFJlc3VsdCxcbiAgQ29vbERvd25SZXN1bHQsXG59IGZyb20gJy4vV2ViQnJvd3Nlci50eXBlcyc7XG5cbmNvbnN0IGVtcHR5Q3VzdG9tVGFic1BhY2thZ2VzOiBDdXN0b21UYWJzQnJvd3NlcnNSZXN1bHRzID0ge1xuICBkZWZhdWx0QnJvd3NlclBhY2thZ2U6IHVuZGVmaW5lZCxcbiAgcHJlZmVycmVkQnJvd3NlclBhY2thZ2U6IHVuZGVmaW5lZCxcbiAgYnJvd3NlclBhY2thZ2VzOiBbXSxcbiAgc2VydmljZVBhY2thZ2VzOiBbXSxcbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDdXN0b21UYWJzU3VwcG9ydGluZ0Jyb3dzZXJzQXN5bmMoKTogUHJvbWlzZTxDdXN0b21UYWJzQnJvd3NlcnNSZXN1bHRzPiB7XG4gIGlmICghRXhwb25lbnRXZWJCcm93c2VyLmdldEN1c3RvbVRhYnNTdXBwb3J0aW5nQnJvd3NlcnNBc3luYykge1xuICAgIHRocm93IG5ldyBVbmF2YWlsYWJpbGl0eUVycm9yKCdXZWJCcm93c2VyJywgJ2dldEN1c3RvbVRhYnNTdXBwb3J0aW5nQnJvd3NlcnNBc3luYycpO1xuICB9XG4gIGlmIChQbGF0Zm9ybS5PUyAhPT0gJ2FuZHJvaWQnKSB7XG4gICAgcmV0dXJuIGVtcHR5Q3VzdG9tVGFic1BhY2thZ2VzO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCBFeHBvbmVudFdlYkJyb3dzZXIuZ2V0Q3VzdG9tVGFic1N1cHBvcnRpbmdCcm93c2Vyc0FzeW5jKCk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdhcm1VcEFzeW5jKGJyb3dzZXJQYWNrYWdlPzogc3RyaW5nKTogUHJvbWlzZTxXYXJtVXBSZXN1bHQ+IHtcbiAgaWYgKCFFeHBvbmVudFdlYkJyb3dzZXIud2FybVVwQXN5bmMpIHtcbiAgICB0aHJvdyBuZXcgVW5hdmFpbGFiaWxpdHlFcnJvcignV2ViQnJvd3NlcicsICd3YXJtVXBBc3luYycpO1xuICB9XG4gIGlmIChQbGF0Zm9ybS5PUyAhPT0gJ2FuZHJvaWQnKSB7XG4gICAgcmV0dXJuIHt9O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCBFeHBvbmVudFdlYkJyb3dzZXIud2FybVVwQXN5bmMoYnJvd3NlclBhY2thZ2UpO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYXlJbml0V2l0aFVybEFzeW5jKFxuICB1cmw6IHN0cmluZyxcbiAgYnJvd3NlclBhY2thZ2U/OiBzdHJpbmdcbik6IFByb21pc2U8TWF5SW5pdFdpdGhVcmxSZXN1bHQ+IHtcbiAgaWYgKCFFeHBvbmVudFdlYkJyb3dzZXIubWF5SW5pdFdpdGhVcmxBc3luYykge1xuICAgIHRocm93IG5ldyBVbmF2YWlsYWJpbGl0eUVycm9yKCdXZWJCcm93c2VyJywgJ21heUluaXRXaXRoVXJsQXN5bmMnKTtcbiAgfVxuICBpZiAoUGxhdGZvcm0uT1MgIT09ICdhbmRyb2lkJykge1xuICAgIHJldHVybiB7fTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgRXhwb25lbnRXZWJCcm93c2VyLm1heUluaXRXaXRoVXJsQXN5bmModXJsLCBicm93c2VyUGFja2FnZSk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNvb2xEb3duQXN5bmMoYnJvd3NlclBhY2thZ2U/OiBzdHJpbmcpOiBQcm9taXNlPENvb2xEb3duUmVzdWx0PiB7XG4gIGlmICghRXhwb25lbnRXZWJCcm93c2VyLmNvb2xEb3duQXN5bmMpIHtcbiAgICB0aHJvdyBuZXcgVW5hdmFpbGFiaWxpdHlFcnJvcignV2ViQnJvd3NlcicsICdjb29sRG93bkFzeW5jJyk7XG4gIH1cbiAgaWYgKFBsYXRmb3JtLk9TICE9PSAnYW5kcm9pZCcpIHtcbiAgICByZXR1cm4ge307XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IEV4cG9uZW50V2ViQnJvd3Nlci5jb29sRG93bkFzeW5jKGJyb3dzZXJQYWNrYWdlKTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gb3BlbkJyb3dzZXJBc3luYyhcbiAgdXJsOiBzdHJpbmcsXG4gIGJyb3dzZXJQYXJhbXM6IE9wZW5Ccm93c2VyT3B0aW9ucyA9IHt9XG4pOiBQcm9taXNlPEJyb3dzZXJSZXN1bHQ+IHtcbiAgaWYgKCFFeHBvbmVudFdlYkJyb3dzZXIub3BlbkJyb3dzZXJBc3luYykge1xuICAgIHRocm93IG5ldyBVbmF2YWlsYWJpbGl0eUVycm9yKCdXZWJCcm93c2VyJywgJ29wZW5Ccm93c2VyQXN5bmMnKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgRXhwb25lbnRXZWJCcm93c2VyLm9wZW5Ccm93c2VyQXN5bmModXJsLCBicm93c2VyUGFyYW1zKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpc21pc3NCcm93c2VyKCk6IHZvaWQge1xuICBpZiAoIUV4cG9uZW50V2ViQnJvd3Nlci5kaXNtaXNzQnJvd3Nlcikge1xuICAgIHRocm93IG5ldyBVbmF2YWlsYWJpbGl0eUVycm9yKCdXZWJCcm93c2VyJywgJ2Rpc21pc3NCcm93c2VyJyk7XG4gIH1cbiAgRXhwb25lbnRXZWJCcm93c2VyLmRpc21pc3NCcm93c2VyKCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBvcGVuQXV0aFNlc3Npb25Bc3luYyhcbiAgdXJsOiBzdHJpbmcsXG4gIHJlZGlyZWN0VXJsOiBzdHJpbmdcbik6IFByb21pc2U8QXV0aFNlc3Npb25SZXN1bHQ+IHtcbiAgaWYgKF9hdXRoU2Vzc2lvbklzTmF0aXZlbHlTdXBwb3J0ZWQoKSkge1xuICAgIGlmICghRXhwb25lbnRXZWJCcm93c2VyLm9wZW5BdXRoU2Vzc2lvbkFzeW5jKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdmFpbGFiaWxpdHlFcnJvcignV2ViQnJvd3NlcicsICdvcGVuQXV0aFNlc3Npb25Bc3luYycpO1xuICAgIH1cbiAgICByZXR1cm4gRXhwb25lbnRXZWJCcm93c2VyLm9wZW5BdXRoU2Vzc2lvbkFzeW5jKHVybCwgcmVkaXJlY3RVcmwpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBfb3BlbkF1dGhTZXNzaW9uUG9seWZpbGxBc3luYyh1cmwsIHJlZGlyZWN0VXJsKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGlzbWlzc0F1dGhTZXNzaW9uKCk6IHZvaWQge1xuICBpZiAoX2F1dGhTZXNzaW9uSXNOYXRpdmVseVN1cHBvcnRlZCgpKSB7XG4gICAgaWYgKCFFeHBvbmVudFdlYkJyb3dzZXIuZGlzbWlzc0F1dGhTZXNzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdmFpbGFiaWxpdHlFcnJvcignV2ViQnJvd3NlcicsICdkaXNtaXNzQXV0aFNlc3Npb24nKTtcbiAgICB9XG4gICAgRXhwb25lbnRXZWJCcm93c2VyLmRpc21pc3NBdXRoU2Vzc2lvbigpO1xuICB9IGVsc2Uge1xuICAgIGlmICghRXhwb25lbnRXZWJCcm93c2VyLmRpc21pc3NCcm93c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgVW5hdmFpbGFiaWxpdHlFcnJvcignV2ViQnJvd3NlcicsICdkaXNtaXNzQXV0aFNlc3Npb24nKTtcbiAgICB9XG4gICAgRXhwb25lbnRXZWJCcm93c2VyLmRpc21pc3NCcm93c2VyKCk7XG4gIH1cbn1cblxuLyogaU9TIDw9IDEwIGFuZCBBbmRyb2lkIHBvbHlmaWxsIGZvciBTRkF1dGhlbnRpY2F0aW9uU2Vzc2lvbiBmbG93ICovXG5cbmZ1bmN0aW9uIF9hdXRoU2Vzc2lvbklzTmF0aXZlbHlTdXBwb3J0ZWQoKTogYm9vbGVhbiB7XG4gIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgdmVyc2lvbk51bWJlciA9IHBhcnNlSW50KFN0cmluZyhQbGF0Zm9ybS5WZXJzaW9uKSwgMTApO1xuICByZXR1cm4gdmVyc2lvbk51bWJlciA+PSAxMTtcbn1cblxubGV0IF9yZWRpcmVjdEhhbmRsZXI6ICgoZXZlbnQ6IFJlZGlyZWN0RXZlbnQpID0+IHZvaWQpIHwgbnVsbCA9IG51bGw7XG5cbi8qXG4gKiBvcGVuQnJvd3NlckFzeW5jIG9uIEFuZHJvaWQgZG9lc24ndCB3YWl0IHVudGlsIGNsb3NlZCwgc28gd2UgbmVlZCB0byBwb2x5ZmlsbFxuICogaXQgd2l0aCBBcHBTdGF0ZVxuICovXG5cbi8vIFN0b3JlIHRoZSBgcmVzb2x2ZWAgZnVuY3Rpb24gZnJvbSBhIFByb21pc2UgdG8gZmlyZSB3aGVuIHRoZSBBcHBTdGF0ZVxuLy8gcmV0dXJucyB0byBhY3RpdmVcbmxldCBfb25XZWJCcm93c2VyQ2xvc2VBbmRyb2lkOiBudWxsIHwgKCgpID0+IHZvaWQpID0gbnVsbDtcblxuZnVuY3Rpb24gX29uQXBwU3RhdGVDaGFuZ2VBbmRyb2lkKHN0YXRlOiBBcHBTdGF0ZVN0YXR1cykge1xuICBpZiAoc3RhdGUgPT09ICdhY3RpdmUnICYmIF9vbldlYkJyb3dzZXJDbG9zZUFuZHJvaWQpIHtcbiAgICBfb25XZWJCcm93c2VyQ2xvc2VBbmRyb2lkKCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gX29wZW5Ccm93c2VyQW5kV2FpdEFuZHJvaWRBc3luYyhzdGFydFVybDogc3RyaW5nKTogUHJvbWlzZTxCcm93c2VyUmVzdWx0PiB7XG4gIGxldCBhcHBTdGF0ZUNoYW5nZWRUb0FjdGl2ZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgIF9vbldlYkJyb3dzZXJDbG9zZUFuZHJvaWQgPSByZXNvbHZlO1xuICAgIEFwcFN0YXRlLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIF9vbkFwcFN0YXRlQ2hhbmdlQW5kcm9pZCk7XG4gIH0pO1xuXG4gIGxldCByZXN1bHQ6IEJyb3dzZXJSZXN1bHQgPSB7IHR5cGU6ICdjYW5jZWwnIH07XG4gIGxldCB7IHR5cGUgfSA9IGF3YWl0IG9wZW5Ccm93c2VyQXN5bmMoc3RhcnRVcmwpO1xuXG4gIGlmICh0eXBlID09PSAnb3BlbmVkJykge1xuICAgIGF3YWl0IGFwcFN0YXRlQ2hhbmdlZFRvQWN0aXZlO1xuICAgIHJlc3VsdCA9IHsgdHlwZTogJ2Rpc21pc3MnIH07XG4gIH1cblxuICBBcHBTdGF0ZS5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBfb25BcHBTdGF0ZUNoYW5nZUFuZHJvaWQpO1xuICBfb25XZWJCcm93c2VyQ2xvc2VBbmRyb2lkID0gbnVsbDtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gX29wZW5BdXRoU2Vzc2lvblBvbHlmaWxsQXN5bmMoXG4gIHN0YXJ0VXJsOiBzdHJpbmcsXG4gIHJldHVyblVybDogc3RyaW5nXG4pOiBQcm9taXNlPEF1dGhTZXNzaW9uUmVzdWx0PiB7XG4gIGlmIChfcmVkaXJlY3RIYW5kbGVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgYFRoZSBXZWJCcm93c2VyJ3MgYXV0aCBzZXNzaW9uIGlzIGluIGFuIGludmFsaWQgc3RhdGUgd2l0aCBhIHJlZGlyZWN0IGhhbmRsZXIgc2V0IHdoZW4gaXQgc2hvdWxkIG5vdCBiZWBcbiAgICApO1xuICB9XG5cbiAgaWYgKF9vbldlYkJyb3dzZXJDbG9zZUFuZHJvaWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFdlYkJyb3dzZXIgaXMgYWxyZWFkeSBvcGVuLCBvbmx5IG9uZSBjYW4gYmUgb3BlbiBhdCBhIHRpbWVgKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKFBsYXRmb3JtLk9TID09PSAnYW5kcm9pZCcpIHtcbiAgICAgIHJldHVybiBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgICAgICBfb3BlbkJyb3dzZXJBbmRXYWl0QW5kcm9pZEFzeW5jKHN0YXJ0VXJsKSxcbiAgICAgICAgX3dhaXRGb3JSZWRpcmVjdEFzeW5jKHJldHVyblVybCksXG4gICAgICBdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UucmFjZShbb3BlbkJyb3dzZXJBc3luYyhzdGFydFVybCksIF93YWl0Rm9yUmVkaXJlY3RBc3luYyhyZXR1cm5VcmwpXSk7XG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIC8vIFdlIGNhbid0IGRpc21pc3MgdGhlIGJyb3dzZXIgb24gQW5kcm9pZCwgb25seSBjYWxsIHRoaXMgd2hlbiBpdCdzIGF2YWlsYWJsZS5cbiAgICAvLyBVc2VycyBvbiBBbmRyb2lkIG5lZWQgdG8gbWFudWFsbHkgcHJlc3MgdGhlICd4JyBidXR0b24gaW4gQ2hyb21lIEN1c3RvbSBUYWJzLCBzYWRseS5cbiAgICBpZiAoRXhwb25lbnRXZWJCcm93c2VyLmRpc21pc3NCcm93c2VyKSB7XG4gICAgICBFeHBvbmVudFdlYkJyb3dzZXIuZGlzbWlzc0Jyb3dzZXIoKTtcbiAgICB9XG5cbiAgICBfc3RvcFdhaXRpbmdGb3JSZWRpcmVjdCgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIF9zdG9wV2FpdGluZ0ZvclJlZGlyZWN0KCkge1xuICBpZiAoIV9yZWRpcmVjdEhhbmRsZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICBgVGhlIFdlYkJyb3dzZXIgYXV0aCBzZXNzaW9uIGlzIGluIGFuIGludmFsaWQgc3RhdGUgd2l0aCBubyByZWRpcmVjdCBoYW5kbGVyIHdoZW4gb25lIHNob3VsZCBiZSBzZXRgXG4gICAgKTtcbiAgfVxuXG4gIExpbmtpbmcucmVtb3ZlRXZlbnRMaXN0ZW5lcigndXJsJywgX3JlZGlyZWN0SGFuZGxlcik7XG4gIF9yZWRpcmVjdEhhbmRsZXIgPSBudWxsO1xufVxuXG5mdW5jdGlvbiBfd2FpdEZvclJlZGlyZWN0QXN5bmMocmV0dXJuVXJsOiBzdHJpbmcpOiBQcm9taXNlPFJlZGlyZWN0UmVzdWx0PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICBfcmVkaXJlY3RIYW5kbGVyID0gKGV2ZW50OiBSZWRpcmVjdEV2ZW50KSA9PiB7XG4gICAgICBpZiAoZXZlbnQudXJsLnN0YXJ0c1dpdGgocmV0dXJuVXJsKSkge1xuICAgICAgICByZXNvbHZlKHsgdXJsOiBldmVudC51cmwsIHR5cGU6ICdzdWNjZXNzJyB9KTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgTGlua2luZy5hZGRFdmVudExpc3RlbmVyKCd1cmwnLCBfcmVkaXJlY3RIYW5kbGVyKTtcbiAgfSk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9
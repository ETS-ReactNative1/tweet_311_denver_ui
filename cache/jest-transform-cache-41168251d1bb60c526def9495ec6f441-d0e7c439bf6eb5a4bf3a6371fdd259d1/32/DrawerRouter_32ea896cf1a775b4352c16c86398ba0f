2af09f1b76ec3cf676d0632da4a3298b
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/toConsumableArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = DrawerRouter;
exports.DrawerActions = void 0;

var _shortid = _interopRequireDefault(require("shortid"));

var _TabRouter = _interopRequireWildcard(require("./TabRouter"));

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

var DrawerActions = _objectSpread({}, _TabRouter.TabActions, {
  openDrawer: function openDrawer() {
    return {
      type: 'OPEN_DRAWER'
    };
  },
  closeDrawer: function closeDrawer() {
    return {
      type: 'CLOSE_DRAWER'
    };
  },
  toggleDrawer: function toggleDrawer() {
    return {
      type: 'TOGGLE_DRAWER'
    };
  }
});

exports.DrawerActions = DrawerActions;

var isDrawerOpen = function isDrawerOpen(state) {
  var _state$history;

  return Boolean((_state$history = state.history) === null || _state$history === void 0 ? void 0 : _state$history.find(function (it) {
    return it.type === 'drawer';
  }));
};

var openDrawer = function openDrawer(state) {
  if (isDrawerOpen(state)) {
    return state;
  }

  return _objectSpread({}, state, {
    history: [].concat((0, _toConsumableArray2.default)(state.history), [{
      type: 'drawer'
    }])
  });
};

var closeDrawer = function closeDrawer(state) {
  if (!isDrawerOpen(state)) {
    return state;
  }

  return _objectSpread({}, state, {
    history: state.history.filter(function (it) {
      return it.type !== 'drawer';
    })
  });
};

function DrawerRouter(options) {
  var router = (0, _TabRouter.default)(options);
  return _objectSpread({}, router, {
    type: 'drawer',
    getInitialState: function getInitialState(_ref) {
      var routeNames = _ref.routeNames,
          routeParamList = _ref.routeParamList;
      var state = router.getInitialState({
        routeNames: routeNames,
        routeParamList: routeParamList
      });
      return _objectSpread({}, state, {
        stale: false,
        type: 'drawer',
        key: "drawer-".concat((0, _shortid.default)())
      });
    },
    getRehydratedState: function getRehydratedState(partialState, _ref2) {
      var routeNames = _ref2.routeNames,
          routeParamList = _ref2.routeParamList;

      if (partialState.stale === false) {
        return partialState;
      }

      var state = router.getRehydratedState(partialState, {
        routeNames: routeNames,
        routeParamList: routeParamList
      });

      if (isDrawerOpen(partialState)) {
        state = openDrawer(state);
      }

      return _objectSpread({}, state, {
        type: 'drawer',
        key: "drawer-".concat((0, _shortid.default)())
      });
    },
    getStateForRouteFocus: function getStateForRouteFocus(state, key) {
      var result = router.getStateForRouteFocus(state, key);
      return closeDrawer(result);
    },
    getStateForAction: function getStateForAction(state, action, options) {
      switch (action.type) {
        case 'OPEN_DRAWER':
          return openDrawer(state);

        case 'CLOSE_DRAWER':
          return closeDrawer(state);

        case 'TOGGLE_DRAWER':
          if (isDrawerOpen(state)) {
            return closeDrawer(state);
          }

          return openDrawer(state);

        case 'GO_BACK':
          if (isDrawerOpen(state)) {
            return closeDrawer(state);
          }

          return router.getStateForAction(state, action, options);

        default:
          return router.getStateForAction(state, action, options);
      }
    },
    actionCreators: DrawerActions
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRyYXdlclJvdXRlci50c3giXSwibmFtZXMiOlsiRHJhd2VyQWN0aW9ucyIsIlRhYkFjdGlvbnMiLCJvcGVuRHJhd2VyIiwidHlwZSIsImNsb3NlRHJhd2VyIiwidG9nZ2xlRHJhd2VyIiwiaXNEcmF3ZXJPcGVuIiwic3RhdGUiLCJCb29sZWFuIiwiaXQiLCJoaXN0b3J5Iiwicm91dGVyIiwiZ2V0SW5pdGlhbFN0YXRlIiwicm91dGVQYXJhbUxpc3QiLCJyb3V0ZU5hbWVzIiwic3RhbGUiLCJrZXkiLCJnZXRSZWh5ZHJhdGVkU3RhdGUiLCJwYXJ0aWFsU3RhdGUiLCJnZXRTdGF0ZUZvclJvdXRlRm9jdXMiLCJyZXN1bHQiLCJnZXRTdGF0ZUZvckFjdGlvbiIsImFjdGlvbiIsImFjdGlvbkNyZWF0b3JzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxJQUFBLFFBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsQ0FBQSxTQUFBLENBQUEsQ0FBQTs7QUFFQSxJQUFBLFVBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUEsZUFBQSxDQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBK0JPLElBQU1BLGFBQWEsR0FBQSxhQUFBLENBQUEsRUFBQSxFQUNyQkMsVUFBQUEsQ0FEcUIsVUFBQSxFQUFBO0FBRXhCQyxFQUFBQSxVQUZ3Qix3QkFFTztBQUM3QixXQUFPO0FBQUVDLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQVA7QUFIc0IsR0FBQTtBQUt4QkMsRUFBQUEsV0FMd0IseUJBS1E7QUFDOUIsV0FBTztBQUFFRCxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUFQO0FBTnNCLEdBQUE7QUFReEJFLEVBQUFBLFlBUndCLDBCQVFTO0FBQy9CLFdBQU87QUFBRUYsTUFBQUEsSUFBSSxFQUFFO0FBQVIsS0FBUDtBQUNEO0FB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QUFQOztBQUVGO0FBQ0UsaUJBQU9BLE1BQU0sQ0FBTkEsaUJBQUFBLENBQUFBLEtBQUFBLEVBQUFBLE1BQUFBLEVBQVAsT0FBT0EsQ0FBUDtBQXRCSjtBQTVDSixLQUFBO0FBc0VFWSxJQUFBQSxjQUFjLEVBQUV2QjtBQXRFbEIsR0FBQSxDQUFBO0FBd0VEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHNob3J0aWQgZnJvbSAnc2hvcnRpZCc7XG5pbXBvcnQgeyBQYXJ0aWFsU3RhdGUsIENvbW1vbk5hdmlnYXRpb25BY3Rpb24sIFJvdXRlciB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IFRhYlJvdXRlciwge1xuICBUYWJBY3Rpb25zLFxuICBUYWJBY3Rpb25UeXBlLFxuICBUYWJSb3V0ZXJPcHRpb25zLFxuICBUYWJOYXZpZ2F0aW9uU3RhdGUsXG59IGZyb20gJy4vVGFiUm91dGVyJztcblxuZXhwb3J0IHR5cGUgRHJhd2VyQWN0aW9uVHlwZSA9XG4gIHwgVGFiQWN0aW9uVHlwZVxuICB8IHtcbiAgICAgIHR5cGU6ICdPUEVOX0RSQVdFUicgfCAnQ0xPU0VfRFJBV0VSJyB8ICdUT0dHTEVfRFJBV0VSJztcbiAgICAgIHNvdXJjZT86IHN0cmluZztcbiAgICAgIHRhcmdldD86IHN0cmluZztcbiAgICB9O1xuXG5leHBvcnQgdHlwZSBEcmF3ZXJSb3V0ZXJPcHRpb25zID0gVGFiUm91dGVyT3B0aW9ucztcblxuZXhwb3J0IHR5cGUgRHJhd2VyTmF2aWdhdGlvblN0YXRlID0gT21pdDxcbiAgVGFiTmF2aWdhdGlvblN0YXRlLFxuICAndHlwZScgfCAnaGlzdG9yeSdcbj4gJiB7XG4gIC8qKlxuICAgKiBUeXBlIG9mIHRoZSByb3V0ZXIsIGluIHRoaXMgY2FzZSwgaXQncyBkcmF3ZXIuXG4gICAqL1xuICB0eXBlOiAnZHJhd2VyJztcbiAgLyoqXG4gICAqIExpc3Qgb2YgcHJldmlvdXNseSB2aXNpdGVkIHJvdXRlIGtleXMgYW5kIGRyYXdlciBvcGVuIHN0YXR1cy5cbiAgICovXG4gIGhpc3Rvcnk6ICh7IHR5cGU6ICdyb3V0ZSc7IGtleTogc3RyaW5nIH0gfCB7IHR5cGU6ICdkcmF3ZXInIH0pW107XG59O1xuXG5leHBvcnQgY29uc3QgRHJhd2VyQWN0aW9ucyA9IHtcbiAgLi4uVGFiQWN0aW9ucyxcbiAgb3BlbkRyYXdlcigpOiBEcmF3ZXJBY3Rpb25UeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiAnT1BFTl9EUkFXRVInIH07XG4gIH0sXG4gIGNsb3NlRHJhd2VyKCk6IERyYXdlckFjdGlvblR5cGUge1xuICAgIHJldHVybiB7IHR5cGU6ICdDTE9TRV9EUkFXRVInIH07XG4gIH0sXG4gIHRvZ2dsZURyYXdlcigpOiBEcmF3ZXJBY3Rpb25UeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiAnVE9HR0xFX0RSQVdFUicgfTtcbiAgfSxcbn07XG5cbmNvbnN0IGlzRHJhd2VyT3BlbiA9IChcbiAgc3RhdGU6IERyYXdlck5hdmlnYXRpb25TdGF0ZSB8IFBhcnRpYWxTdGF0ZTxEcmF3ZXJOYXZpZ2F0aW9uU3RhdGU+XG4pID0+IEJvb2xlYW4oc3RhdGUuaGlzdG9yeT8uZmluZChpdCA9PiBpdC50eXBlID09PSAnZHJhd2VyJykpO1xuXG5jb25zdCBvcGVuRHJhd2VyID0gKHN0YXRlOiBEcmF3ZXJOYXZpZ2F0aW9uU3RhdGUpOiBEcmF3ZXJOYXZpZ2F0aW9uU3RhdGUgPT4ge1xuICBpZiAoaXNEcmF3ZXJPcGVuKHN0YXRlKSkge1xuICAgIHJldHVybiBzdGF0ZTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLi4uc3RhdGUsXG4gICAgaGlzdG9yeTogWy4uLnN0YXRlLmhpc3RvcnksIHsgdHlwZTogJ2RyYXdlcicgfV0sXG4gIH07XG59O1xuXG5jb25zdCBjbG9zZURyYXdlciA9IChzdGF0ZTogRHJhd2VyTmF2aWdhdGlvblN0YXRlKTogRHJhd2VyTmF2aWdhdGlvblN0YXRlID0+IHtcbiAgaWYgKCFpc0RyYXdlck9wZW4oc3RhdGUpKSB7XG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5zdGF0ZSxcbiAgICBoaXN0b3J5OiBzdGF0ZS5oaXN0b3J5LmZpbHRlcihpdCA9PiBpdC50eXBlICE9PSAnZHJhd2VyJyksXG4gIH07XG59O1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBEcmF3ZXJSb3V0ZXIoXG4gIG9wdGlvbnM6IERyYXdlclJvdXRlck9wdGlvbnNcbik6IFJvdXRlcjxEcmF3ZXJOYXZpZ2F0aW9uU3RhdGUsIERyYXdlckFjdGlvblR5cGUgfCBDb21tb25OYXZpZ2F0aW9uQWN0aW9uPiB7XG4gIGNvbnN0IHJvdXRlciA9IChUYWJSb3V0ZXIob3B0aW9ucykgYXMgdW5rbm93bikgYXMgUm91dGVyPFxuICAgIERyYXdlck5hdmlnYXRpb25TdGF0ZSxcbiAgICBUYWJBY3Rpb25UeXBlIHwgQ29tbW9uTmF2aWdhdGlvbkFjdGlvblxuICA+O1xuXG4gIHJldHVybiB7XG4gICAgLi4ucm91dGVyLFxuXG4gICAgdHlwZTogJ2RyYXdlcicsXG5cbiAgICBnZXRJbml0aWFsU3RhdGUoeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBjb25zdCBzdGF0ZSA9IHJvdXRlci5nZXRJbml0aWFsU3RhdGUoeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHN0YWxlOiBmYWxzZSxcbiAgICAgICAgdHlwZTogJ2RyYXdlcicsXG4gICAgICAgIGtleTogYGRyYXdlci0ke3Nob3J0aWQoKX1gLFxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgZ2V0UmVoeWRyYXRlZFN0YXRlKHBhcnRpYWxTdGF0ZSwgeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCB9KSB7XG4gICAgICBpZiAocGFydGlhbFN0YXRlLnN0YWxlID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gcGFydGlhbFN0YXRlO1xuICAgICAgfVxuXG4gICAgICBsZXQgc3RhdGUgPSByb3V0ZXIuZ2V0UmVoeWRyYXRlZFN0YXRlKHBhcnRpYWxTdGF0ZSwge1xuICAgICAgICByb3V0ZU5hbWVzLFxuICAgICAgICByb3V0ZVBhcmFtTGlzdCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoaXNEcmF3ZXJPcGVuKHBhcnRpYWxTdGF0ZSkpIHtcbiAgICAgICAgc3RhdGUgPSBvcGVuRHJhd2VyKHN0YXRlKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHR5cGU6ICdkcmF3ZXInLFxuICAgICAgICBrZXk6IGBkcmF3ZXItJHtzaG9ydGlkKCl9YCxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGdldFN0YXRlRm9yUm91dGVGb2N1cyhzdGF0ZSwga2V5KSB7XG4gICAgICBjb25zdCByZXN1bHQgPSByb3V0ZXIuZ2V0U3RhdGVGb3JSb3V0ZUZvY3VzKHN0YXRlLCBrZXkpO1xuXG4gICAgICByZXR1cm4gY2xvc2VEcmF3ZXIocmVzdWx0KTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JBY3Rpb24oc3RhdGUsIGFjdGlvbiwgb3B0aW9ucykge1xuICAgICAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgICAgICBjYXNlICdPUEVOX0RSQVdFUic6XG4gICAgICAgICAgcmV0dXJuIG9wZW5EcmF3ZXIoc3RhdGUpO1xuXG4gICAgICAgIGNhc2UgJ0NMT1NFX0RSQVdFUic6XG4gICAgICAgICAgcmV0dXJuIGNsb3NlRHJhd2VyKHN0YXRlKTtcblxuICAgICAgICBjYXNlICdUT0dHTEVfRFJBV0VSJzpcbiAgICAgICAgICBpZiAoaXNEcmF3ZXJPcGVuKHN0YXRlKSkge1xuICAgICAgICAgICAgcmV0dXJuIGNsb3NlRHJhd2VyKHN0YXRlKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gb3BlbkRyYXdlcihzdGF0ZSk7XG5cbiAgICAgICAgY2FzZSAnR09fQkFDSyc6XG4gICAgICAgICAgaWYgKGlzRHJhd2VyT3BlbihzdGF0ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBjbG9zZURyYXdlcihzdGF0ZSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHJvdXRlci5nZXRTdGF0ZUZvckFjdGlvbihzdGF0ZSwgYWN0aW9uLCBvcHRpb25zKTtcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJldHVybiByb3V0ZXIuZ2V0U3RhdGVGb3JBY3Rpb24oc3RhdGUsIGFjdGlvbiwgb3B0aW9ucyk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIGFjdGlvbkNyZWF0b3JzOiBEcmF3ZXJBY3Rpb25zLFxuICB9O1xufVxuIl19